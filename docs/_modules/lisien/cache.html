<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lisien.cache &#8212; Lisien 0.23.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=10ab35ec"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lisien.cache</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Lisien, a framework for life simulation games.</span>
<span class="c1"># Copyright (c) Zachary Spector, public@zacharyspector.com</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;Versioned in-memory data stores that Lisien data is kept in, once it&#39;s loaded.</span>

<span class="sd">This module is where we keep the code for storage and retrieval of both</span>
<span class="sd">individual values and keyframes. It makes heavy use of the :mod:`window`</span>
<span class="sd">module for the underlying data structures.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">pairwise</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">getsizeof</span><span class="p">,</span> <span class="n">stderr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">TYPE_CHECKING</span><span class="p">,</span>
	<span class="n">Callable</span><span class="p">,</span>
	<span class="n">ClassVar</span><span class="p">,</span>
	<span class="n">Iterable</span><span class="p">,</span>
	<span class="n">Literal</span><span class="p">,</span>
	<span class="n">Protocol</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">attrs</span><span class="w"> </span><span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">field</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChangeTrackingDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Direction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exc</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">HistoricKeyError</span><span class="p">,</span>
	<span class="n">KeyframeError</span><span class="p">,</span>
	<span class="n">NotInKeyframeError</span><span class="p">,</span>
	<span class="n">TotalKeyError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">ActionFuncName</span><span class="p">,</span>
	<span class="n">Branch</span><span class="p">,</span>
	<span class="n">CharName</span><span class="p">,</span>
	<span class="n">Key</span><span class="p">,</span>
	<span class="n">LinearTime</span><span class="p">,</span>
	<span class="n">NodeName</span><span class="p">,</span>
	<span class="n">PickyDefaultDict</span><span class="p">,</span>
	<span class="n">PrereqFuncName</span><span class="p">,</span>
	<span class="n">RuleBig</span><span class="p">,</span>
	<span class="n">RulebookName</span><span class="p">,</span>
	<span class="n">RulebookPriority</span><span class="p">,</span>
	<span class="n">RuleName</span><span class="p">,</span>
	<span class="n">RuleNeighborhood</span><span class="p">,</span>
	<span class="n">Stat</span><span class="p">,</span>
	<span class="n">StructuredDefaultDict</span><span class="p">,</span>
	<span class="n">Tick</span><span class="p">,</span>
	<span class="n">Time</span><span class="p">,</span>
	<span class="n">TriggerFuncName</span><span class="p">,</span>
	<span class="n">Turn</span><span class="p">,</span>
	<span class="n">UniversalKey</span><span class="p">,</span>
	<span class="n">Value</span><span class="p">,</span>
	<span class="n">sort_set</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.window</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssignmentTimeDict</span><span class="p">,</span> <span class="n">EntikeySettingsTurnDict</span><span class="p">,</span> <span class="n">WindowDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.wrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderlyFrozenSet</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AbstractTurnEndDict</span><span class="p">(</span><span class="n">ChangeTrackingDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span> <span class="n">Tick</span><span class="p">]):</span>
	<span class="n">engine</span><span class="p">:</span> <span class="s2">&quot;engine.Engine&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__attrs_pre_init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">engine</span><span class="p">:</span> <span class="s2">&quot;engine.Engine&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="o">/</span><span class="p">,</span>
		<span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__attrs_pre_init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">other_d</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractTurnEndDict</span><span class="p">:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tick</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">Tick</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TurnEndPlanDict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
				<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TurnEndDict</span><span class="p">(</span><span class="n">AbstractTurnEndDict</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Tick on which a (branch, turn) ends, not including any plans&quot;&quot;&quot;</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">other_d</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TurnEndPlanDict</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_turn_end_plan</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TurnEndPlanDict</span><span class="p">(</span><span class="n">AbstractTurnEndDict</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Tick on which a (branch, turn) ends, including plans&quot;&quot;&quot;</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">other_d</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TurnEndDict</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_turn_end</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span> <span class="n">value</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">:</span>
			<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">other_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nb">type</span> <span class="n">KeyCache</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span>
	<span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">],</span>
	<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">_KEY</span><span class="p">]],</span>
<span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AddDelGetter</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">](</span><span class="n">Protocol</span><span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">parentity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">Turn</span><span class="p">,</span>
		<span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">cache</span><span class="p">:</span> <span class="n">KeyCache</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">stoptime</span><span class="p">:</span> <span class="n">Time</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="n">_KEY</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="n">_KEY</span><span class="p">]]:</span> <span class="o">...</span>


<span class="nb">type</span> <span class="n">CacheKeys</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span>
	<span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
	<span class="nb">dict</span><span class="p">[</span><span class="n">_KEY</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">_VALUE</span><span class="p">]]],</span>
<span class="p">]</span>


<div class="viewcode-block" id="Cache">
<a class="viewcode-back" href="../../lisien/index.html#lisien.cache.Cache">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Cache</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">_KEYFRAME</span><span class="p">:</span> <span class="nb">dict</span><span class="p">](</span>
	<span class="n">ABC</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A data store that&#39;s useful for tracking graph revisions.&quot;&quot;&quot;</span>

	<span class="n">engine</span><span class="p">:</span> <span class="s2">&quot;engine.Engine&quot;</span>
	<span class="n">_keyframe_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_dont_set_db</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="o">...</span>

	<span class="n">setdb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
		<span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">],</span> <span class="kc">None</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_dont_set_db</span><span class="p">)</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_dont_del_db</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="o">...</span>

	<span class="n">deldb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
		<span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_dont_del_db</span><span class="p">)</span>
	<span class="p">)</span>
	<span class="n">overwrite_journal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">],</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">],</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_VALUE</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">],</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_KEYFRAME</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">_KEYFRAME</span><span class="p">]</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Entity data keyed by the entities&#39; parents.</span>

<span class="sd">		An entity&#39;s parent is what it&#39;s contained in. When speaking of a node,</span>
<span class="sd">		this is its graph. When speaking of an edge, the parent is a pair of</span>
<span class="sd">		the graph and origin.</span>

<span class="sd">		Deeper layers of this cache are keyed by branch and revision.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">StructuredDefaultDict</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CacheKeys</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Cache of entity data keyed by the entities themselves.</span>

<span class="sd">		That means the whole tuple identifying the entity is the</span>
<span class="sd">		top-level key in this cache here. The second-to-top level</span>
<span class="sd">		is the key within the entity.</span>

<span class="sd">		Deeper layers of this cache are keyed by branch, turn, and tick.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">StructuredDefaultDict</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keycache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KeyCache</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Keys an entity has at a given turn and tick.&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">PickyDefaultDict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">branches</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">],</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">_VALUE</span><span class="p">]]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;A less structured alternative to ``keys``.</span>

<span class="sd">		For when you already know the entity and the key within it,</span>
<span class="sd">		but still need to iterate through history to find the value.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">StructuredDefaultDict</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">_KEYFRAME</span><span class="p">]]</span>
	<span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Key-value dictionaries representing my state at a given time&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">StructuredDefaultDict</span><span class="p">(</span>
			<span class="mi">1</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframe_dict</span> <span class="ow">or</span> <span class="p">{})</span>
		<span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">shallowest</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">],</span> <span class="n">_VALUE</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;A dictionary for plain, unstructured hinting.&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">settings</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">EntikeySettingsTurnDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]]</span>
	<span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;All the ``entity[key] = value`` settings on some turn&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">PickyDefaultDict</span><span class="p">(</span><span class="n">EntikeySettingsTurnDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">presettings</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">EntikeySettingsTurnDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]]</span>
	<span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;The values prior to ``entity[key] = value`` settings on some turn&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">PickyDefaultDict</span><span class="p">(</span><span class="n">EntikeySettingsTurnDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">time_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_kc_lru</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">RLock</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_for_journal</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">args</span><span class="p">,</span>
		<span class="n">store_hint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">retrieve_hint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_retrieve</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">store_hint</span><span class="p">,</span> <span class="n">retrieve_hint</span><span class="p">,</span> <span class="n">search</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_entity</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_kc_lru</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">total_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Returns the approximate memory footprint an object and all of its contents.</span>

<span class="sd">		Automatically finds the contents of the following builtin containers and</span>
<span class="sd">		their subclasses:  tuple, list, deque, dict, set and OrderlyFrozenSet.</span>
<span class="sd">		To search other containers, add handlers to iterate over their contents:</span>

<span class="sd">		    handlers = {SomeContainerClass: iter,</span>
<span class="sd">		                OtherContainerClass: OtherContainerClass.get_elements}</span>

<span class="sd">		From https://code.activestate.com/recipes/577504-compute-memory-footprint-of-an-object-and-its-cont/download/1/</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">all_handlers</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nb">tuple</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="nb">list</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">deque</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">WindowDict</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">_past</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">_future</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">_keys</span><span class="p">],</span>
			<span class="nb">dict</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
			<span class="nb">set</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">OrderlyFrozenSet</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">Cache</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="p">[</span>
				<span class="n">o</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
				<span class="n">o</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
				<span class="n">o</span><span class="o">.</span><span class="n">presettings</span><span class="p">,</span>
				<span class="n">o</span><span class="o">.</span><span class="n">keycache</span><span class="p">,</span>
			<span class="p">],</span>
		<span class="p">}</span>
		<span class="n">all_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
		<span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># track which object id&#39;s have already been seen</span>
		<span class="n">default_size</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span>
			<span class="mi">0</span>
		<span class="p">)</span>  <span class="c1"># estimate sizeof object without __sizeof__</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">sizeof</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>  <span class="c1"># do not double count the same object</span>
				<span class="k">return</span> <span class="mi">0</span>
			<span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">default_size</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

			<span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">all_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
					<span class="n">s</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">sizeof</span><span class="p">,</span> <span class="n">handler</span><span class="p">(</span><span class="n">o</span><span class="p">)))</span>
					<span class="k">break</span>
			<span class="k">return</span> <span class="n">s</span>

		<span class="k">return</span> <span class="n">sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph_ent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_KEYFRAME</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">graph_ent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">KeyframeError</span><span class="p">(</span><span class="s2">&quot;Unknown graph-entity&quot;</span><span class="p">,</span> <span class="n">graph_ent</span><span class="p">)</span>
		<span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">graph_ent</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">KeyframeError</span><span class="p">(</span><span class="s2">&quot;Unknown branch&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">KeyframeError</span><span class="p">(</span><span class="s2">&quot;Unknown turn&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">tick</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">KeyframeError</span><span class="p">(</span><span class="s2">&quot;Unknown tick&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">discard_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">):</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
				<span class="ow">and</span> <span class="n">turn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">entity</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span>
				<span class="ow">and</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">entity</span><span class="p">][</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span>
			<span class="p">):</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">entity</span><span class="p">][</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph_ent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="n">_KEYFRAME</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">graph_ent</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Keyframes can only be set to tuples identifying graph entities&quot;</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Branches must be strings&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Turns must be integers&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Turns can&#39;t be negative&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Ticks must be integers&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tick</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ticks can&#39;t be negative&quot;</span><span class="p">)</span>
		<span class="n">kfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">graph_ent</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">kfg</span><span class="p">:</span>
			<span class="n">kfgb</span> <span class="o">=</span> <span class="n">kfg</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">kfgb</span><span class="p">:</span>
				<span class="n">kfgb</span><span class="p">[</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">kfgb</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">keyframe</span><span class="p">}</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">AssignmentTimeDict</span><span class="p">()</span>
			<span class="n">d</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">keyframe</span><span class="p">}</span>
			<span class="n">kfg</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">alias_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch_from</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">branch_to</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">default</span><span class="p">:</span> <span class="n">_KEYFRAME</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">for</span> <span class="n">graph_ent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">(</span><span class="n">graph_ent</span><span class="p">,</span> <span class="n">branch_from</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">KeyframeError</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">kf</span> <span class="o">=</span> <span class="n">default</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">continue</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">(</span><span class="n">graph_ent</span><span class="p">,</span> <span class="n">branch_to</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">kf</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">data</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span>
			<span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]</span>
		<span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Add a bunch of data. Must be in chronological order.</span>

<span class="sd">		But it doesn&#39;t need to all be from the same branch, as long as</span>
<span class="sd">		each branch is chronological of itself.</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">sort_key</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

		<span class="n">branches</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
			<span class="n">branches</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
		<span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
		<span class="c1"># Make keycaches and valcaches. Must be done chronologically</span>
		<span class="c1"># to make forwarding work.</span>
		<span class="n">childbranch</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_childbranch</span>
		<span class="n">branch2do</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">Branch</span><span class="p">(</span><span class="s2">&quot;trunk&quot;</span><span class="p">)])</span>

		<span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwriting</span><span class="p">():</span>
			<span class="k">while</span> <span class="n">branch2do</span><span class="p">:</span>
				<span class="n">branch</span> <span class="o">=</span> <span class="n">branch2do</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">):</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">store</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">planning</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="k">except</span> <span class="n">HistoricKeyError</span><span class="p">:</span>
						<span class="k">continue</span>
				<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">childbranch</span><span class="p">:</span>
					<span class="n">branch2do</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">childbranch</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_keycachelike</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">keycache</span><span class="p">:</span> <span class="n">KeyCache</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">],</span>
		<span class="n">keys</span><span class="p">:</span> <span class="n">CacheKeys</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">],</span>
		<span class="n">get_adds_dels</span><span class="p">:</span> <span class="n">AddDelGetter</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">],</span>
		<span class="n">parentity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Try to retrieve a OrderlyFrozenSet representing extant keys.</span>

<span class="sd">		If I can&#39;t, generate one, store it, and return it.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">keycache_key</span> <span class="o">=</span> <span class="n">parentity</span> <span class="o">+</span> <span class="p">(</span><span class="n">branch</span><span class="p">,)</span>
		<span class="n">keycache2</span><span class="p">:</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">_KEY</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">keycache3</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">_KEY</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">keycache_key</span> <span class="ow">in</span> <span class="n">keycache</span><span class="p">:</span>
			<span class="n">keycache2</span> <span class="o">=</span> <span class="n">keycache</span><span class="p">[</span><span class="n">keycache_key</span><span class="p">]</span>
			<span class="k">assert</span> <span class="n">keycache2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">keycache2</span><span class="p">:</span>
				<span class="n">keycache3</span> <span class="o">=</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">keycache3</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">keycache3</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
				<span class="c1"># Take valid values from the past of a keycache and copy them</span>
				<span class="c1"># forward, into the present. Assumes that time is only moving</span>
				<span class="c1"># forward, never backward, never skipping any turns or ticks,</span>
				<span class="c1"># and any changes to the world state are happening through</span>
				<span class="c1"># allegedb proper, meaning they&#39;ll all get cached. In lisien this</span>
				<span class="c1"># means every change to the world state should happen inside of</span>
				<span class="c1"># a call to ``Engine.next_turn`` in a rule.</span>
				<span class="k">if</span> <span class="n">keycache2</span> <span class="ow">and</span> <span class="n">keycache2</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">turn</span><span class="p">):</span>
					<span class="c1"># there&#39;s a keycache from a prior turn in this branch. Get it</span>
					<span class="k">if</span> <span class="n">turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keycache2</span><span class="p">:</span>
						<span class="c1"># since it&#39;s not this *exact* turn, there might be changes</span>
						<span class="n">old_turn</span> <span class="o">=</span> <span class="n">keycache2</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
						<span class="k">assert</span> <span class="n">old_turn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
						<span class="n">old_turn_kc</span> <span class="o">=</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
						<span class="n">added</span><span class="p">,</span> <span class="n">deleted</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
							<span class="n">parentity</span><span class="p">,</span>
							<span class="n">branch</span><span class="p">,</span>
							<span class="n">turn</span><span class="p">,</span>
							<span class="n">tick</span><span class="p">,</span>
							<span class="n">stoptime</span><span class="o">=</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">old_turn</span><span class="p">,</span> <span class="n">old_turn_kc</span><span class="o">.</span><span class="n">end</span><span class="p">),</span>
							<span class="n">cache</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
						<span class="p">)</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
								<span class="n">old_turn_kc</span><span class="o">.</span><span class="n">final</span><span class="p">()</span>
								<span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>
								<span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
							<span class="p">)</span>
						<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">()</span>
						<span class="c1"># assert ret == get_adds_dels(</span>
						<span class="c1"># keys[parentity], branch, turn, tick)[0]  # slow</span>
						<span class="n">new_turn_kc</span> <span class="o">=</span> <span class="n">WindowDict</span><span class="p">()</span>
						<span class="n">new_turn_kc</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
						<span class="n">keycache2</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_turn_kc</span>
						<span class="k">return</span> <span class="n">ret</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">keycache3</span><span class="p">:</span>
						<span class="n">keycache3</span> <span class="o">=</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">tick</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keycache3</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">keycache3</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
							<span class="n">added</span><span class="p">,</span> <span class="n">deleted</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
								<span class="n">parentity</span><span class="p">,</span>
								<span class="n">branch</span><span class="p">,</span>
								<span class="n">turn</span><span class="p">,</span>
								<span class="n">tick</span><span class="p">,</span>
								<span class="n">stoptime</span><span class="o">=</span><span class="p">(</span>
									<span class="n">branch</span><span class="p">,</span>
									<span class="n">turn</span><span class="p">,</span>
									<span class="n">keycache3</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">tick</span><span class="p">),</span>
								<span class="p">),</span>
								<span class="n">cache</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
							<span class="p">)</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
								<span class="n">keycache3</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
								<span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>
								<span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
							<span class="p">)</span>
							<span class="c1"># assert ret == get_adds_dels(</span>
							<span class="c1"># keys[parentity], branch, turn, tick)[0]  # slow</span>
							<span class="n">keycache3</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
							<span class="k">return</span> <span class="n">ret</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">turn_before</span> <span class="o">=</span> <span class="n">keycache2</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">turn_before</span> <span class="o">==</span> <span class="n">turn</span><span class="p">:</span>
								<span class="n">tick_before</span> <span class="o">=</span> <span class="n">tick</span>
								<span class="k">if</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn_before</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
									<span class="n">keys_before</span> <span class="o">=</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn_before</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
								<span class="k">else</span><span class="p">:</span>
									<span class="n">keys_before</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">()</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="n">tick_before</span> <span class="o">=</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn_before</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
								<span class="n">keys_before</span> <span class="o">=</span> <span class="n">keycache2</span><span class="p">[</span><span class="n">turn_before</span><span class="p">][</span>
									<span class="n">tick_before</span>
								<span class="p">]</span>
							<span class="n">added</span><span class="p">,</span> <span class="n">deleted</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
								<span class="n">parentity</span><span class="p">,</span>
								<span class="n">branch</span><span class="p">,</span>
								<span class="n">turn</span><span class="p">,</span>
								<span class="n">tick</span><span class="p">,</span>
								<span class="n">stoptime</span><span class="o">=</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn_before</span><span class="p">,</span> <span class="n">tick_before</span><span class="p">),</span>
								<span class="n">cache</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
							<span class="p">)</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="n">keycache3</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys_before</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
								<span class="n">added</span>
							<span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
							<span class="c1"># assert ret == get_adds_dels(</span>
							<span class="c1"># keys[parentity], branch, turn, tick)[0]  # slow</span>
							<span class="k">return</span> <span class="n">ret</span>
					<span class="c1"># assert kcturn[tick] == get_adds_dels(</span>
					<span class="c1"># keys[parentity], branch, turn, tick)[0]  # slow</span>
					<span class="k">return</span> <span class="n">keycache3</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
			<span class="c1"># still have to get a stoptime -- the time of the last keyframe</span>
			<span class="n">stoptime</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_build_keyframe_window</span><span class="p">(</span>
				<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">stoptime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="k">if</span> <span class="n">parentity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">:</span>
					<span class="n">keyframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="p">[</span><span class="n">parentity</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">:</span>
						<span class="n">kfb</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">kfb</span><span class="p">:</span>
							<span class="n">kfbr</span> <span class="o">=</span> <span class="n">kfb</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">kfbr</span><span class="p">:</span>
								<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span><span class="n">kfbr</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
				<span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">adds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span><span class="n">parentity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span><span class="n">adds</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">stoptime</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">(</span><span class="n">parentity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span><span class="n">kf</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
				<span class="k">except</span> <span class="n">KeyframeError</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">tick</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">stoptime</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_build_keyframe_window</span><span class="p">(</span>
							<span class="n">branch</span><span class="p">,</span>
							<span class="n">Turn</span><span class="p">(</span><span class="n">turn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">turn_end_plan</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">(</span><span class="n">turn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
						<span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">stoptime</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_build_keyframe_window</span><span class="p">(</span>
							<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">(</span><span class="n">tick</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
						<span class="p">)</span>
					<span class="k">if</span> <span class="n">stoptime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">adds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span><span class="n">parentity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
						<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span><span class="n">adds</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">(</span><span class="n">parentity</span><span class="p">,</span> <span class="o">*</span><span class="n">stoptime</span><span class="p">)</span>
							<span class="n">adds</span><span class="p">,</span> <span class="n">dels</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
								<span class="n">parentity</span><span class="p">,</span>
								<span class="n">branch</span><span class="p">,</span>
								<span class="n">turn</span><span class="p">,</span>
								<span class="n">tick</span><span class="p">,</span>
								<span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span><span class="p">,</span>
							<span class="p">)</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">((</span><span class="n">kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">adds</span><span class="p">)</span> <span class="o">-</span> <span class="n">dels</span><span class="p">)</span>
						<span class="k">except</span> <span class="n">KeyframeError</span><span class="p">:</span>
							<span class="c1"># entity absent from keyframe, means it was created after that</span>
							<span class="n">adds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
								<span class="n">parentity</span><span class="p">,</span>
								<span class="n">branch</span><span class="p">,</span>
								<span class="n">turn</span><span class="p">,</span>
								<span class="n">tick</span><span class="p">,</span>
								<span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span><span class="p">,</span>
							<span class="p">)</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span><span class="n">adds</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">(</span><span class="n">parentity</span><span class="p">,</span> <span class="o">*</span><span class="n">stoptime</span><span class="p">)</span>
					<span class="n">adds</span><span class="p">,</span> <span class="n">dels</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
						<span class="n">parentity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
					<span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">((</span><span class="n">kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">adds</span><span class="p">)</span> <span class="o">-</span> <span class="n">dels</span><span class="p">)</span>
				<span class="k">except</span> <span class="n">KeyframeError</span><span class="p">:</span>
					<span class="n">adds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_adds_dels</span><span class="p">(</span>
						<span class="n">parentity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
					<span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span><span class="n">adds</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">keycache2</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">keycache3</span><span class="p">:</span>
					<span class="n">keycache3</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">keycache2</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">ret</span><span class="p">}</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">kcc</span> <span class="o">=</span> <span class="n">AssignmentTimeDict</span><span class="p">()</span>
				<span class="n">kcc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">ret</span><span class="p">}</span>
				<span class="n">keycache</span><span class="p">[</span><span class="n">keycache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcc</span>
			<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_keycache</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">parentity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">_KEY</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Get a OrderlyFrozenSet of keys that exist in the entity at the moment.</span>

<span class="sd">		With ``forward=True``, enable an optimization that copies old key sets</span>
<span class="sd">		forward and updates them.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycachelike</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_adds_dels</span><span class="p">,</span>
			<span class="n">parentity</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_truncate_keycache</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">parent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">],</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">_ENTITY</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">keycache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span>
		<span class="n">keycache_key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">keycache_key</span> <span class="ow">in</span> <span class="n">keycache</span><span class="p">:</span>
			<span class="n">thiskeycache</span> <span class="o">=</span> <span class="n">keycache</span><span class="p">[</span><span class="n">keycache_key</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">thiskeycache</span><span class="p">:</span>
				<span class="n">thiskeycache</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">thiskeycache</span><span class="p">[</span><span class="n">turn</span><span class="p">]:</span>
					<span class="k">del</span> <span class="n">thiskeycache</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">thiskeycache</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">thiskeycache</span><span class="p">:</span>
				<span class="k">del</span> <span class="n">keycache</span><span class="p">[</span><span class="n">keycache_key</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_update_keycache</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">],</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Add or remove a key in the set describing the keys that exist.&quot;&quot;&quot;</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">Key</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Key</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span>
		<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
		<span class="n">parent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_truncate_keycache</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_no_kc</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">kc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycache</span><span class="p">(</span>
			<span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_as_deleted</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">difference</span><span class="p">((</span><span class="n">key</span><span class="p">,))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">union</span><span class="p">((</span><span class="n">key</span><span class="p">,))</span>
		<span class="n">parentibranch</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">parentibranch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">parentibranch</span><span class="p">]</span> <span class="o">=</span> <span class="n">AssignmentTimeDict</span><span class="p">(</span>
				<span class="p">{</span><span class="n">turn</span><span class="p">:</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">kc</span><span class="p">}}</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="n">turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">parentibranch</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">parentibranch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">kc</span><span class="p">}</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">parentibranch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">kc</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_count_as_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">obj</span> <span class="ow">is</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_adds_dels</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">entity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">stoptime</span><span class="p">:</span> <span class="n">Time</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">cache</span><span class="p">:</span> <span class="n">CacheKeys</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return a pair of sets describing changes to the entity&#39;s keys</span>

<span class="sd">		Returns a pair of sets: ``(added, deleted)``. These are the changes</span>
<span class="sd">		to the key set that occurred since ``stoptime``, which, if present,</span>
<span class="sd">		should be a triple ``(branch, turn, tick)``.</span>

<span class="sd">		With ``stoptime=None`` (the default), ``added`` will in fact be all</span>
<span class="sd">		keys, and ``deleted`` will be empty.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Not using the journal because that doesn&#39;t distinguish entities.</span>
		<span class="c1"># I think I might not want to use ``stoptime`` at all, now that</span>
		<span class="c1"># there is such a thing as keyframes...</span>
		<span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>
		<span class="n">added</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">branches</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">branc</span><span class="p">,</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_parent_btt</span><span class="p">(</span>
				<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
			<span class="p">):</span>
				<span class="k">if</span> <span class="n">branc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">branches</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">branches</span><span class="p">[</span><span class="n">branc</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span>
					<span class="n">trn</span>
				<span class="p">):</span>
					<span class="k">continue</span>
				<span class="n">turnd</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branc</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">turnd</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">turnd</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tck</span><span class="p">):</span>
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_as_deleted</span><span class="p">(</span><span class="n">turnd</span><span class="p">[</span><span class="n">trn</span><span class="p">][</span><span class="n">tck</span><span class="p">]):</span>
							<span class="n">deleted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
						<span class="k">break</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">trn</span> <span class="o">-=</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">turnd</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">trn</span><span class="p">):</span>
					<span class="k">break</span>
				<span class="n">tickd</span> <span class="o">=</span> <span class="n">turnd</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_as_deleted</span><span class="p">(</span><span class="n">tickd</span><span class="o">.</span><span class="n">final</span><span class="p">()):</span>
					<span class="n">deleted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
				<span class="k">break</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">kf</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">added</span><span class="p">,</span> <span class="n">deleted</span>
		<span class="k">for</span> <span class="n">branc</span><span class="p">,</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_parent_btt</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="n">branc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kf</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">kf</span><span class="p">[</span><span class="n">branc</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">trn</span><span class="p">):</span>
				<span class="k">continue</span>
			<span class="n">kfb</span> <span class="o">=</span> <span class="n">kf</span><span class="p">[</span><span class="n">branc</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">kfb</span> <span class="ow">and</span> <span class="n">kfb</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tck</span><span class="p">):</span>
				<span class="n">added</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kfb</span><span class="p">[</span><span class="n">trn</span><span class="p">][</span><span class="n">tck</span><span class="p">])</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">))</span>
			<span class="k">elif</span> <span class="n">kfb</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">trn</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">additions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kfb</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
				<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
					<span class="n">additions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
				<span class="n">added</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additions</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">break</span>
		<span class="k">return</span> <span class="n">added</span><span class="p">,</span> <span class="n">deleted</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Put a value in various dictionaries for later .retrieve(...).</span>

<span class="sd">		Needs at least five arguments, of which the -1th is the value</span>
<span class="sd">		to store, the -2th is the tick to store it at, the -3th</span>
<span class="sd">		is the turn to store it in, the -4th is the branch the</span>
<span class="sd">		revision is in, the -5th is the key the value is for,</span>
<span class="sd">		and the remaining arguments identify the entity that has</span>
<span class="sd">		the key, eg. a graph, node, or edge.</span>

<span class="sd">		With ``planning=True``, you will be permitted to alter</span>
<span class="sd">		&quot;history&quot; that takes place after the last non-planning</span>
<span class="sd">		moment of time, without much regard to consistency.</span>
<span class="sd">		Otherwise, contradictions will be handled by deleting</span>
<span class="sd">		everything in the contradicted plan after the present moment,</span>
<span class="sd">		unless you set ``contra=False``.</span>

<span class="sd">		``loading=True`` prevents me from updating the ORM&#39;s records</span>
<span class="sd">		of the ends of branches and turns.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">delete_plan</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;delete_plan&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">delete_plan</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">planning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">planning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_planning</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="k">if</span> <span class="n">contra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">contra</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">loading</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">_ENTITY</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">_KEY</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">_VALUE</span>
		<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
		<span class="k">if</span> <span class="n">loading</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_updload</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">parent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
		<span class="n">entikey</span> <span class="o">=</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="n">parentikey</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="n">contras</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_store_journal</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
				<span class="n">parentity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">entity</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parentity</span><span class="p">:</span>
					<span class="n">branches</span> <span class="o">=</span> <span class="n">parentity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="n">turns</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">parentikey</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span>
						<span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,)</span>
					<span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parentity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="n">turns</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
					<span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">entikey</span><span class="p">]</span>
					<span class="n">turns</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">entikey</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">entity</span><span class="p">,][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">branches</span>
					<span class="n">turns</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">contra</span><span class="p">:</span>
				<span class="n">contras</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_iter_future_contradictions</span><span class="p">(</span>
						<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">turns</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span>
					<span class="p">)</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="n">contras</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">for</span> <span class="n">contra_turn</span><span class="p">,</span> <span class="n">contra_tick</span> <span class="ow">in</span> <span class="n">contras</span><span class="p">:</span>
					<span class="k">if</span> <span class="p">(</span>
						<span class="p">(</span>
							<span class="n">branch</span><span class="p">,</span>
							<span class="n">contra_turn</span><span class="p">,</span>
							<span class="n">contra_tick</span><span class="p">,</span>
						<span class="p">)</span>
						<span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_time_plan</span>
					<span class="p">):</span>  <span class="c1"># could&#39;ve been deleted in this very loop</span>
						<span class="n">delete_plan</span><span class="p">(</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_time_plan</span><span class="p">[</span>
								<span class="n">branch</span><span class="p">,</span> <span class="n">contra_turn</span><span class="p">,</span> <span class="n">contra_tick</span>
							<span class="p">]</span>
						<span class="p">)</span>
			<span class="k">if</span> <span class="n">planning</span><span class="p">:</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NodeContentsCache</span><span class="p">)</span>
					<span class="ow">and</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">turns</span>
					<span class="ow">and</span> <span class="n">tick</span> <span class="o">&lt;</span> <span class="n">turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>
				<span class="p">):</span>
					<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span>
						<span class="s2">&quot;Already have some ticks after </span><span class="si">{}</span><span class="s2"> in turn </span><span class="si">{}</span><span class="s2"> of branch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
							<span class="n">tick</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">branch</span>
						<span class="p">)</span>
					<span class="p">)</span>
				<span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_time_plan</span><span class="p">[</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_last_plan</span>
				<span class="p">)</span>
				<span class="n">ticks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">][</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span>
				<span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">][</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks</span>
			<span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">turns</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">loading</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">planning</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_extend_branch</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span><span class="p">[(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
			<span class="n">turns</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">time_entity</span><span class="p">[</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">loading</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_update_keycache</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">remove_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
		<span class="n">todel</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">branc</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span>
				<span class="p">(</span><span class="n">branc</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span>
				<span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
			<span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_entity</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">branc</span> <span class="o">==</span> <span class="n">branch</span>
		<span class="p">}</span>
		<span class="n">todel_shallow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">branch</span><span class="p">}</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">todel_shallow</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">branc</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_remove_btt_parentikey</span><span class="p">(</span>
					<span class="n">branc</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					<span class="n">entity</span><span class="p">,</span>
					<span class="n">key</span><span class="p">,</span>
					<span class="n">branc</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span><span class="p">[</span>
						<span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branc</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_remove_btt_parentikey</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">parent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">],</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">_ENTITY</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">_KEY</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_entity</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">branchkey</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="n">keykey</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,)</span>
		<span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
			<span class="n">parentt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">parentt</span><span class="p">:</span>
				<span class="n">entty</span> <span class="o">=</span> <span class="n">parentt</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entty</span><span class="p">:</span>
					<span class="n">kee</span> <span class="o">=</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">kee</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">kee</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">kee</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">entty</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">parentt</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">parentt</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">branchkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
			<span class="n">entty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branchkey</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">entty</span><span class="p">:</span>
				<span class="k">del</span> <span class="n">entty</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">entty</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branchkey</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">keykey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
			<span class="n">entty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">keykey</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entty</span><span class="p">:</span>
				<span class="n">kee</span> <span class="o">=</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">kee</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">kee</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">kee</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">entty</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">keykey</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delete all data from a specific tick, if present&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_entity</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delete all data from a specific tick&quot;&quot;&quot;</span>
		<span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_entity</span><span class="p">[</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">]</span>
		<span class="n">branchkey</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="n">keykey</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">+</span> <span class="p">(</span><span class="n">entity</span><span class="p">,)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
				<span class="n">parentt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">parentt</span><span class="p">:</span>
					<span class="n">entty</span> <span class="o">=</span> <span class="n">parentt</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entty</span><span class="p">:</span>
						<span class="n">kee</span> <span class="o">=</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">kee</span><span class="p">:</span>
							<span class="n">branhc</span> <span class="o">=</span> <span class="n">kee</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
								<span class="n">trn</span> <span class="o">=</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
								<span class="k">del</span> <span class="n">trn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">trn</span><span class="p">:</span>
									<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">:</span>
									<span class="k">del</span> <span class="n">kee</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">kee</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">entty</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">parentt</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">parentt</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">branchkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
				<span class="n">entty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branchkey</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">entty</span><span class="p">:</span>
					<span class="n">branhc</span> <span class="o">=</span> <span class="n">entty</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
						<span class="n">trn</span> <span class="o">=</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">trn</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">trn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">trn</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">entty</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">entty</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branchkey</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">keykey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
				<span class="n">entty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">keykey</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entty</span><span class="p">:</span>
					<span class="n">kee</span> <span class="o">=</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">kee</span><span class="p">:</span>
						<span class="n">branhc</span> <span class="o">=</span> <span class="n">kee</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
							<span class="n">trn</span> <span class="o">=</span> <span class="n">entty</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">trn</span><span class="p">:</span>
								<span class="k">del</span> <span class="n">trn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
							<span class="k">if</span> <span class="ow">not</span> <span class="n">trn</span><span class="p">:</span>
								<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">kee</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">kee</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">entty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">entty</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">keykey</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
				<span class="n">branhc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
					<span class="n">trn</span> <span class="o">=</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">trn</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">trn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">trn</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">:</span>
				<span class="n">pbranhc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">pbranhc</span><span class="p">:</span>
					<span class="n">ptrn</span> <span class="o">=</span> <span class="n">pbranhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ptrn</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">ptrn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">ptrn</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">pbranhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">pbranhc</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_remove_keycache</span><span class="p">((</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">),</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_remove_keycache</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">entity_branch</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">],</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Remove the future of a given entity from a branch in the keycache&quot;&quot;&quot;</span>
		<span class="n">keycache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span>
		<span class="k">if</span> <span class="n">entity_branch</span> <span class="ow">in</span> <span class="n">keycache</span><span class="p">:</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="n">keycache</span><span class="p">[</span><span class="n">entity_branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">kc</span><span class="p">:</span>
				<span class="n">kcturn</span> <span class="o">=</span> <span class="n">kc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">kcturn</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">kcturn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
				<span class="n">kcturn</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">kcturn</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">kc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="n">kc</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">kc</span><span class="p">:</span>
				<span class="k">del</span> <span class="n">keycache</span><span class="p">[</span><span class="n">entity_branch</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">truncate</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">truncate_branch</span><span class="p">(</span><span class="n">branhc</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
				<span class="n">trn</span> <span class="o">=</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="n">trn</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
				<span class="n">branhc</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]:</span>
					<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">branhc</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>

		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">entities</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">entities</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
					<span class="k">for</span> <span class="n">branches</span> <span class="ow">in</span> <span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
							<span class="k">continue</span>
						<span class="n">truncate_branch</span><span class="p">(</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">branches</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">truncate_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">branches</span> <span class="ow">in</span> <span class="n">keys</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
						<span class="k">continue</span>
					<span class="n">truncate_branch</span><span class="p">(</span><span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>
			<span class="n">truncate_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>
			<span class="n">truncate_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">entity_branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entity_branch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">branch</span><span class="p">:</span>
					<span class="n">truncate_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">entity_branch</span><span class="p">])</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_future_contradictions</span><span class="p">(</span>
		<span class="n">entity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">],</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">_KEY</span><span class="p">,</span>
		<span class="n">turns</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over contradicted ``(turn, tick)`` if applicable&quot;&quot;&quot;</span>
		<span class="c1"># assumes that all future entries are in the plan</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">turns</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">turns</span><span class="p">:</span>
			<span class="n">future_ticks</span> <span class="o">=</span> <span class="n">turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">tck</span><span class="p">,</span> <span class="n">newval</span> <span class="ow">in</span> <span class="n">future_ticks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">newval</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
			<span class="n">future_turns</span> <span class="o">=</span> <span class="n">turns</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">turns</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">turn</span><span class="p">):</span>
			<span class="n">future_turns</span> <span class="o">=</span> <span class="n">turns</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">future_turns</span> <span class="o">=</span> <span class="n">turns</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">future_turns</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">ticks</span> <span class="ow">in</span> <span class="n">future_turns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">newval</span> <span class="ow">in</span> <span class="n">ticks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">newval</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">overwriting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span><span class="p">:</span>
			<span class="k">yield</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">yield</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_store_journal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="c1"># overridden in lisien.cache.InitializedCache</span>
		<span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">_ENTITY</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">_KEY</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">_VALUE</span>
		<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span>
		<span class="n">parent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
		<span class="n">settings_turns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
		<span class="n">presettings_turns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_for_journal</span><span class="p">(</span>
			<span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="n">store_hint</span><span class="o">=</span><span class="kc">False</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">settings_turns</span><span class="p">:</span>
			<span class="c1"># These assertions hold for most caches but not for the contents</span>
			<span class="c1"># caches, and are therefore commented out.</span>
			<span class="c1"># assert turn in presettings_turns \</span>
			<span class="c1"># or turn in presettings_turns.future()</span>
			<span class="n">setticks</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span>
				<span class="n">Tick</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]</span>
			<span class="p">]</span> <span class="o">=</span> <span class="n">settings_turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span> <span class="ow">and</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">setticks</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
					<span class="s2">&quot;Already have journal entry&quot;</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="c1"># assert tick not in setticks</span>
			<span class="n">presetticks</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span>
				<span class="n">Tick</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">_VALUE</span><span class="p">]</span>
			<span class="p">]</span> <span class="o">=</span> <span class="n">presettings_turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="c1"># assert tick not in presetticks</span>
			<span class="n">presetticks</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
			<span class="n">setticks</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">presettings_turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">prev</span><span class="p">)}</span>
			<span class="n">settings_turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_base_retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">],</span>
		<span class="n">store_hint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">retrieve_hint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Hot code.</span>

<span class="sd">		Swim up the timestream trying to find a value for the</span>
<span class="sd">		key in the entity that applied at the given (branch, turn, tick).</span>
<span class="sd">		If we hit a keyframe, return the value therein, or KeyError if</span>
<span class="sd">		there is none.</span>

<span class="sd">		May *return* an exception, rather than raising it. This is to enable</span>
<span class="sd">		use outside try-blocks, which have some performance overhead.</span>

<span class="sd">		Memoized by default. Use ``store_hint=False`` to avoid making a memo,</span>
<span class="sd">		``retrieve_hint=False`` to avoid using one already made.</span>

<span class="sd">		With ``search=True``, use binary search. This isn&#39;t the default,</span>
<span class="sd">		because most retrievals are close to each other.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">shallowest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span>
		<span class="k">if</span> <span class="n">retrieve_hint</span> <span class="ow">and</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">shallowest</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">shallowest</span><span class="p">[</span><span class="n">args</span><span class="p">]</span>
		<span class="n">entity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Key</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
		<span class="n">keyframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="p">{})</span>
		<span class="n">branches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span>
		<span class="n">entikey</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span> <span class="o">+</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">search</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">hint</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">store_hint</span><span class="p">:</span>
				<span class="n">shallowest</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
			<span class="k">return</span> <span class="n">v</span>

		<span class="k">if</span> <span class="n">entikey</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
			<span class="n">branchentk</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">entikey</span><span class="p">]</span>
			<span class="c1"># We have data for this entity and key,</span>
			<span class="c1"># but a keyframe might have more recent data.</span>
			<span class="c1"># Iterate over the keyframes in reverse chronological order</span>
			<span class="c1"># and return either the first value in a keyframe for this</span>
			<span class="c1"># entity and key, or the first value in our own</span>
			<span class="c1"># store, whichever took effect later.</span>
			<span class="n">it</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_keyframes</span><span class="p">(</span>
					<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">loaded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_fork_points</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">)</span>
			<span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">zero</span><span class="p">,</span> <span class="n">one</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">zero</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
					<span class="n">it</span> <span class="o">=</span> <span class="n">chain</span><span class="p">([(</span><span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">)],</span> <span class="n">it</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">it</span> <span class="o">=</span> <span class="n">chain</span><span class="p">([((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="n">zero</span><span class="p">),</span> <span class="p">(</span><span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">)],</span> <span class="n">it</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
				<span class="c1"># There is at most one keyframe in the past.</span>
				<span class="c1"># If branches has anything later than that, before the present,</span>
				<span class="c1"># use branches. Otherwise, defer to the keyframe.</span>
				<span class="k">def</span><span class="w"> </span><span class="nf">get_chron</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branchentk</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">]:</span>
							<span class="k">if</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
								<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">t</span><span class="p">])</span>
							<span class="k">elif</span> <span class="p">(</span>
								<span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
								<span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
							<span class="p">):</span>
								<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
						<span class="k">elif</span> <span class="p">(</span>
							<span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
							<span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
						<span class="p">):</span>
							<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
					<span class="k">return</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Not in chron data&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

				<span class="n">kfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_keyframes</span><span class="p">(</span>
					<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">loaded</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">)</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">stoptime</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">kfit</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_parent_btt</span><span class="p">(</span>
						<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
					<span class="p">):</span>
						<span class="n">ret</span> <span class="o">=</span> <span class="n">get_chron</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
							<span class="k">continue</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">stoptime</span>
					<span class="k">if</span> <span class="p">(</span>
						<span class="n">b</span> <span class="ow">in</span> <span class="n">keyframes</span>
						<span class="ow">and</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
						<span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">]</span>
					<span class="p">):</span>
						<span class="n">kf</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
							<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">kf</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="k">return</span> <span class="n">hint</span><span class="p">(</span>
								<span class="n">NotInKeyframeError</span><span class="p">(</span>
									<span class="s2">&quot;No value&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span>
								<span class="p">)</span>
							<span class="p">)</span>
				<span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
					<span class="c1"># There are no keyframes in the past at all.</span>
					<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_parent_btt</span><span class="p">(</span>
						<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">):</span>
						<span class="n">ret</span> <span class="o">=</span> <span class="n">get_chron</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
							<span class="k">continue</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">TotalKeyError</span><span class="p">(</span>
						<span class="s2">&quot;No keyframe loaded&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="n">b</span> <span class="ow">in</span> <span class="n">keyframes</span>
					<span class="ow">and</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
					<span class="ow">and</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">]</span>
				<span class="p">):</span>
					<span class="n">kf</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">t</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">kf</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">NotInKeyframeError</span><span class="p">(</span><span class="s2">&quot;No value&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">TotalKeyError</span><span class="p">(</span>
						<span class="s2">&quot;No keyframe loaded&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span>
					<span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span><span class="p">),</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_keyframes_loaded</span> <span class="ow">and</span> <span class="p">(</span>
					<span class="n">b0</span> <span class="ow">in</span> <span class="n">keyframes</span>
					<span class="ow">and</span> <span class="n">r0</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span>
					<span class="ow">and</span> <span class="n">t0</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">]</span>
				<span class="p">):</span>
					<span class="c1"># There&#39;s a keyframe at this exact moment. Use it.</span>
					<span class="n">kf</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">][</span><span class="n">t0</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">kf</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span>
							<span class="n">NotInKeyframeError</span><span class="p">(</span><span class="s2">&quot;No value&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
						<span class="p">)</span>
				<span class="k">if</span> <span class="n">b0</span> <span class="ow">in</span> <span class="n">branchentk</span> <span class="ow">and</span> <span class="p">(</span>
					<span class="p">(</span>
						<span class="n">r0</span> <span class="ow">in</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span>
						<span class="ow">and</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
					<span class="p">)</span>
					<span class="ow">or</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
				<span class="p">):</span>
					<span class="k">if</span> <span class="n">r0</span> <span class="ow">in</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span>
						<span class="n">r0</span>
					<span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">t0</span><span class="p">):</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">][</span><span class="n">t0</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
				<span class="k">elif</span> <span class="n">b0</span> <span class="ow">in</span> <span class="n">branchentk</span> <span class="ow">and</span> <span class="p">(</span>
					<span class="n">r0</span> <span class="o">!=</span> <span class="n">r1</span>
					<span class="ow">and</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
					<span class="ow">and</span> <span class="p">(</span>
						<span class="p">(</span>
							<span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span> <span class="o">==</span> <span class="n">r1</span>
							<span class="ow">and</span> <span class="n">get</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">],</span> <span class="n">r0</span><span class="p">)</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">t1</span>
						<span class="p">)</span>
						<span class="ow">or</span> <span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r1</span>
					<span class="p">)</span>
				<span class="p">):</span>
					<span class="c1"># branches does not have a value *this* turn,</span>
					<span class="c1"># but has one for a prior turn, and it&#39;s still between</span>
					<span class="c1"># the two keyframes.</span>
					<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">branchentk</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">())</span>
				<span class="k">elif</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_keyframes_loaded</span><span class="p">:</span>
					<span class="c1"># branches has no value between these two keyframes,</span>
					<span class="c1"># but we have the keyframe further back.</span>
					<span class="c1"># Which doesn&#39;t mean any of its data is stored in</span>
					<span class="c1"># this cache, though.</span>
					<span class="k">if</span> <span class="p">(</span>
						<span class="n">b1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span>
						<span class="ow">or</span> <span class="n">r1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b1</span><span class="p">]</span>
						<span class="ow">or</span> <span class="n">t1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b1</span><span class="p">][</span><span class="n">r1</span><span class="p">]</span>
					<span class="p">):</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span>
							<span class="n">NotInKeyframeError</span><span class="p">(</span><span class="s2">&quot;No value&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
						<span class="p">)</span>
					<span class="n">brtk</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b1</span><span class="p">][</span><span class="n">r1</span><span class="p">][</span><span class="n">t1</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">brtk</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">brtk</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">hint</span><span class="p">(</span>
							<span class="n">NotInKeyframeError</span><span class="p">(</span><span class="s2">&quot;No value&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
						<span class="p">)</span>
		<span class="k">elif</span> <span class="n">keyframes</span><span class="p">:</span>
			<span class="c1"># We have no chronological data, just keyframes.</span>
			<span class="c1"># That makes things easy.</span>
			<span class="k">for</span> <span class="n">b0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_keyframes</span><span class="p">(</span>
				<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">loaded</span><span class="o">=</span><span class="kc">True</span>
			<span class="p">):</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="n">b0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span>
					<span class="ow">or</span> <span class="n">r0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">]</span>
					<span class="ow">or</span> <span class="n">t0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">]</span>
					<span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">][</span><span class="n">t0</span><span class="p">]</span>
				<span class="p">):</span>
					<span class="k">return</span> <span class="n">hint</span><span class="p">(</span>
						<span class="n">NotInKeyframeError</span><span class="p">(</span><span class="s2">&quot;No value&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
					<span class="p">)</span>
				<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">keyframes</span><span class="p">[</span><span class="n">b0</span><span class="p">][</span><span class="n">r0</span><span class="p">][</span><span class="n">t0</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">hint</span><span class="p">(</span><span class="n">TotalKeyError</span><span class="p">(</span><span class="s2">&quot;No value, ever&quot;</span><span class="p">,</span> <span class="n">entikey</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Get a value previously .store(...)&#39;d.</span>

<span class="sd">		Needs at least five arguments. The -1th is the tick</span>
<span class="sd">		within the turn you want,</span>
<span class="sd">		the -2th is that turn, the -3th is the branch,</span>
<span class="sd">		and the -4th is the key. All other arguments identify</span>
<span class="sd">		the entity that the key is in.</span>

<span class="sd">		With ``search=True``, use binary search; otherwise,</span>
<span class="sd">		seek back and forth like a tape head.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">.character</span><span class="w"> </span><span class="kn">import</span> <span class="n">Character</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">.facade</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
			<span class="n">CharacterFacade</span><span class="p">,</span>
			<span class="n">EngineFacade</span><span class="p">,</span>
			<span class="n">FacadeEntity</span><span class="p">,</span>
			<span class="n">FacadePortal</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">Place</span><span class="p">,</span> <span class="n">Thing</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">.portal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Portal</span>

		<span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">_KEY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_retrieve</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span><span class="s2">&quot;Set, then deleted&quot;</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
			<span class="n">ret</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">ret</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">CharacterFacade</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">):</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">EngineFacade</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">init_rulebooks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">FacadeEntity</span><span class="p">):</span>
			<span class="n">ret</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">character</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span>
					<span class="n">ret</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span>
				<span class="p">]</span>
				<span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">_real</span>
			<span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">:</span>
					<span class="n">character</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">character</span> <span class="o">=</span> <span class="n">Character</span><span class="p">(</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">init_rulebooks</span><span class="o">=</span><span class="kc">False</span>
					<span class="p">)</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">FacadePortal</span><span class="p">):</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">orig</span><span class="p">][</span><span class="n">ret</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span>
					<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">Portal</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">orig</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="k">return</span> <span class="n">character</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
					<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
						<span class="k">if</span> <span class="s2">&quot;location&quot;</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
							<span class="k">return</span> <span class="n">Thing</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">])</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="k">return</span> <span class="n">Place</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_entities_or_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_KEY</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over the keys an entity has, if you specify an entity.</span>

<span class="sd">		Otherwise, iterate over the entities themselves, or at any rate the</span>
<span class="sd">		tuple specifying which entity.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="n">entity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_no_kc</span><span class="p">:</span>
			<span class="n">kc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adds_dels</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">kc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycache</span><span class="p">(</span>
					<span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="n">KeyframeError</span><span class="p">:</span>
				<span class="k">return</span>
		<span class="k">for</span> <span class="n">that</span> <span class="ow">in</span> <span class="n">kc</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
				<span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="n">that</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
					<span class="s2">&quot;Bad keycache&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">that</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="k">yield</span> <span class="n">that</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_count_entities_or_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the number of keys an entity has, if you specify an entity.</span>

<span class="sd">		Otherwise, return the number of entities.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="n">entity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">,</span> <span class="n">_ENTITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_no_kc</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_adds_dels</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_keycache</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_contains_entity_or_key</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="o">*</span><span class="n">args</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Check if an entity has a key at the given time, if entity specified.</span>

<span class="sd">		Otherwise, check if the entity exists.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">parent</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_PARENT</span><span class="p">]</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">_ENTITY</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">_KEY</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
		<span class="n">retr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_retrieve</span><span class="p">(</span>
			<span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retr</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_as_deleted</span><span class="p">(</span>
			<span class="n">retr</span>
		<span class="p">)</span></div>



<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GraphValCache</span><span class="p">(</span><span class="n">Cache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">key</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_key</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_entities</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Stat</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="n">Stat</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

	<span class="n">iter_stats</span> <span class="o">=</span> <span class="n">iter_keys</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NodesCache</span><span class="p">(</span><span class="n">Cache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A cache for remembering whether nodes exist at a given time.&quot;&quot;&quot;</span>

	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">ex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">ex</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_count_as_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
		<span class="k">return</span> <span class="ow">not</span> <span class="n">obj</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_nodes</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="n">iter_entities</span> <span class="o">=</span> <span class="n">iter_nodes</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_nodes</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="n">count_entities</span> <span class="o">=</span> <span class="n">count_nodes</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_exists</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="n">contains_entity</span> <span class="o">=</span> <span class="n">node_exists</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_update_keycache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">forward</span><span class="p">):</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">ex</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
		<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">args</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">:</span>
			<span class="n">ex</span> <span class="o">=</span> <span class="o">...</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_update_keycache</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_future_contradictions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span>
		<span class="n">turns</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">yield from</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_iter_future_contradictions</span><span class="p">(</span>
			<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">turns</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span>
		<span class="p">)</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_edges_cache</span><span class="o">.</span><span class="n">_slow_iter_node_contradicted_times</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NodeValCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ret</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">key</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Stat</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_key</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EdgesCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="nb">bool</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A cache for remembering whether edges exist at a given time.&quot;&quot;&quot;</span>

	<span class="n">origcache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">],</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
		<span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">PickyDefaultDict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>
	<span class="p">)</span>
	<span class="n">predecessors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">],</span>
		<span class="nb">dict</span><span class="p">[</span>
			<span class="n">NodeName</span><span class="p">,</span>
			<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]],</span>
		<span class="p">],</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
		<span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">factory</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">StructuredDefaultDict</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">),</span>
	<span class="p">)</span>
	<span class="n">_origcache_lru</span><span class="p">:</span> <span class="n">KeyCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
		<span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">OrderedDict</span>
	<span class="p">)</span>

	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">successors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">total_size</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="p">):</span>
		<span class="n">all_handlers</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">EdgesCache</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">[</span>
				<span class="n">e</span><span class="o">.</span><span class="n">predecessors</span><span class="p">,</span>
				<span class="n">e</span><span class="o">.</span><span class="n">successors</span><span class="p">,</span>
				<span class="n">e</span><span class="o">.</span><span class="n">origcache</span><span class="p">,</span>
			<span class="p">]</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">handlers</span><span class="p">:</span>
			<span class="n">all_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">total_size</span><span class="p">(</span><span class="n">all_handlers</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="n">ret</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span> <span class="o">=</span> <span class="n">dests</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">dests</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">(</span>
					<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">ex</span><span class="p">}</span>
				<span class="p">)</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_count_as_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
		<span class="k">return</span> <span class="ow">not</span> <span class="n">obj</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_update_keycache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_update_keycache</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">)</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">Hashable</span>
		<span class="n">branch</span><span class="p">:</span> <span class="nb">str</span>
		<span class="n">turn</span><span class="p">:</span> <span class="nb">int</span>
		<span class="n">tick</span><span class="p">:</span> <span class="nb">int</span>
		<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">args</span>
		<span class="n">origs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_origcache</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span><span class="p">:</span>
			<span class="n">origs</span> <span class="o">=</span> <span class="n">origs</span><span class="o">.</span><span class="n">union</span><span class="p">((</span><span class="n">orig</span><span class="p">,))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">origs</span> <span class="o">=</span> <span class="n">origs</span><span class="o">.</span><span class="n">difference</span><span class="p">((</span><span class="n">orig</span><span class="p">,))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">origcache</span><span class="p">[</span><span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">origs</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_slow_iter_node_contradicted_times</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="c1"># slow and bad.</span>
		<span class="n">retrieve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_retrieve</span>
		<span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">[</span><span class="n">graph</span><span class="p">,][</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">[</span><span class="n">graph</span><span class="p">,][</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
		<span class="p">):</span>
			<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branches</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>  <span class="c1"># dest might really be orig</span>
				<span class="n">brnch</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">brnch</span><span class="p">:</span>
					<span class="n">ticks</span> <span class="o">=</span> <span class="n">brnch</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">tck</span><span class="p">,</span> <span class="n">present</span> <span class="ow">in</span> <span class="n">ticks</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">tck</span> <span class="o">&gt;</span> <span class="n">tick</span> <span class="ow">and</span> <span class="n">present</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">retrieve</span><span class="p">(</span>
							<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
						<span class="p">):</span>
							<span class="k">yield</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tck</span>
				<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">ticks</span> <span class="ow">in</span> <span class="n">brnch</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">for</span> <span class="n">tck</span><span class="p">,</span> <span class="n">present</span> <span class="ow">in</span> <span class="n">ticks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">present</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">retrieve</span><span class="p">(</span>
							<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
						<span class="p">):</span>
							<span class="k">yield</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_adds_dels_successors</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">parentity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">stoptime</span><span class="p">:</span> <span class="n">Time</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">cache</span><span class="p">:</span> <span class="n">CacheKeys</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span>
		<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">parentity</span>
		<span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">cache</span><span class="p">[</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">]:</span>
			<span class="n">added</span><span class="p">,</span> <span class="n">deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adds_dels</span><span class="p">(</span>
				<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">added</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
			<span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>
		<span class="n">itparbtt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_parent_btt</span>
		<span class="n">its</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ks</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">grap</span><span class="p">,</span> <span class="n">org</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="n">kfg</span> <span class="ow">in</span> <span class="n">its</span><span class="p">:</span>  <span class="c1"># too much iteration!</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">grap</span><span class="p">,</span> <span class="n">org</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">):</span>
				<span class="k">continue</span>
			<span class="k">for</span> <span class="n">branc</span><span class="p">,</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">itparbtt</span><span class="p">(</span>
				<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
			<span class="p">):</span>
				<span class="k">if</span> <span class="n">branc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kfg</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">kfgb</span> <span class="o">=</span> <span class="n">kfg</span><span class="p">[</span><span class="n">branc</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">kfgb</span><span class="p">:</span>
					<span class="n">kfgbr</span> <span class="o">=</span> <span class="n">kfgb</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">kfgbr</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tck</span><span class="p">):</span>
						<span class="k">if</span> <span class="n">kfgbr</span><span class="p">[</span><span class="n">tck</span><span class="p">]</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">:</span>
							<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
						<span class="k">continue</span>
				<span class="k">if</span> <span class="n">kfgb</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">trn</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">kfgb</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">:</span>
						<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">added</span><span class="p">,</span> <span class="n">deleted</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_adds_dels_predecessors</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">parentity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">stoptime</span><span class="p">:</span> <span class="n">Time</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">cache</span><span class="p">:</span> <span class="n">CacheKeys</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">graph</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">parentity</span>
		<span class="n">added</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span>
		<span class="k">if</span> <span class="n">cache</span><span class="p">[</span><span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">]:</span>
			<span class="k">for</span> <span class="n">orig</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">[</span><span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">]:</span>
				<span class="n">addidx</span><span class="p">,</span> <span class="n">delidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adds_dels</span><span class="p">(</span>
					<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="n">addidx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delidx</span><span class="p">:</span>
					<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">delidx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">addidx</span><span class="p">:</span>
					<span class="n">deleted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe</span>
			<span class="n">itparbtt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_iter_parent_btt</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kfg</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># too much iteration!</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="p">(</span><span class="n">grap</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="o">=</span> <span class="n">k</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">grap</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
					<span class="k">continue</span>
				<span class="k">for</span> <span class="n">branc</span><span class="p">,</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">itparbtt</span><span class="p">(</span>
					<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">stoptime</span><span class="o">=</span><span class="n">stoptime</span>
				<span class="p">):</span>
					<span class="k">if</span> <span class="n">branc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kfg</span><span class="p">:</span>
						<span class="k">continue</span>
					<span class="n">kfgb</span> <span class="o">=</span> <span class="n">kfg</span><span class="p">[</span><span class="n">branc</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">trn</span> <span class="ow">in</span> <span class="n">kfgb</span><span class="p">:</span>
						<span class="n">kfgbr</span> <span class="o">=</span> <span class="n">kfgb</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">kfgbr</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tck</span><span class="p">):</span>
							<span class="k">if</span> <span class="n">kfgbr</span><span class="p">[</span><span class="n">tck</span><span class="p">]:</span>
								<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
							<span class="k">continue</span>
					<span class="k">if</span> <span class="n">kfgb</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">trn</span><span class="p">):</span>
						<span class="k">if</span> <span class="n">kfgb</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">():</span>
							<span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">added</span><span class="p">,</span> <span class="n">deleted</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_origcache</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return a set of origin nodes leading to ``dest``&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycachelike</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">origcache</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_adds_dels_predecessors</span><span class="p">,</span>
			<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_successors</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over successors of a given origin node at a given time.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_no_kc</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adds_dels_successors</span><span class="p">(</span>
				<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycache</span><span class="p">(</span>
			<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_predecessors</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over predecessors to a destination node at a given time.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_no_kc</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adds_dels_predecessors</span><span class="p">(</span>
				<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_origcache</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">has_successor</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return whether an edge connects the origin to the destination now&quot;&quot;&quot;</span>
		<span class="c1"># Use a keycache if we have it.</span>
		<span class="c1"># If we don&#39;t, only generate one if we&#39;re forwarding, and only</span>
		<span class="c1"># if it&#39;s no more than a turn ago.</span>
		<span class="n">keycache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">keycache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">dest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycache</span><span class="p">(</span>
				<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
			<span class="p">)</span>
		<span class="n">got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_retrieve</span><span class="p">((</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">got</span> <span class="ow">is</span> <span class="kc">True</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">has_predecessor</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return whether an edge connects the destination to the origin now&quot;&quot;&quot;</span>
		<span class="n">got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_retrieve</span><span class="p">((</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">got</span> <span class="ow">is</span> <span class="kc">True</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">ex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">contra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">contra</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">loading</span>
		<span class="k">if</span> <span class="n">planning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">planning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_planning</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">orig</span><span class="p">,</span>
			<span class="n">dest</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">ex</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branches</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">[</span><span class="n">graph</span><span class="p">,][</span><span class="n">orig</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">pred_ticks</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">pred_ticks</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
				<span class="k">continue</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">predecessors</span><span class="p">[</span><span class="n">graph</span><span class="p">,][</span><span class="n">dest</span><span class="p">][</span><span class="n">orig</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span>
				<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">pred_ticks</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
				<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
			<span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EdgeValCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">Stat</span><span class="p">,</span>
		<span class="n">Value</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]],</span>
	<span class="p">]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">orig</span><span class="p">,</span>
			<span class="n">dest</span><span class="p">,</span>
			<span class="n">key</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Stat</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_key</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">redests</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">redests</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">(</span>
					<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">val</span>
				<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UniversalCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">UniversalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
			<span class="n">key</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">UniversalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">UniversalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">UniversalKey</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_key</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">ke</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GraphCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="kc">None</span><span class="p">,</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">],</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">],</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown graph type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="nb">type</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ret</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal graph type was stored&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="n">iter_entities</span> <span class="o">=</span> <span class="n">iter_keys</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="n">kc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keycache</span><span class="p">(</span>
			<span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">kc</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="s2">&quot;Deleted&quot;</span><span class="p">]],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RulebooksCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="kc">None</span><span class="p">,</span>
		<span class="n">RulebookName</span><span class="p">,</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">],</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rules_prio</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">],</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">rules</span><span class="p">,</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">rules_prio</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a rules list&quot;</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="sa">f</span><span class="s2">&quot;Priorities are floats, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">priority</span>
			<span class="p">)</span>
		<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Rule names must be strings&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span>
			<span class="n">rulebook</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">rules_prio</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]:</span>
		<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rules list was stored&quot;</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prio</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook priority was stored&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">)</span>
		<span class="n">ruled</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule name was stored&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="n">ruled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RuleName</span><span class="p">(</span><span class="n">rule</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ruled</span><span class="p">,</span> <span class="n">RulebookPriority</span><span class="p">(</span><span class="n">prio</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">rulebook</span><span class="p">,</span> <span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">prio</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ret</span><span class="p">[</span><span class="n">rulebook</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rules</span><span class="p">),</span> <span class="n">prio</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">rb_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rb_name</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook name was stored&quot;</span><span class="p">,</span> <span class="n">rb_name</span><span class="p">)</span>
			<span class="k">yield</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">rb_name</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RuleAttribCache</span><span class="p">[</span><span class="n">_T</span><span class="p">](</span>
	<span class="n">Cache</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">_T</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">,</span> <span class="n">_T</span><span class="p">]],</span> <span class="n">ABC</span>
<span class="p">):</span>
	<span class="n">overwrite_journal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">attrib</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span>
			<span class="n">rule</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">attrib</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="k">yield</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

	<span class="n">iter_rules</span> <span class="o">=</span> <span class="n">iter_keys</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FuncListCache</span><span class="p">[</span><span class="n">_T</span><span class="p">:</span> <span class="n">RuleFuncName</span><span class="p">](</span><span class="n">RuleAttribCache</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">ABC</span><span class="p">):</span>
	<span class="n">functype</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule function list&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">functype</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">funcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleFuncName</span><span class="p">],</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a rule function list&quot;</span><span class="p">,</span> <span class="n">funcs</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a valid rule function name&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span>
			<span class="n">rule</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">funcs</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="n">contains_key</span> <span class="o">=</span> <span class="n">contains_rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleFuncName</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">rb</span><span class="p">,</span> <span class="n">funcs</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ret</span><span class="p">[</span><span class="n">rb</span><span class="p">]</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleFuncName</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TriggerListCache</span><span class="p">(</span><span class="n">FuncListCache</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]):</span>
	<span class="n">functype</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="n">TriggerFuncName</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PrereqListCache</span><span class="p">(</span><span class="n">FuncListCache</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]):</span>
	<span class="n">functype</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="n">PrereqFuncName</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ActionListCache</span><span class="p">(</span><span class="n">FuncListCache</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]):</span>
	<span class="n">functype</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="n">ActionFuncName</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NeighborhoodsCache</span><span class="p">(</span><span class="n">RuleAttribCache</span><span class="p">[</span><span class="n">RuleNeighborhood</span><span class="p">]):</span>
	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">neighborhood</span><span class="p">:</span> <span class="n">RuleNeighborhood</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">neighborhood</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid neighborhood&quot;</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">neighborhood</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Neighborhoods can&#39;t be negative&quot;</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
			<span class="n">rule</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">neighborhood</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RuleNeighborhood</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid neighborhood cached&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Negative neighborhood cached&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BignessCache</span><span class="p">(</span><span class="n">RuleAttribCache</span><span class="p">[</span><span class="n">RuleBig</span><span class="p">]):</span>
	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">big</span><span class="p">:</span> <span class="n">RuleBig</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">big</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;big must be boolean&quot;</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span>
			<span class="n">rule</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">big</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RuleBig</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Non-boolean value cached for rule.big&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RuleBig</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">):</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleBig</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NodesRulebooksCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]</span>
<span class="p">):</span>
	<span class="n">overwrite_journal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rulebook</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook name&quot;</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">rulebook</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RulebookName</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Invalid rulebook name was stored&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ret</span>
			<span class="p">)</span>
		<span class="k">return</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CharactersRulebooksCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="p">):</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">Key</span><span class="p">(</span><span class="kc">None</span><span class="p">),),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rulebook</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook name&quot;</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span>
			<span class="n">character</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">rulebook</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RulebookName</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="kc">None</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook name was stored&quot;</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PortalsRulebooksCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">RulebookName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook name&quot;</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">destrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_successors</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="n">destrbs</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">rb</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="n">destrbs</span> <span class="o">=</span> <span class="p">{</span><span class="n">dest</span><span class="p">:</span> <span class="n">rb</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">char</span><span class="p">,</span>
			<span class="n">orig</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">destrbs</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="c1"># The former will be overwritten in the journal (but not elsewhere)</span>
		<span class="c1"># by the latter:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwriting</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
				<span class="n">char</span><span class="p">,</span>
				<span class="n">orig</span><span class="p">,</span>
				<span class="n">dest</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn</span><span class="p">,</span>
				<span class="n">tick</span><span class="p">,</span>
				<span class="n">rb</span><span class="p">,</span>
				<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
				<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
				<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
				<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RulebookName</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Invalid rulebook name was stored&quot;</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ret</span>
			<span class="p">)</span>
		<span class="k">return</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve_successors</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Invalid successors dict was stored&quot;</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">ret</span>
			<span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="n">NodeName</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ret</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span> <span class="o">=</span> <span class="n">dests</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_orig_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_keys</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid destination&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
			<span class="k">yield</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rulebook</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">subkf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">(</span>
						<span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span>
						<span class="n">branch</span><span class="p">,</span>
						<span class="n">turn</span><span class="p">,</span>
						<span class="n">tick</span><span class="p">,</span>
					<span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="n">subkf</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">rulebook</span>
				<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
					<span class="n">subkf</span> <span class="o">=</span> <span class="p">{</span><span class="n">dest</span><span class="p">:</span> <span class="n">rulebook</span><span class="p">}</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">subkf</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LeaderSetCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="nb">bool</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">CharName</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A cache for remembering what set of characters have certain nodes as units&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">is_unit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="k">if</span> <span class="n">is_unit</span><span class="p">:</span>
			<span class="n">users</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">([</span><span class="n">character</span><span class="p">])</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">users</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="ow">not</span> <span class="n">forward</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="ow">not</span> <span class="n">forward</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="n">users</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">([])</span>
			<span class="n">users</span> <span class="o">-=</span> <span class="p">{</span><span class="n">character</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">users</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">CharName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">CharName</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">CharName</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">alias_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch_from</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">branch_to</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrderlyFrozenSet</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">alias_keyframe</span><span class="p">(</span><span class="n">branch_from</span><span class="p">,</span> <span class="n">branch_to</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UnitDictCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">store</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid node name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_unit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
				<span class="n">store</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_unit</span>
			<span class="k">elif</span> <span class="n">is_unit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">is_unit</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
				<span class="n">store</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="sa">f</span><span class="s2">&quot;Unitness should be Boolean, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">is_unit</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">is_unit</span>
				<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">store</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_entities</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharName</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="s2">&quot;Invalid character name was stored&quot;</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">c</span>
				<span class="p">)</span>
			<span class="k">yield</span> <span class="n">CharName</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_entities</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid unit dict was stored&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">retrieved</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid node name was stored&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;A non-boolean was stored for unitness&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
			<span class="n">retrieved</span><span class="p">[</span><span class="n">NodeName</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x</span>
		<span class="k">return</span> <span class="n">retrieved</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_graph</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="n">contains_key</span> <span class="o">=</span> <span class="n">contains_graph</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharName</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid character name was stored&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
			<span class="k">yield</span> <span class="n">CharName</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

	<span class="n">iter_keys</span> <span class="o">=</span> <span class="n">iter_graphs</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">character</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ret</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">character</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UnitnessCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="nb">bool</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A cache for remembering when a node is a unit of a character.&quot;&quot;&quot;</span>

	<span class="n">initial_value</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">leader_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LeaderSetCache</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">LeaderSetCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">dict_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UnitDictCache</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">UnitDictCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_count_as_deleted</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
		<span class="k">return</span> <span class="ow">not</span> <span class="n">obj</span>

	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">overwriting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span><span class="p">:</span>
			<span class="k">yield</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">leader_cache</span><span class="o">.</span><span class="n">overwriting</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">overwriting</span><span class="p">():</span>
			<span class="k">yield</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">overwrite_journal</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">is_unit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_forward</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">is_unit</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="ow">not</span> <span class="n">forward</span>
			<span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">is_unit</span><span class="p">:</span>
			<span class="n">d</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">elif</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
			<span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">d</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">leader_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">is_unit</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">character</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">{</span>
				<span class="n">graph</span><span class="p">:</span> <span class="p">{</span>
					<span class="n">node</span><span class="p">:</span> <span class="n">is_unit</span> <span class="k">for</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span><span class="p">)</span> <span class="ow">in</span> <span class="n">graph_units</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
				<span class="p">}</span>
				<span class="k">for</span> <span class="n">graph</span><span class="p">,</span> <span class="n">graph_units</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">set_keyframe</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">graph</span><span class="p">,</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">character</span><span class="p">,</span> <span class="n">graph</span><span class="p">),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">kf</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_graph</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">contains_unit</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
					<span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
				<span class="p">)</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>

	<span class="n">retrieve</span> <span class="o">=</span> <span class="n">contains_unit</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_char_graph_units</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
				<span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
			<span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">char</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_entities</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_entities</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_char_only_unit</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">count_entities</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No unit, or more than one unit&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">iter_entities</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_entities</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No unit, or more than one unit&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">iter_entities</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No unit&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_char_only_graph</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CharName</span><span class="p">:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">graph</span> <span class="o">=</span> <span class="o">...</span>
		<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">graph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">iter_char_graphs</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;More than one graph&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No units&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">graph</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_char_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">iter_entities</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">oner</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">]:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Decorator to turn an iterator into a function that returns the only value</span>

<span class="sd">	Raises RuntimeError if the iterator yields more than one value, or no values.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">oned</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">already</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">one</span> <span class="ow">in</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">one</span> <span class="ow">in</span> <span class="n">already</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Already yielded&quot;</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
			<span class="n">already</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
			<span class="k">yield</span> <span class="n">one</span>

	<span class="k">return</span> <span class="n">oned</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RulesHandledCache</span><span class="p">[</span><span class="o">*</span><span class="n">_ENTITY</span><span class="p">](</span><span class="n">ABC</span><span class="p">):</span>
	<span class="n">engine</span><span class="p">:</span> <span class="s2">&quot;engine.Engine&quot;</span>
	<span class="n">lock</span><span class="p">:</span> <span class="n">RLock</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">RLock</span><span class="p">)</span>
	<span class="n">handled</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="o">*</span><span class="n">_ENTITY</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span>
		<span class="nb">set</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
	<span class="n">handled_deep</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">AssignmentTimeDict</span><span class="p">[</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="nb">dict</span><span class="p">[</span>
				<span class="n">Tick</span><span class="p">,</span>
				<span class="nb">tuple</span><span class="p">[</span>
					<span class="n">_ENTITY</span><span class="p">,</span>
					<span class="n">RulebookName</span><span class="p">,</span>
					<span class="n">RuleName</span><span class="p">,</span>
				<span class="p">],</span>
			<span class="p">],</span>
		<span class="p">],</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
		<span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">PickyDefaultDict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>
	<span class="p">)</span>

	<span class="nd">@classmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">__attrs_init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
		<span class="n">iter_unhandled_rules</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;iter_unhandled_rules&quot;</span><span class="p">)</span>
		<span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;iter_unhandled_rules&quot;</span><span class="p">,</span> <span class="n">oner</span><span class="p">(</span><span class="n">iter_unhandled_rules</span><span class="p">))</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">entity</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">]</span>
		<span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]</span>
		<span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]</span>
		<span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>
		<span class="k">return</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">EntityKey</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
		<span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]:</span>
			<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
					<span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span>
					<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="p">{(</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">)}</span>
				<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">turn</span><span class="p">:</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="p">{(</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">)}}</span>
			<span class="p">}</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
			<span class="n">rules_handled_this_turn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">loading</span> <span class="ow">and</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules_handled_this_turn</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
					<span class="s2">&quot;Rule already run for same entity and rulebook&quot;</span><span class="p">,</span>
					<span class="n">entity</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="n">rules_handled_this_turn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">rule</span><span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recs</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="n">loading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">remove_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">ticks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rbset</span> <span class="ow">in</span> <span class="n">ticks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rbset</span><span class="p">:</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
							<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">]</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">total_size</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Returns the approximate memory footprint an object and all of its contents.</span>

<span class="sd">		Automatically finds the contents of the following builtin containers and</span>
<span class="sd">		their subclasses:  tuple, list, deque, dict, set and OrderlyFrozenSet.</span>
<span class="sd">		To search other containers, add handlers to iterate over their contents:</span>

<span class="sd">		    handlers = {SomeContainerClass: iter,</span>
<span class="sd">		                OtherContainerClass: OtherContainerClass.get_elements}</span>

<span class="sd">		From https://code.activestate.com/recipes/577504-compute-memory-footprint-of-an-object-and-its-cont/download/1/</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">all_handlers</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nb">tuple</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="nb">list</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">RulesHandledCache</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">mark_handled</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">],</span>
			<span class="nb">dict</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
			<span class="nb">set</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">OrderlyFrozenSet</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
			<span class="n">Cache</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="p">[</span>
				<span class="n">o</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
				<span class="n">o</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
				<span class="n">o</span><span class="o">.</span><span class="n">presettings</span><span class="p">,</span>
				<span class="n">o</span><span class="o">.</span><span class="n">keycache</span><span class="p">,</span>
			<span class="p">],</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">handlers</span><span class="p">:</span>
			<span class="n">all_handlers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
		<span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># track which object id&#39;s have already been seen</span>
		<span class="n">default_size</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span>
			<span class="mi">0</span>
		<span class="p">)</span>  <span class="c1"># estimate sizeof object without __sizeof__</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">sizeof</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>  <span class="c1"># do not double count the same object</span>
				<span class="k">return</span> <span class="mi">0</span>
			<span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">getsizeof</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">default_size</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

			<span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">all_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
					<span class="n">s</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">sizeof</span><span class="p">,</span> <span class="n">handler</span><span class="p">(</span><span class="n">o</span><span class="p">)))</span>
					<span class="k">break</span>
			<span class="k">return</span> <span class="n">s</span>

		<span class="k">return</span> <span class="n">sizeof</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">truncate</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">:</span>
			<span class="k">return</span>

		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="n">turn_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">turn_d</span> <span class="ow">and</span> <span class="p">(</span>
				<span class="n">view</span> <span class="o">:=</span> <span class="n">turn_d</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span>
				<span class="k">else</span> <span class="n">turn_d</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
			<span class="p">):</span>
				<span class="k">for</span> <span class="n">ruled</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
					<span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">ruled</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
							<span class="n">rule_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
							<span class="n">rule_set</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
							<span class="k">if</span> <span class="ow">not</span> <span class="n">rule_set</span><span class="p">:</span>
								<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
				<span class="n">turn_d</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
			<span class="n">to_del</span> <span class="o">=</span> <span class="p">(</span>
				<span class="n">turn_d</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span>
				<span class="k">else</span> <span class="n">turn_d</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
			<span class="p">)</span>
			<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_del</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">ruled</span> <span class="ow">in</span> <span class="n">turn_d</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">ruled</span><span class="p">:</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
							<span class="n">rule_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span>
								<span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">r</span>
							<span class="p">]</span>
							<span class="n">rule_set</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
							<span class="k">if</span> <span class="ow">not</span> <span class="n">rule_set</span><span class="p">:</span>
								<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">r</span><span class="p">]</span>
			<span class="n">turn_d</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">Direction</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">args</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_handled_rules</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">EntityKey</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span>
				<span class="ow">and</span> <span class="n">turn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_deep</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incoherent </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CharacterRulesHandledCache</span><span class="p">(</span><span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">]):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_characters_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">(</span><span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">rb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rulebook</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">rb</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">((</span><span class="n">character</span><span class="p">,),</span> <span class="n">rb</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
					<span class="k">yield</span> <span class="n">prio</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character</span><span class="p">,))</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UnitRulesHandledCache</span><span class="p">(</span><span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_units_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span> <span class="n">character</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">charname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
			<span class="n">rb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rulebook</span><span class="p">(</span><span class="n">charname</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">rb</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">for</span> <span class="n">graphname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_unitness_cache</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span>
				<span class="n">charname</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">):</span>
				<span class="c1"># Seems bad that I have to check twice like this.</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">existences</span> <span class="o">=</span> <span class="p">(</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_unitness_cache</span><span class="o">.</span><span class="n">dict_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
							<span class="n">charname</span><span class="p">,</span> <span class="n">graphname</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
						<span class="p">)</span>
					<span class="p">)</span>
				<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">existences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">ex</span><span class="p">:</span>
						<span class="k">continue</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">(</span>
						<span class="p">(</span><span class="n">charname</span><span class="p">,</span> <span class="n">graphname</span><span class="p">,</span> <span class="n">node</span><span class="p">),</span> <span class="n">rb</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span>
					<span class="p">)</span>
					<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
							<span class="k">yield</span> <span class="n">prio</span><span class="p">,</span> <span class="n">charname</span><span class="p">,</span> <span class="n">graphname</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character_graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit_graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character_graph</span><span class="p">,</span> <span class="n">unit_graph</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CharacterThingRulesHandledCache</span><span class="p">(</span><span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_characters_things_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span> <span class="n">character</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">RulebookPriority</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="n">charm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span>
		<span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charm</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">rulebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rulebook</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charm</span><span class="p">[</span><span class="n">character</span><span class="p">]</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">(</span>
					<span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">),</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span>
				<span class="p">)</span>
				<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
						<span class="k">yield</span> <span class="n">prio</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CharacterPlaceRulesHandledCache</span><span class="p">(</span><span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_characters_places_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span> <span class="n">character</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="n">charm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span>
		<span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charm</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">rulebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rulebook</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charm</span><span class="p">[</span><span class="n">character</span><span class="p">]</span><span class="o">.</span><span class="n">place</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">(</span>
					<span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">place</span><span class="p">),</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span>
				<span class="p">)</span>
				<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
						<span class="k">yield</span> <span class="n">prio</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">place</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">place</span><span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CharacterPortalRulesHandledCache</span><span class="p">(</span>
	<span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_characters_portals_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span> <span class="n">character</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="n">charm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span>
		<span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charm</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">rulebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rulebook</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
					<span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="n">char</span> <span class="o">=</span> <span class="n">charm</span><span class="p">[</span><span class="n">character</span><span class="p">]</span>
			<span class="n">charn</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">node</span>
			<span class="n">charp</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">portal</span>
			<span class="k">for</span> <span class="n">orig</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charp</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="k">if</span> <span class="n">orig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">charn</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">charp</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
					<span class="k">if</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">charn</span><span class="p">:</span>
						<span class="k">continue</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">(</span>
						<span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span>
					<span class="p">)</span>
					<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
							<span class="k">yield</span> <span class="n">prio</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">origin</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">destination</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NodeRulesHandledCache</span><span class="p">(</span><span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]):</span>
	<span class="n">handled</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_nodes_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">character</span><span class="p">,</span> <span class="n">node</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="n">charm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span>
		<span class="k">for</span> <span class="n">character_name</span><span class="p">,</span> <span class="n">character</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
			<span class="n">charm</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">character</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
				<span class="n">rulebook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rulebook</span><span class="p">(</span>
					<span class="n">character_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
						<span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
				<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">(</span>
					<span class="p">(</span><span class="n">character_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">),</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span>
				<span class="p">)</span>
				<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
						<span class="k">yield</span> <span class="n">prio</span><span class="p">,</span> <span class="n">character_name</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PortalRulesHandledCache</span><span class="p">(</span><span class="n">RulesHandledCache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]):</span>
	<span class="n">handled</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span>
		<span class="nb">set</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span>
	<span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_portals_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_unhandled_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">character_name</span><span class="p">,</span> <span class="n">character</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="k">for</span> <span class="n">orig_name</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span>
				<span class="n">OrderlyFrozenSet</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_portals_rulebooks_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span>
						<span class="n">character_name</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
				<span class="p">)</span>
			<span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">destrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_portals_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve_successors</span><span class="p">(</span>
						<span class="n">character_name</span><span class="p">,</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
				<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
					<span class="c1"># shouldn&#39;t happen, but apparently does??</span>
					<span class="c1"># Seems to be a case of too many keys showing up in the</span>
					<span class="c1"># iteration. Currently demonstrated by remake_college24.py</span>
					<span class="c1"># 2025-02-07</span>
					<span class="k">continue</span>
				<span class="k">for</span> <span class="n">dest_name</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">destrbs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
					<span class="n">rulebook</span> <span class="o">=</span> <span class="n">destrbs</span><span class="p">[</span><span class="n">dest_name</span><span class="p">]</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_rulebooks_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
							<span class="n">rulebook</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
						<span class="p">)</span>
					<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
						<span class="k">continue</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handled_rules</span><span class="p">(</span>
						<span class="p">(</span><span class="n">character_name</span><span class="p">,</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">dest_name</span><span class="p">),</span>
						<span class="n">rulebook</span><span class="p">,</span>
						<span class="n">branch</span><span class="p">,</span>
						<span class="n">turn</span><span class="p">,</span>
					<span class="p">)</span>
					<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">handled</span><span class="p">:</span>
							<span class="k">yield</span> <span class="p">(</span>
								<span class="n">prio</span><span class="p">,</span>
								<span class="n">character_name</span><span class="p">,</span>
								<span class="n">orig_name</span><span class="p">,</span>
								<span class="n">dest_name</span><span class="p">,</span>
								<span class="n">rulebook</span><span class="p">,</span>
								<span class="n">rule</span><span class="p">,</span>
							<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">was_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">origin</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">destination</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">was_handled</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ThingsCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]]</span>
<span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_make_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">thing_cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_slow_iter_contents</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">place</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span>
		<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span> <span class="o">==</span> <span class="n">place</span><span class="p">:</span>
				<span class="k">yield</span> <span class="n">thing</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_or_generate_contents</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">location</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_node_contents_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span>
				<span class="n">location</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn</span><span class="p">,</span>
				<span class="n">tick</span><span class="p">,</span>
				<span class="n">search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">OrderlyFrozenSet</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_slow_iter_contents</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
				<span class="p">)</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">location</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">planning</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">oldloc</span><span class="p">:</span> <span class="n">NodeName</span> <span class="o">|</span> <span class="o">...</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">oldloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="n">oldloc</span> <span class="o">=</span> <span class="o">...</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
				<span class="n">character</span><span class="p">,</span>
				<span class="n">thing</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn</span><span class="p">,</span>
				<span class="n">tick</span><span class="p">,</span>
				<span class="n">location</span><span class="p">,</span>
				<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
				<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
				<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
				<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">loading</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="n">node_contents_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_node_contents_cache</span>
			<span class="n">this</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">((</span><span class="n">thing</span><span class="p">,))</span>
			<span class="c1"># Cache the contents of nodes</span>
			<span class="n">todo</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">oldloc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="o">...</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">oldconts_orig</span> <span class="o">=</span> <span class="n">node_contents_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span>
						<span class="n">character</span><span class="p">,</span> <span class="n">oldloc</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
				<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
					<span class="n">oldconts_orig</span> <span class="o">=</span> <span class="n">OrderlyFrozenSet</span><span class="p">()</span>
				<span class="n">todo</span><span class="p">[</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
					<span class="p">(</span><span class="n">oldloc</span><span class="p">,</span> <span class="n">oldconts_orig</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
				<span class="p">)</span>
				<span class="c1"># update any future contents caches pertaining to the old location</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">oldloc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node_contents_cache</span><span class="o">.</span><span class="n">loc_settings</span><span class="p">:</span>
					<span class="n">locset</span> <span class="o">=</span> <span class="n">node_contents_cache</span><span class="o">.</span><span class="n">loc_settings</span><span class="p">[</span>
						<span class="n">character</span><span class="p">,</span> <span class="n">oldloc</span>
					<span class="p">][</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">locset</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">future_tick</span> <span class="ow">in</span> <span class="n">locset</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
							<span class="n">todo</span><span class="p">[</span><span class="n">turn</span><span class="p">,</span> <span class="n">future_tick</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="p">(</span>
									<span class="n">oldloc</span><span class="p">,</span>
									<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_or_generate_contents</span><span class="p">(</span>
										<span class="n">character</span><span class="p">,</span>
										<span class="n">oldloc</span><span class="p">,</span>
										<span class="n">branch</span><span class="p">,</span>
										<span class="n">turn</span><span class="p">,</span>
										<span class="n">future_tick</span><span class="p">,</span>
									<span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
								<span class="p">)</span>
							<span class="p">)</span>
					<span class="k">for</span> <span class="n">future_turn</span><span class="p">,</span> <span class="n">future_ticks</span> <span class="ow">in</span> <span class="n">locset</span><span class="o">.</span><span class="n">future</span><span class="p">(</span>
						<span class="n">turn</span>
					<span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">for</span> <span class="n">future_tick</span> <span class="ow">in</span> <span class="n">future_ticks</span><span class="p">:</span>
							<span class="n">todo</span><span class="p">[</span><span class="n">future_turn</span><span class="p">,</span> <span class="n">future_tick</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="p">(</span>
									<span class="n">oldloc</span><span class="p">,</span>
									<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_or_generate_contents</span><span class="p">(</span>
										<span class="n">character</span><span class="p">,</span>
										<span class="n">oldloc</span><span class="p">,</span>
										<span class="n">branch</span><span class="p">,</span>
										<span class="n">future_turn</span><span class="p">,</span>
										<span class="n">future_tick</span><span class="p">,</span>
									<span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
								<span class="p">)</span>
							<span class="p">)</span>
			<span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="o">...</span><span class="p">:</span>
				<span class="n">todo</span><span class="p">[</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
					<span class="p">(</span>
						<span class="n">location</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_or_generate_contents</span><span class="p">(</span>
							<span class="n">character</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
						<span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
					<span class="p">)</span>
				<span class="p">)</span>
				<span class="c1"># and the new location</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node_contents_cache</span><span class="o">.</span><span class="n">loc_settings</span><span class="p">:</span>
					<span class="n">locset</span> <span class="o">=</span> <span class="n">node_contents_cache</span><span class="o">.</span><span class="n">loc_settings</span><span class="p">[</span>
						<span class="n">character</span><span class="p">,</span> <span class="n">location</span>
					<span class="p">][</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">locset</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">future_tick</span> <span class="ow">in</span> <span class="n">locset</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
							<span class="n">todo</span><span class="p">[</span><span class="n">turn</span><span class="p">,</span> <span class="n">future_tick</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="p">(</span>
									<span class="n">location</span><span class="p">,</span>
									<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_or_generate_contents</span><span class="p">(</span>
										<span class="n">character</span><span class="p">,</span>
										<span class="n">location</span><span class="p">,</span>
										<span class="n">branch</span><span class="p">,</span>
										<span class="n">turn</span><span class="p">,</span>
										<span class="n">future_tick</span><span class="p">,</span>
									<span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
								<span class="p">)</span>
							<span class="p">)</span>
					<span class="k">for</span> <span class="n">future_turn</span><span class="p">,</span> <span class="n">future_ticks</span> <span class="ow">in</span> <span class="n">locset</span><span class="o">.</span><span class="n">future</span><span class="p">(</span>
						<span class="n">turn</span>
					<span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">for</span> <span class="n">future_tick</span> <span class="ow">in</span> <span class="n">future_ticks</span><span class="p">:</span>
							<span class="n">todo</span><span class="p">[</span><span class="n">future_turn</span><span class="p">,</span> <span class="n">future_tick</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="p">(</span>
									<span class="n">location</span><span class="p">,</span>
									<span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_or_generate_contents</span><span class="p">(</span>
										<span class="n">character</span><span class="p">,</span>
										<span class="n">location</span><span class="p">,</span>
										<span class="n">branch</span><span class="p">,</span>
										<span class="n">future_turn</span><span class="p">,</span>
										<span class="n">future_tick</span><span class="p">,</span>
									<span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
								<span class="p">)</span>
							<span class="p">)</span>
		<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">todo</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">conts</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">[</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">]:</span>
				<span class="n">node_contents_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">conts</span>
				<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeName</span><span class="p">:</span>
		<span class="n">retr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">retr</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Stored invalid location for thing&quot;</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">retr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">retr</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">turn_before</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[(</span><span class="n">character</span><span class="p">,)][</span><span class="n">thing</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">rev_before</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">turn_after</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[(</span><span class="n">character</span><span class="p">,)][</span><span class="n">thing</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">rev_after</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">thing_exists</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_entity_or_key</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="n">contains_entity</span> <span class="o">=</span> <span class="n">thing_exists</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_things</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>

	<span class="n">count_keys</span> <span class="o">=</span> <span class="n">count_things</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_things</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="o">*</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_entities_or_keys</span><span class="p">(</span>
			<span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="n">forward</span>
		<span class="p">)</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NodeContentsCache</span><span class="p">(</span>
	<span class="n">Cache</span><span class="p">[</span>
		<span class="n">CharName</span><span class="p">,</span>
		<span class="n">NodeName</span><span class="p">,</span>
		<span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">],</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]],</span>
	<span class="p">]</span>
<span class="p">):</span>
	<span class="n">overwrite_journal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">loc_settings</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
		<span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">factory</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">StructuredDefaultDict</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">),</span>
	<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">delete_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">plan_ticks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">]</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">world_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">trns</span> <span class="ow">in</span> <span class="n">plan_ticks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">times</span> <span class="o">=</span> <span class="n">trns</span><span class="o">.</span><span class="n">iter_times</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">start_turn</span><span class="p">,</span> <span class="n">start_tick</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_branch_end</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span>
						<span class="n">start_turn</span><span class="p">,</span>
						<span class="n">start_tick</span><span class="p">,</span>
					<span class="p">):</span>
						<span class="k">break</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">place</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">contents</span><span class="p">:</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">],</span>
		<span class="n">planning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">contra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">loc_settings</span><span class="p">[</span><span class="n">character</span><span class="p">,</span> <span class="n">place</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span>
			<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">contents</span>
		<span class="p">)</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span>
			<span class="n">place</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">contents</span><span class="p">,</span>
			<span class="n">planning</span><span class="o">=</span><span class="n">planning</span><span class="p">,</span>
			<span class="n">forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
			<span class="n">loading</span><span class="o">=</span><span class="n">loading</span><span class="p">,</span>
			<span class="n">contra</span><span class="o">=</span><span class="n">contra</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span>
			<span class="n">character</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_future_contradictions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">entity</span><span class="p">:</span> <span class="n">EntityKey</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span>
		<span class="n">turns</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_things_cache</span><span class="o">.</span><span class="n">_iter_future_contradictions</span><span class="p">(</span>
			<span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">turns</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delete data on or after this tick</span>

<span class="sd">		On the assumption that the future has been invalidated.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parents</span>  <span class="c1"># not how stuff is stored in this cache</span>
			<span class="k">for</span> <span class="n">branchkey</span><span class="p">,</span> <span class="n">branches</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
					<span class="n">branhc</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
						<span class="n">trun</span> <span class="o">=</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">trun</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">trun</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
						<span class="n">trun</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">trun</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="n">branhc</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">branches</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="n">branchkey</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">keykey</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">branchs</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
					<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branchs</span><span class="p">:</span>
						<span class="n">branhc</span> <span class="o">=</span> <span class="n">branchs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">branhc</span><span class="p">:</span>
							<span class="n">trun</span> <span class="o">=</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
							<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">trun</span><span class="p">:</span>
								<span class="k">del</span> <span class="n">trun</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
							<span class="n">trun</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
							<span class="k">if</span> <span class="ow">not</span> <span class="n">trun</span><span class="p">:</span>
								<span class="k">del</span> <span class="n">branhc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
						<span class="n">branhc</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">branhc</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">branchs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">branchs</span><span class="p">:</span>
						<span class="k">del</span> <span class="n">keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
					<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">keykey</span><span class="p">]</span>
			<span class="n">sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
				<span class="n">setsturn</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">setsturn</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">setsturn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
				<span class="n">setsturn</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">setsturn</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">sets</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="n">sets</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">sets</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="n">presets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">presets</span><span class="p">:</span>
				<span class="n">presetsturn</span> <span class="o">=</span> <span class="n">presets</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">presetsturn</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">presetsturn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
				<span class="n">presetsturn</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">presetsturn</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">presets</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="n">presets</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">presets</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">presettings</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">brnch</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">brnch</span> <span class="o">==</span> <span class="n">branch</span><span class="p">:</span>
					<span class="n">kc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">entity</span><span class="p">,</span> <span class="n">brnch</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">kc</span><span class="p">:</span>
						<span class="n">kcturn</span> <span class="o">=</span> <span class="n">kc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">kcturn</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">kcturn</span><span class="p">[</span><span class="n">tick</span><span class="p">]</span>
						<span class="n">kcturn</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">kcturn</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">kc</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
					<span class="n">kc</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">kc</span><span class="p">:</span>
						<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">keycache</span><span class="p">[</span><span class="n">entity</span><span class="p">,</span> <span class="n">brnch</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shallowest</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">NodeName</span><span class="p">,</span> <span class="n">OrderlyFrozenSet</span><span class="p">[</span><span class="n">NodeName</span><span class="p">]],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_keyframe</span><span class="p">((</span><span class="n">graph</span><span class="p">,),</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">keyframe</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Lisien</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#internals">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elide/index.html">Elide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;Zachary Spector.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>