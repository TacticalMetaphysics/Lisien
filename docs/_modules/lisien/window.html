<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lisien.window &#8212; Lisien 0.23.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=10ab35ec"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lisien.window</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Lisien, a framework for life simulation games.</span>
<span class="c1"># Copyright (c) Zachary Spector, public@zacharyspector.com</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;WindowDict, the core data structure used by allegedb&#39;s caching system.</span>

<span class="sd">It resembles a dictionary, more specifically a defaultdict-like where retrieving</span>
<span class="sd">a key that isn&#39;t set will get the highest set key that is lower than the key</span>
<span class="sd">you asked for (and thus, keys must be orderable). It is optimized for retrieval</span>
<span class="sd">of the same key and neighboring ones repeatedly and in sequence.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">ItemsView</span><span class="p">,</span>
	<span class="n">KeysView</span><span class="p">,</span>
	<span class="n">Mapping</span><span class="p">,</span>
	<span class="n">MutableMapping</span><span class="p">,</span>
	<span class="n">ValuesView</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">ge</span><span class="p">,</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">le</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">RLock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">Any</span><span class="p">,</span>
	<span class="n">Callable</span><span class="p">,</span>
	<span class="n">ClassVar</span><span class="p">,</span>
	<span class="n">Iterable</span><span class="p">,</span>
	<span class="n">Iterator</span><span class="p">,</span>
	<span class="n">Protocol</span><span class="p">,</span>
	<span class="n">Sequence</span><span class="p">,</span>
	<span class="n">TypeVar</span><span class="p">,</span>
	<span class="n">Union</span><span class="p">,</span>
	<span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">attrs</span><span class="w"> </span><span class="kn">import</span> <span class="n">define</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Direction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">HistoricKeyError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">Branch</span><span class="p">,</span>
	<span class="n">LinearTime</span><span class="p">,</span>
	<span class="n">PickierDefaultDict</span><span class="p">,</span>
	<span class="n">Tick</span><span class="p">,</span>
	<span class="n">Turn</span><span class="p">,</span>
	<span class="n">Value</span><span class="p">,</span>
	<span class="n">ValueHint</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">get0</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">get1</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="UpdateFunctionProtocol">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.UpdateFunctionProtocol">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UpdateFunctionProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span></div>



<div class="viewcode-block" id="update_window">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.update_window">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_window</span><span class="p">(</span>
	<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
	<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
	<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="n">updfun</span><span class="p">:</span> <span class="n">UpdateFunctionProtocol</span><span class="p">,</span>
	<span class="n">branchd</span><span class="p">:</span> <span class="n">AssignmentTimeDict</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Iterate over some time in ``branchd``, call ``updfun`` on the values&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">turn_from</span> <span class="o">==</span> <span class="n">turn_to</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">turn_from</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
			<span class="n">branchd</span><span class="p">[</span><span class="n">turn_from</span><span class="p">]</span>
			<span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="n">tick</span> <span class="o">&gt;</span> <span class="n">tick_to</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="n">updfun</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="k">if</span> <span class="n">turn_from</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
			<span class="n">branchd</span><span class="p">[</span><span class="n">turn_from</span><span class="p">]</span>
			<span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="n">updfun</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
	<span class="n">midturn</span><span class="p">:</span> <span class="n">Turn</span>
	<span class="k">for</span> <span class="n">midturn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">turn_from</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">midturn</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">[</span><span class="n">midturn</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">updfun</span><span class="p">(</span><span class="n">midturn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">[</span><span class="n">turn_to</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">tick</span> <span class="o">&gt;</span> <span class="n">tick_to</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="n">updfun</span><span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_backward_window">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.update_backward_window">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_backward_window</span><span class="p">(</span>
	<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
	<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
	<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="n">updfun</span><span class="p">:</span> <span class="n">UpdateFunctionProtocol</span><span class="p">,</span>
	<span class="n">branchd</span><span class="p">:</span> <span class="n">AssignmentTimeDict</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Iterate backward over time in ``branchd``, call ``updfun`` on the values&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">turn_from</span> <span class="o">==</span> <span class="n">turn_to</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">turn_from</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
			<span class="n">branchd</span><span class="p">[</span><span class="n">turn_from</span><span class="p">]</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="k">if</span> <span class="n">tick</span> <span class="o">&lt;=</span> <span class="n">tick_to</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="n">updfun</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="k">if</span> <span class="n">turn_from</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
			<span class="n">branchd</span><span class="p">[</span><span class="n">turn_from</span><span class="p">]</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="n">updfun</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
	<span class="n">midturn</span><span class="p">:</span> <span class="n">Turn</span>
	<span class="k">for</span> <span class="n">midturn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">turn_from</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">midturn</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">branchd</span><span class="p">[</span><span class="n">midturn</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="n">updfun</span><span class="p">(</span><span class="n">midturn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">in</span> <span class="n">branchd</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span>
			<span class="n">branchd</span><span class="p">[</span><span class="n">turn_to</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick_to</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="n">updfun</span><span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span></div>



<div class="viewcode-block" id="WindowDictKeysView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictKeysView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictKeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">](</span><span class="n">KeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Look through all the keys a WindowDict contains.&quot;&quot;&quot;</span>

	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">rev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_keys</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span>
			<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="n">past</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">future</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span>
			<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="n">future</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">past</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;WindowDictKeysView containing </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div>



<div class="viewcode-block" id="WindowDictItemsView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictItemsView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">](</span><span class="n">ItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Look through everything a WindowDict contains.&quot;&quot;&quot;</span>

	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span>
			<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="n">past</span>
			<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span>
			<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="n">future</span>
			<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">past</span><span class="p">)</span></div>



<div class="viewcode-block" id="WindowDictPastKeysView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastKeysView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictPastKeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">](</span><span class="n">KeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;View on a WindowDict&#39;s keys relative to last lookup&quot;&quot;&quot;</span>

	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDictPastView</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span></div>



<div class="viewcode-block" id="WindowDictFutureKeysView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictFutureKeysView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictFutureKeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">](</span><span class="n">KeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">]):</span>
	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDictFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span></div>



<div class="viewcode-block" id="WindowDictPastFutureItemsView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastFutureItemsView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictPastFutureItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span><span class="n">ItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDictPastView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">|</span> <span class="n">WindowDictFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>

	<span class="nd">@staticmethod</span>
	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_out_of_range</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">],</span> <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_of_range</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
				<span class="k">return</span> <span class="kc">False</span>
			<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">item</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span></div>



<div class="viewcode-block" id="WindowDictPastItemsView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastItemsView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictPastItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span>
	<span class="n">WindowDictPastFutureItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>
<span class="p">):</span>
	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_out_of_range</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
		<span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="WindowDictFutureItemsView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictFutureItemsView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictFutureItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span>
	<span class="n">WindowDictPastFutureItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;View on a WindowDict&#39;s future items relative to last lookup&quot;&quot;&quot;</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_out_of_range</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">],</span> <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]):</span>
		<span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="WindowDictPastFutureValuesView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastFutureValuesView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictPastFutureValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span><span class="n">ValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Abstract class for views on the past or future values of a WindowDict&quot;&quot;&quot;</span>

	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDictPastView</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">|</span> <span class="n">WindowDictFutureView</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">_V</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span></div>



<div class="viewcode-block" id="WindowDictValuesView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictValuesView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span><span class="n">ValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Look through all the values that a WindowDict contains.&quot;&quot;&quot;</span>

	<span class="n">_mapping</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_V</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
				<span class="n">get1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span>
			<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="n">past</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">future</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_past</span>
			<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="o">.</span><span class="n">_future</span>
			<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="n">future</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">past</span><span class="p">))</span></div>



<div class="viewcode-block" id="WindowDictPastFutureView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastFutureView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictPastFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Abstract class for historical views on WindowDict&quot;&quot;&quot;</span>

	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span> <span class="s2">&quot;lock&quot;</span><span class="p">)</span>
	<span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]],</span> <span class="n">lock</span><span class="p">:</span> <span class="n">RLock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
				<span class="k">return</span> <span class="mi">0</span>
			<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">RLock</span><span class="p">())</span></div>



<div class="viewcode-block" id="WindowDictPastView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictPastView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span><span class="n">WindowDictPastFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Read-only mapping of just the past of a WindowDict</span>

<span class="sd">	Iterates in descending order</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_V</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">&gt;</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Out of range&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">_recurse</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">stack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="WindowDictPastView.keys">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastView.keys">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictPastKeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictPastKeysView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDictPastView.items">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastView.items">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictPastItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictPastItemsView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDictPastView.values">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictPastView.values">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictPastFutureValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictPastFutureValuesView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="WindowDictFutureView">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictFutureView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">](</span>
	<span class="n">WindowDictPastFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Read-only mapping of just the future of a WindowDict</span>

<span class="sd">	Iterates in ascending order</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_K</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No data&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">&gt;</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No such revision&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">_recurse</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">stack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="WindowDictFutureView.keys">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictFutureView.keys">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictFutureKeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictFutureKeysView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDictFutureView.items">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictFutureView.items">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictFutureItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictFutureItemsView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDictFutureView.values">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictFutureView.values">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictPastFutureValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictPastFutureValuesView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="WindowDictSlice">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDictSlice">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDictSlice</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">Value</span><span class="p">]:</span>
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dic&quot;</span><span class="p">,</span> <span class="s2">&quot;slic&quot;</span><span class="p">]</span>
	<span class="n">dic</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span>
	<span class="n">slic</span><span class="p">:</span> <span class="nb">slice</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dic</span><span class="p">:</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">],</span> <span class="n">slic</span><span class="p">:</span> <span class="nb">slice</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="o">=</span> <span class="n">dic</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">slic</span> <span class="o">=</span> <span class="n">slic</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">slic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slic</span>
			<span class="k">if</span> <span class="n">slic</span><span class="o">.</span><span class="n">step</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_iter</span><span class="p">()</span>
			<span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modulo</span><span class="p">(</span><span class="n">slic</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slic</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
				<span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_iterator_stepless_reversed</span><span class="p">(</span>
					<span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">include_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_stop</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_iterator_stepless</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">slic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slic</span>
			<span class="k">if</span> <span class="n">slic</span><span class="o">.</span><span class="n">step</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_iter_reversed</span><span class="p">()</span>
			<span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modulo</span><span class="p">(</span><span class="n">slic</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slic</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
				<span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_iterator_stepless</span><span class="p">(</span>
					<span class="n">stop</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">include_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_stop</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_item_iterator_stepless_reversed</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">get1</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_step_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span>
		<span class="n">slic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slic</span>
		<span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modulo</span><span class="p">(</span><span class="n">slic</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slic</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">slic</span><span class="o">.</span><span class="n">step</span><span class="p">):</span>
			<span class="k">yield</span> <span class="n">dic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_step_iter_reversed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span>
		<span class="n">slic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slic</span>
		<span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modulo</span><span class="p">(</span><span class="n">slic</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">slic</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">slic</span><span class="o">.</span><span class="n">step</span><span class="p">)):</span>
			<span class="k">yield</span> <span class="n">dic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_items_until</span><span class="p">(</span>
		<span class="n">it</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]],</span>
		<span class="n">until</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_K</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
		<span class="n">include_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">if</span> <span class="n">include_last</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">rev</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
				<span class="k">yield</span> <span class="n">rev</span><span class="p">,</span> <span class="n">val</span>
				<span class="k">if</span> <span class="n">until</span><span class="p">(</span><span class="n">rev</span><span class="p">):</span>
					<span class="k">return</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">rev</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">until</span><span class="p">(</span><span class="n">rev</span><span class="p">):</span>
					<span class="k">return</span>
				<span class="k">yield</span> <span class="n">rev</span><span class="p">,</span> <span class="n">val</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_past_items_until</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span>
		<span class="n">until</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_K</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
		<span class="n">include_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_items_until</span><span class="p">(</span>
			<span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">until</span><span class="p">,</span> <span class="n">include_last</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_future_items_until</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span>
		<span class="n">until</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_K</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
		<span class="n">include_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_items_until</span><span class="p">(</span>
			<span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">until</span><span class="p">,</span> <span class="n">include_last</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_modulo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">_K</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">_K</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_K</span><span class="p">]:</span>
		<span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span>
		<span class="n">biggest</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="n">dic</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
			<span class="n">biggest</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">elif</span> <span class="n">dic</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
			<span class="n">biggest</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">elif</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">biggest</span> <span class="o">+</span> <span class="n">start</span>
			<span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;WindowDict index out of range&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">stop</span> <span class="o">=</span> <span class="n">biggest</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="k">elif</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">stop</span> <span class="o">=</span> <span class="n">biggest</span> <span class="o">+</span> <span class="n">stop</span>
			<span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;WindowDict index out of range&quot;</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_item_iterator_stepless_reversed</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">start</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span>
		<span class="n">stop</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span>
		<span class="n">include_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">include_stop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start should come before stop&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
		<span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="n">seek</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_seek</span>
		<span class="n">past</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_past</span>
		<span class="n">future</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_future</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">past</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">future</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
			<span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">past</span> <span class="ow">and</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">iter</span><span class="p">((</span><span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="n">seek</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">include_stop</span> <span class="ow">and</span> <span class="n">past</span> <span class="ow">and</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span>
			<span class="n">future</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">past</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_items_until</span><span class="p">(</span>
			<span class="nb">reversed</span><span class="p">(</span><span class="n">past</span><span class="p">),</span> <span class="n">partial</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span> <span class="n">include_last</span><span class="o">=</span><span class="n">include_start</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_item_iterator_stepless</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">start</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span>
		<span class="n">stop</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span>
		<span class="n">include_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
		<span class="n">include_stop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start should come before stop&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
		<span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="n">seek</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_seek</span>
		<span class="n">past</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_past</span>
		<span class="n">future</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">_future</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">past</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">future</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
			<span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">past</span> <span class="ow">and</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">iter</span><span class="p">((</span><span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_future_items_until</span><span class="p">(</span>
			<span class="n">start</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">le</span><span class="p">,</span> <span class="n">stop</span><span class="p">),</span> <span class="n">include_last</span><span class="o">=</span><span class="n">include_stop</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="n">include_start</span> <span class="ow">and</span> <span class="n">past</span> <span class="ow">and</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">chain</span><span class="p">((</span><span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],),</span> <span class="n">it</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">it</span></div>



<span class="n">_RK</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_RK&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">_RV</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_RV&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Value</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_recurse</span><span class="p">(</span><span class="n">rev</span><span class="p">:</span> <span class="n">_RK</span><span class="p">,</span> <span class="n">revs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_RK</span><span class="p">,</span> <span class="n">_RV</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_RK</span><span class="p">,</span> <span class="n">_RV</span><span class="p">]:</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">revs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span><span class="s2">&quot;No data ever for revision&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">revs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">revs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rev</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">revs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t retrieve revision&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">pivot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">revs</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
	<span class="n">before</span> <span class="o">=</span> <span class="n">revs</span><span class="p">[:</span><span class="n">pivot</span><span class="p">]</span>
	<span class="n">after</span> <span class="o">=</span> <span class="n">revs</span><span class="p">[</span><span class="n">pivot</span><span class="p">:]</span>
	<span class="k">assert</span> <span class="n">before</span> <span class="ow">and</span> <span class="n">after</span>
	<span class="k">if</span> <span class="n">rev</span> <span class="o">&lt;</span> <span class="n">after</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
		<span class="k">if</span> <span class="n">rev</span> <span class="o">&gt;</span> <span class="n">before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
			<span class="k">return</span> <span class="n">before</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">_recurse</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">before</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">rev</span> <span class="o">==</span> <span class="n">after</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">after</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">_recurse</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>


<div class="viewcode-block" id="WindowDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="n">ValueHint</span> <span class="o">|</span> <span class="n">WindowDict</span><span class="p">](</span><span class="n">MutableMapping</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A dict that keeps every value that a variable has had over time.</span>

<span class="sd">	Look up a revision number in this dict, and it will give you the</span>
<span class="sd">	effective value as of that revision. Keys should always be</span>
<span class="sd">	revision numbers.</span>

<span class="sd">	Optimized for the cases where you look up the same revision</span>
<span class="sd">	repeatedly, or its neighbors.</span>

<span class="sd">	This supports slice notation to get all values in a given</span>
<span class="sd">	time-frame. If you do not supply a step, you&#39;ll just get the</span>
<span class="sd">	values, with no indication of exactly when they&#39;re from.</span>
<span class="sd">	Specify a step of 1 to get the value at each point in</span>
<span class="sd">	the slice, or use the :meth:`future` and :meth:`past` methods to get read-only</span>
<span class="sd">	mappings of data relative to a particular revision.</span>

<span class="sd">	Unlike slices of e.g. lists, you can slice with a start greater than the stop</span>
<span class="sd">	even if you don&#39;t supply a step. That will get you values in reverse order.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_past</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="p">[]</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_future</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="p">[]</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RLock</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">RLock</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">beginning</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_K</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
					<span class="k">return</span> <span class="kc">None</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_K</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
					<span class="k">return</span> <span class="kc">None</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="WindowDict.future">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.future">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">future</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictFutureView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return a Mapping of items after the given revision.</span>

<span class="sd">		:param include_same_rev: Whether to include the specified revision in</span>
<span class="sd">			the Mapping, if present in the `WindowDict`. `False` by default.</span>
<span class="sd">		:param copy: Whether to make a copy of the data, so that the Mapping</span>
<span class="sd">			won&#39;t mutate when you access the underlying `WindowDict`. Default</span>
<span class="sd">			`False`. The Mapping has a `copy` method, too.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;rev must be int&quot;</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">include_same_rev</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rev</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
			<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
				<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">WindowDictFutureView</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDict.past">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.past">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">past</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictPastView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return a Mapping of items at or before the given revision.</span>

<span class="sd">		:param include_same_rev: Whether to include the specified revision in</span>
<span class="sd">			the Mapping, if present in the `WindowDict`. `True` by default.</span>
<span class="sd">		:param copy: Whether to make a copy of the data, so that the Mapping</span>
<span class="sd">			won&#39;t mutate when you access the underlying `WindowDict`. Default</span>
<span class="sd">			`False`. The Mapping has a `copy` method, too.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;rev must be int&quot;</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="ow">not</span> <span class="n">include_same_rev</span>
				<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span>
				<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rev</span>
			<span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
			<span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
				<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span>
				<span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span>
		<span class="k">return</span> <span class="n">WindowDictPastView</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDict.search">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.search">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_V</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Alternative access for far-away revisions</span>

<span class="sd">		This uses a binary search, which is faster in the case of random</span>
<span class="sd">		access, but not in the case of fast-forward and rewind, which are</span>
<span class="sd">		more common in time travel.</span>

<span class="sd">		This doesn&#39;t change the state of the cache.</span>

<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">revs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">))</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">revs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">result_rev</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">revs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">rev</span> <span class="o">&lt;</span> <span class="n">result_rev</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span>
						<span class="s2">&quot;No data ever for revision&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">False</span>
					<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">result_rev</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_recurse</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">revs</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">_seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Arrange the caches to help look up the given revision.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Need integer revision&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span>
		<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span>
		<span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span>
		<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
			<span class="n">appender</span> <span class="o">=</span> <span class="n">past</span><span class="o">.</span><span class="n">append</span>
			<span class="n">popper</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">pop</span>
			<span class="n">future_start</span> <span class="o">=</span> <span class="n">future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">while</span> <span class="n">future_start</span> <span class="o">&lt;=</span> <span class="n">rev</span><span class="p">:</span>
				<span class="n">appender</span><span class="p">(</span><span class="n">popper</span><span class="p">())</span>
				<span class="k">if</span> <span class="n">future</span><span class="p">:</span>
					<span class="n">future_start</span> <span class="o">=</span> <span class="n">future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">break</span>
		<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
			<span class="n">popper</span> <span class="o">=</span> <span class="n">past</span><span class="o">.</span><span class="n">pop</span>
			<span class="n">appender</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">append</span>
			<span class="n">past_end</span> <span class="o">=</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">while</span> <span class="n">past_end</span> <span class="o">&gt;</span> <span class="n">rev</span><span class="p">:</span>
				<span class="n">appender</span><span class="p">(</span><span class="n">popper</span><span class="p">())</span>
				<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
					<span class="n">past_end</span> <span class="o">=</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">break</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rev_gettable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="n">beg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span>
		<span class="k">if</span> <span class="n">beg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>
		<span class="k">return</span> <span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">beg</span>

<div class="viewcode-block" id="WindowDict.rev_before">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.rev_before">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">rev_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_K</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the latest past rev on which the value changed.</span>

<span class="sd">		If it changed on this exact rev, return the rev.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">search</span><span class="p">:</span>
				<span class="n">rev</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_recurse</span><span class="p">(</span>
					<span class="n">rev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">))</span>
				<span class="p">)</span>
				<span class="k">return</span> <span class="n">rev</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
					<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="WindowDict.rev_after">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.rev_after">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">rev_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_K</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the earliest future rev on which the value will change.&quot;&quot;&quot;</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="WindowDict.initial">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.initial">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_V</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the earliest value we have&quot;&quot;&quot;</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No data&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDict.final">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.final">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">final</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_V</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the latest value we have&quot;&quot;&quot;</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No data&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDict.truncate">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.truncate">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">truncate</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="o">.</span><span class="n">FORWARD</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delete everything after the given revision, exclusive.</span>

<span class="sd">		With direction=&#39;backward&#39;, delete everything before the revision,</span>
<span class="sd">		exclusive, instead.</span>

<span class="sd">		Return a set of keys deleted.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">Direction</span><span class="p">):</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="n">Direction</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
		<span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">:</span>
				<span class="n">to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">))</span>
				<span class="n">deleted</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">BACKWARD</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">deleted</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rev</span><span class="p">:</span>
					<span class="n">to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
					<span class="n">deleted</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
					<span class="n">past1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">past1</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">))</span>
					<span class="n">deleted</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need direction &#39;forward&#39; or &#39;backward&#39;&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">deleted</span></div>


<div class="viewcode-block" id="WindowDict.keys">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.keys">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictKeysView</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictKeysView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDict.items">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.items">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictItemsView</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictItemsView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WindowDict.values">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.WindowDict.values">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictValuesView</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">WindowDictValuesView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


	<span class="k">def</span><span class="w"> </span><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">empty</span> <span class="o">=</span> <span class="n">WindowDict</span><span class="p">()</span>
			<span class="n">empty</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">)</span>
			<span class="n">empty</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">)</span>
			<span class="n">empty</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">empty</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
						<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Integer keys only&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
						<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Integer keys only&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">data</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">get0</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">)</span>

	<span class="nd">@overload</span>
	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="nb">slice</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDictSlice</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@overload</span>
	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_V</span><span class="p">:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="o">/</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">WindowDictSlice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">past</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span>
					<span class="s2">&quot;Revision </span><span class="si">{}</span><span class="s2"> is before the start of history&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
				<span class="p">)</span>
			<span class="k">return</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">past</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">past</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rev</span><span class="p">:</span>
						<span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rev</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rev</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">past</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rev</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1"># Not checking for rev&#39;s presence at the beginning because</span>
		<span class="c1"># to do so would likely require iterating thru history,</span>
		<span class="c1"># which I have to do anyway in deleting.</span>
		<span class="c1"># But handle degenerate case.</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span><span class="s2">&quot;Tried to delete from an empty WindowDict&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rev</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span>
					<span class="s2">&quot;Rev outside of history: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
				<span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rev</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span>
					<span class="s2">&quot;Rev outside of history: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
				<span class="p">)</span>
		<span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span> <span class="o">&lt;=</span> <span class="n">rev</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span><span class="s2">&quot;Rev outside of history: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rev</span><span class="p">))</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_seek</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
			<span class="n">past</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">past</span> <span class="ow">or</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rev</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">HistoricKeyError</span><span class="p">(</span><span class="s2">&quot;Rev not present: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rev</span><span class="p">))</span>
			<span class="k">del</span> <span class="n">past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">me</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
				<span class="n">me</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
				<span class="n">me</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">)</span>
			<span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span></div>



<div class="viewcode-block" id="LinearTimeListDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.LinearTimeListDict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LinearTimeListDict</span><span class="p">(</span><span class="n">WindowDict</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tick</span><span class="p">]]):</span>
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tick</span><span class="p">]]</span>
		<span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tick</span><span class="p">]]]</span>
		<span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="n">it</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Dict of ints only&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(())</span>
		<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">ticks</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;int keys only&quot;</span><span class="p">,</span> <span class="n">turn</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lists of ints only&quot;</span><span class="p">,</span> <span class="n">ticks</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lists of ints only&quot;</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">Turn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tick</span><span class="p">]:</span>
		<span class="k">if</span> <span class="n">rev</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">default</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">default</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tick</span><span class="p">]):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;lists of ticks only&quot;</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">insert_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="n">ticks</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Already present&quot;</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="n">before</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">while</span> <span class="n">ticks</span><span class="p">:</span>
				<span class="n">after</span> <span class="o">=</span> <span class="n">ticks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">after</span> <span class="o">&gt;</span> <span class="n">tick</span><span class="p">:</span>
					<span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">+</span> <span class="p">[</span><span class="n">tick</span><span class="p">,</span> <span class="n">after</span><span class="p">]</span> <span class="o">+</span> <span class="n">ticks</span>
					<span class="k">return</span>
				<span class="n">before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
			<span class="n">before</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tick</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_times</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]:</span>
		<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">tick_set</span><span class="p">:</span>
				<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span></div>



<div class="viewcode-block" id="BranchingTimeListDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.BranchingTimeListDict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BranchingTimeListDict</span><span class="p">(</span><span class="n">PickierDefaultDict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">LinearTimeListDict</span><span class="p">]):</span>
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">data</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tick</span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">value_type</span><span class="o">=</span><span class="n">LinearTimeListDict</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dict only&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turns</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearTimeListDict</span><span class="p">(</span><span class="n">turns</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinearTimeListDict</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">LinearTimeListDict</span><span class="p">()</span>
			<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">LinearTimeListDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t make LinearTimeListDict out of this&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">LinearTimeListDict</span><span class="p">):</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">LinearTimeListDict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># may raise TypeError. Ok.</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="EntikeyWindowDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.EntikeyWindowDict">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EntikeyWindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_V</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">](</span><span class="n">WindowDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">entikeys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">_V</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]</span> <span class="o">|</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">entikeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">entikeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">_V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">entikeys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rev</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">entikey</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">rev</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">tup</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">entikey</span><span class="p">:</span>
				<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">entikeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entikey</span><span class="p">)</span></div>



<div class="viewcode-block" id="SettingsTimes">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.SettingsTimes">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SettingsTimes</span><span class="p">(</span><span class="n">Iterable</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]):</span>
	<span class="n">td</span><span class="p">:</span> <span class="n">AssignmentTimeDict</span>
	<span class="n">time_from</span><span class="p">:</span> <span class="n">LinearTime</span> <span class="o">|</span> <span class="kc">None</span>
	<span class="n">time_to</span><span class="p">:</span> <span class="n">LinearTime</span> <span class="o">|</span> <span class="kc">None</span>
	<span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_reverse</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_forward</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">SettingsTimes</span><span class="p">(</span>
			<span class="n">td</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">,</span>
			<span class="n">time_from</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_from</span><span class="p">,</span>
			<span class="n">time_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_to</span><span class="p">,</span>
			<span class="n">reverse</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]:</span>
		<span class="n">time_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_from</span>
		<span class="n">time_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_to</span>
		<span class="k">if</span> <span class="n">time_from</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">time_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">tcks</span><span class="p">:</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">time_from</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="o">=</span> <span class="n">time_to</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">trn</span> <span class="o">&gt;=</span> <span class="n">turn_to</span><span class="p">:</span>
					<span class="k">break</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">tcks</span><span class="p">:</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">[</span><span class="n">turn_to</span><span class="p">]:</span>
					<span class="k">if</span> <span class="n">tck</span> <span class="o">&gt;=</span> <span class="n">tick_to</span><span class="p">:</span>
						<span class="k">return</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">time_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span> <span class="o">=</span> <span class="n">time_from</span>
			<span class="k">if</span> <span class="n">turn_from</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">[</span><span class="n">turn_from</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span>
					<span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">):</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">future</span><span class="p">(</span>
				<span class="n">turn_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span>
			<span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">tcks</span><span class="p">:</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span> <span class="o">=</span> <span class="n">time_from</span>
			<span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="o">=</span> <span class="n">time_to</span>
			<span class="k">if</span> <span class="n">turn_from</span> <span class="o">==</span> <span class="n">turn_to</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">:</span>
					<span class="k">return</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">[</span><span class="n">turn_to</span><span class="p">]</span><span class="o">.</span><span class="n">future</span><span class="p">(</span>
					<span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">):</span>
					<span class="k">if</span> <span class="n">tck</span> <span class="o">&gt;</span> <span class="n">tick_to</span><span class="p">:</span>
						<span class="k">return</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">trn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">trn</span> <span class="o">&gt;</span> <span class="n">turn_to</span><span class="p">:</span>
						<span class="k">return</span>
					<span class="k">elif</span> <span class="n">trn</span> <span class="o">==</span> <span class="n">turn_to</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">[</span><span class="n">trn</span><span class="p">]</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">tick_to</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
						<span class="p">):</span>
							<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">[</span><span class="n">trn</span><span class="p">]:</span>
							<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">LinearTime</span><span class="p">]:</span>
		<span class="n">time_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_from</span>
		<span class="n">time_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_to</span>
		<span class="k">if</span> <span class="n">time_from</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">time_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">tcks</span><span class="p">):</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">time_from</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="o">=</span> <span class="n">time_to</span>
			<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="p">[</span><span class="n">turn_to</span><span class="p">]</span><span class="o">.</span><span class="n">past</span><span class="p">(</span>
					<span class="n">tick_to</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">):</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">past</span><span class="p">(</span>
				<span class="n">turn_to</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">False</span>
			<span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">tcks</span><span class="p">):</span>
					<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>

		<span class="k">elif</span> <span class="n">time_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span> <span class="o">=</span> <span class="n">time_from</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">):</span>
				<span class="k">if</span> <span class="n">trn</span> <span class="o">==</span> <span class="n">turn_from</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span>
						<span class="n">tcks</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="p">):</span>
						<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">tcks</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
						<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span> <span class="o">=</span> <span class="n">time_from</span>
			<span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="o">=</span> <span class="n">time_to</span>
			<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tcks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">td</span><span class="o">.</span><span class="n">past</span><span class="p">(</span>
				<span class="n">turn_to</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span>
			<span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">trn</span> <span class="o">==</span> <span class="n">turn_to</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="n">tcks</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">tick_to</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
						<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">trn</span> <span class="o">==</span> <span class="n">turn_from</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span>
						<span class="n">tcks</span><span class="o">.</span><span class="n">future</span><span class="p">(</span><span class="n">tick_from</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="p">):</span>
						<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">trn</span> <span class="o">&lt;</span> <span class="n">turn_from</span><span class="p">:</span>
					<span class="k">return</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">tcks</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
						<span class="k">yield</span> <span class="n">LinearTime</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span></div>



<div class="viewcode-block" id="AssignmentTimeDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.AssignmentTimeDict">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AssignmentTimeDict</span><span class="p">[</span><span class="n">_VV</span><span class="p">](</span><span class="n">WindowDict</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">_VV</span><span class="p">]]):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A WindowDict that contains a span of time, indexed as turns and ticks</span>

<span class="sd">	Each turn is a series of ticks. Once a value is set at some turn and tick,</span>
<span class="sd">	it&#39;s in effect at every tick in the turn after that one, and every</span>
<span class="sd">	further turn.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

	<span class="bp">cls</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">WindowDict</span><span class="p">]]</span> <span class="o">=</span> <span class="n">WindowDict</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_future</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">_VV</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="p">[]</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_past</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">_VV</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="p">[]</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">Turn</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">):</span>
					<span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;AssignmentTimeDict(</span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WindowDict</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">_VV</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="bp">cls</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">):</span>
			<span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="AssignmentTimeDict.retrieve">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.AssignmentTimeDict.retrieve">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Retrieve the value that was in effect at this turn and tick</span>

<span class="sd">		Whether or not it was *set* at this turn and tick</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">turn_before</span> <span class="o">=</span> <span class="n">Turn</span><span class="p">(</span><span class="n">turn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rev_gettable</span><span class="p">(</span><span class="n">turn_before</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">turn_before</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">()</span>
		<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t retrieve turn </span><span class="si">{</span><span class="n">turn</span><span class="si">}</span><span class="s2">, tick </span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AssignmentTimeDict.retrieve_exact">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.AssignmentTimeDict.retrieve_exact">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">retrieve_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_VV</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Retrieve the value only if it was set at this exact turn and tick&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data in turn </span><span class="si">{</span><span class="n">turn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tick</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data for tick </span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2"> in turn </span><span class="si">{</span><span class="n">turn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span></div>


<div class="viewcode-block" id="AssignmentTimeDict.store_at">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.AssignmentTimeDict.store_at">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">store_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_VV</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Set a value at a time, creating the turn if needed&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">tick</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span></div>


	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">beginning</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="kc">None</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_past</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="kc">None</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">beginning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span><span class="o">.</span><span class="n">beginning</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">()</span><span class="o">.</span><span class="n">end</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">iter_times</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">time_from</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">time_to</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SettingsTimes</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">SettingsTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_from</span><span class="p">,</span> <span class="n">time_to</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span></div>



<div class="viewcode-block" id="EntikeySettingsTurnDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.window.EntikeySettingsTurnDict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EntikeySettingsTurnDict</span><span class="p">[</span><span class="n">_T</span><span class="p">](</span><span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
	<span class="bp">cls</span> <span class="o">=</span> <span class="n">EntikeyWindowDict</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Lisien</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#internals">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elide/index.html">Elide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;Zachary Spector.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>