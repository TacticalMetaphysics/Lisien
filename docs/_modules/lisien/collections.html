<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lisien.collections &#8212; Lisien 0.23.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=10ab35ec"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lisien.collections</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Lisien, a framework for life simulation games.</span>
<span class="c1"># Copyright (c) Zachary Spector, public@zacharyspector.com</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;Common classes for collections in lisien</span>

<span class="sd">Most of these are subclasses of :class:`blinker.Signal`, so you can listen</span>
<span class="sd">for changes using the ``connect(..)`` method.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hashlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">blake2b</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">getsource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">attrs</span><span class="w"> </span><span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blinker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Signal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">AbstractEngine</span><span class="p">,</span>
	<span class="n">AbstractFunctionStore</span><span class="p">,</span>
	<span class="n">AbstractLanguageDescriptor</span><span class="p">,</span>
	<span class="n">AbstractStringStore</span><span class="p">,</span>
	<span class="n">ActionFunc</span><span class="p">,</span>
	<span class="n">ActionFuncName</span><span class="p">,</span>
	<span class="n">AttrSignal</span><span class="p">,</span>
	<span class="n">CharName</span><span class="p">,</span>
	<span class="n">KeyHint</span><span class="p">,</span>
	<span class="n">PrereqFunc</span><span class="p">,</span>
	<span class="n">PrereqFuncName</span><span class="p">,</span>
	<span class="n">Stat</span><span class="p">,</span>
	<span class="n">TriggerFunc</span><span class="p">,</span>
	<span class="n">TriggerFuncName</span><span class="p">,</span>
	<span class="n">UniversalKey</span><span class="p">,</span>
	<span class="n">Value</span><span class="p">,</span>
	<span class="n">ValueHint</span><span class="p">,</span>
	<span class="n">sort_set</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">dedent_source</span><span class="p">,</span> <span class="n">getatt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.wrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrapval</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">.character</span><span class="w"> </span><span class="kn">import</span> <span class="n">Character</span>


<span class="c1"># 0x241d is the group separator</span>
<span class="c1"># 0x241e is the record separator</span>
<span class="c1"># per Unicode 1.1</span>
<span class="n">GROUP_SEP</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x241D</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="n">REC_SEP</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x241E</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>


<div class="viewcode-block" id="LanguageDescriptor">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.LanguageDescriptor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LanguageDescriptor</span><span class="p">(</span><span class="n">AbstractLanguageDescriptor</span><span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_get_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">:</span> <span class="n">StringStore</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">_current_language</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="n">inst</span><span class="o">.</span><span class="n">_current_language</span><span class="p">:</span>
			<span class="n">inst</span><span class="o">.</span><span class="n">_switch_language</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;_worker&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
				<span class="ow">and</span> <span class="n">inst</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lang</span>
			<span class="p">):</span>
				<span class="n">inst</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span>
			<span class="n">inst</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">=</span> <span class="n">lang</span></div>



<div class="viewcode-block" id="TamperEvidentDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.TamperEvidentDict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TamperEvidentDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">](</span><span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
	<span class="n">tampered</span><span class="p">:</span> <span class="nb">bool</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">=</span> <span class="p">()):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>



<div class="viewcode-block" id="ChangeTrackingDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.ChangeTrackingDict">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChangeTrackingDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">](</span><span class="n">UserDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]):</span>
	<span class="n">changed</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__attrs_pre_init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">apply_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">]:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
		<span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="ChangeTrackingDict.clear">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.ChangeTrackingDict.clear">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_K</span><span class="p">]:</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_V</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_K</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_K</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>



<div class="viewcode-block" id="StringStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.StringStore">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StringStore</span><span class="p">(</span><span class="n">AbstractStringStore</span><span class="p">,</span> <span class="n">AttrSignal</span><span class="p">):</span>
	<span class="n">engine</span><span class="p">:</span> <span class="n">AbstractEngine</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">()</span>

	<span class="nd">@engine</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_validate_engine</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">_</span><span class="p">,</span>
		<span class="n">engine</span><span class="p">:</span> <span class="n">AbstractEngine</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
	<span class="p">):</span>
		<span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">engine</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">engine</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">engine</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
						<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;String name must be string&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
						<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;StringStore only stores strings&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span> <span class="o">=</span> <span class="n">engine</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">engine</span><span class="p">}</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">AbstractEngine</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">TamperEvidentDict</span><span class="p">()}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_switch_language</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;StringStore needs a Lisien engine or a dictionary of strings&quot;</span><span class="p">,</span>
				<span class="n">engine</span><span class="p">,</span>
			<span class="p">)</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_convert_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">prefix</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

	<span class="n">_prefix</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">converter</span><span class="o">=</span><span class="n">_convert_prefix</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

	<span class="nd">@_prefix</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_validate_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
			<span class="k">raise</span> <span class="ne">NotADirectoryError</span><span class="p">(</span>
				<span class="s2">&quot;Strings prefix is not a directory&quot;</span><span class="p">,</span> <span class="n">prefix</span>
			<span class="p">)</span>

	<span class="n">_current_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;eng&quot;</span><span class="p">)</span>

	<span class="nd">@_current_language</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_validate_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Language code must be string&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>

	<span class="n">language</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="n">LanguageDescriptor</span><span class="p">()</span>
	<span class="n">_languages</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
	<span class="n">_store</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="s2">&quot;strings&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_switch_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Write the current language to disk, and load the new one if available&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inf</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">()</span>
		<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span>
		<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">],</span> <span class="s2">&quot;tampered&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span>
				<span class="s2">&quot;w&quot;</span><span class="p">,</span>
			<span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
				<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">],</span>
					<span class="n">outf</span><span class="p">,</span>
					<span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
					<span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">]</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">])</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">])</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Set the value of a string for the current language.&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delete the string from the current language, and remove it from the</span>
<span class="sd">		cache.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="StringStore.lang_items">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.StringStore.lang_items">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">lang_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Yield pairs of (id, string) for the given language.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
			<span class="ow">and</span> <span class="n">lang</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
			<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">!=</span> <span class="n">lang</span>
		<span class="p">):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inf</span><span class="p">))</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reimport</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">tampered</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span>
				<span class="s2">&quot;w&quot;</span><span class="p">,</span>
			<span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
				<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
					<span class="n">outf</span><span class="p">,</span>
					<span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
					<span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="n">d</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">reimport</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span>
				<span class="s2">&quot;r&quot;</span><span class="p">,</span>
			<span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">(</span>
					<span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inf</span><span class="p">)</span>
				<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">blake2b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
		<span class="n">the_hash</span> <span class="o">=</span> <span class="n">blake2b</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">GROUP_SEP</span><span class="p">)</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">REC_SEP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">the_hash</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span></div>



<div class="viewcode-block" id="CodeHasher">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CodeHasher">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CodeHasher</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
	<span class="c1"># What if users want to subclass Place or whatever, and use type</span>
	<span class="c1"># annotations to decide what rules to run on which of their subclasses?</span>
	<span class="c1"># Well, that&#39;s too complicated.</span>

	<span class="n">_indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">_updated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="n">_in_try_star</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_blake2b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">blake2b</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">pack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">.facade</span><span class="w"> </span><span class="kn">import</span> <span class="n">EngineFacade</span>

		<span class="k">return</span> <span class="n">EngineFacade</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_blake2b</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_updated</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CodeHasher.visit">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CodeHasher.visit">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>


	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">yield</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">-=</span> <span class="mi">1</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">items_view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_constant</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">v</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_write_constant</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">maybe_semicolon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updated</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">maybe_newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updated</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">allow_semicolon</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">maybe_semicolon</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">maybe_newline</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">+</span> <span class="n">text</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;@&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">hash_expr</span><span class="p">(</span><span class="n">decorator</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;def &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
		<span class="c1"># we don&#39;t care about annotations</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lisien isn&#39;t an event loop&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_comprehension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">comprehension</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_async</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Async not supported&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; for &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">iffy</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">ifs</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; if &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">iffy</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="n">boolops</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;And&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;Or&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;or&quot;</span><span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boolops</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_NamedExpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; := &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="n">binop</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s2">&quot;Add&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Sub&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Mult&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
		<span class="s2">&quot;MatMult&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;@&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Div&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Mod&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;%&quot;</span><span class="p">,</span>
		<span class="s2">&quot;LShift&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">,</span>
		<span class="s2">&quot;RShift&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">,</span>
		<span class="s2">&quot;BitOr&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;|&quot;</span><span class="p">,</span>
		<span class="s2">&quot;BitXor&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;^&quot;</span><span class="p">,</span>
		<span class="s2">&quot;BitAnd&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span>
		<span class="s2">&quot;FloorDiv&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;//&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Pow&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;**&quot;</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">opstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binop</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">opstr</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>

	<span class="n">cmpops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s2">&quot;Eq&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;==&quot;</span><span class="p">,</span>
		<span class="s2">&quot;NotEq&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Lt&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
		<span class="s2">&quot;LtE&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Gt&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
		<span class="s2">&quot;GtE&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;b&gt;=&quot;</span><span class="p">,</span>
		<span class="s2">&quot;Is&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;is&quot;</span><span class="p">,</span>
		<span class="s2">&quot;IsNot&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;is not&quot;</span><span class="p">,</span>
		<span class="s2">&quot;In&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;in&quot;</span><span class="p">,</span>
		<span class="s2">&quot;NotIn&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;not in&quot;</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">parens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
		<span class="k">yield</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">comparators</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmpops</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

	<span class="n">unop</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Invert&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="s2">&quot;Not&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;not &quot;</span><span class="p">,</span> <span class="s2">&quot;UAdd&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;USub&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;-&quot;</span><span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">opstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unop</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;lambda &quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">posonlyargs</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_IfExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; if &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; else &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;if &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span>
			<span class="n">node</span><span class="o">.</span><span class="n">orelse</span>
			<span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
			<span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;elif &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;else&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>

	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">delimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
		<span class="k">yield</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;**&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">hash_expr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">hash_expr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">hash_expr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CodeHasher.interleave">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CodeHasher.interleave">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">interleave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Call f on each item in seq, calling inter() in between.&quot;&quot;&quot;</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">f</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
				<span class="n">inter</span><span class="p">()</span>
				<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;import &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;from &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">level</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
					<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span>
				<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{*()}&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_ListComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">elt</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_GeneratorExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">elt</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_SetComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">elt</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_DictComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">keywords</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">items_view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">slice</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">items_view</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">traverser</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">traverser</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="n">traverser</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Starred</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Ellipsis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">upper</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">step</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;match &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="n">all_args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">posonlyargs</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span>
		<span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
			<span class="nb">len</span><span class="p">(</span><span class="n">all_args</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
		<span class="p">)</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">defaults</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_args</span><span class="p">,</span> <span class="n">defaults</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
				<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">d</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">posonlyargs</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, /&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">vararg</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
				<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">vararg</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">vararg</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">kw_defaults</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">d</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">kwarg</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
				<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;**&quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">kwarg</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;**&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">asname</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; as &quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">asname</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_withitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">context_expr</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; as &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_match_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;case &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">guard</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; if &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">guard</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_write_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchSingleton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_write_constant</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">patterns</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchStar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">name</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;_&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">def</span><span class="w"> </span><span class="nf">upd_key_pattern_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">):</span>
			<span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pair</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
			<span class="n">keys</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">keys</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span>
				<span class="n">upd_key_pattern_pair</span><span class="p">,</span>
				<span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">patterns</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
			<span class="p">)</span>
			<span class="n">rest</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">rest</span>
			<span class="k">if</span> <span class="n">rest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;**&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
			<span class="n">pats</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">patterns</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">pats</span><span class="p">)</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">kwd_attrs</span>
		<span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>

			<span class="k">def</span><span class="w"> </span><span class="nf">upd_attr_pat</span><span class="p">(</span><span class="n">pair</span><span class="p">):</span>
				<span class="n">attr</span><span class="p">,</span> <span class="n">pat</span> <span class="o">=</span> <span class="n">pair</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">pats</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span>
				<span class="n">upd_attr_pat</span><span class="p">,</span>
				<span class="nb">zip</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">kwd_patterns</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchAs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
		<span class="n">pattern</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pattern</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; as &quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_MatchOr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; | &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">patterns</span>
			<span class="p">)</span>

<div class="viewcode-block" id="CodeHasher.visit_FunctionType">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CodeHasher.visit_FunctionType">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Since this is a function signature, rather than a real function, ignore it</span>

<span class="sd">		The purpose of these hashes is to tell if you have the code needed to load</span>
<span class="sd">		a game. Empty signatures don&#39;t matter.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">pass</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; = &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_AugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binop</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;= &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># rather than ast.Constant *representing* None</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">()</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; = &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;return&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">return</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;break&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;continue&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;del &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
			<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">return</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;global &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Nonlocal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;nonlocal &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Await</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lisien isn&#39;t an event loop&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_YieldFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;yield from &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Raise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">exc</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">exc</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">cause</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; from &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">cause</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_visit_try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;try&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;else&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">finalbody</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;finally&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">finalbody</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">prev_in_try_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_visit_try</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span> <span class="o">=</span> <span class="n">prev_in_try_star</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_TryStar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="n">prev_in_try_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_visit_try</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span> <span class="o">=</span> <span class="n">prev_in_try_star</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_ExceptHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
			<span class="sa">b</span><span class="s2">&quot;except*&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_try_star</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;except&quot;</span><span class="p">,</span>
			<span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; as &quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">maybe_newline</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">deco</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">deco</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;class &quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="c1"># we don&#39;t care about type parameters</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit_if</span><span class="p">(</span>
			<span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">bases</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">keywords</span>
		<span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">bases</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">keywords</span>
			<span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="c1"># we don&#39;t care about docstrings</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;for &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; in &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>  <span class="c1"># we don&#39;t care about type comments</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;else&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lisien isn&#39;t an event loop&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;while &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;else&quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;with &quot;</span><span class="p">,</span> <span class="n">allow_semicolon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">():</span>  <span class="c1"># we don&#39;t care about type comments</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncWith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Lisien isn&#39;t an event loop&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_write_ftstring_inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_format_spec</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">JoinedStr</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_write_ftstring_inner</span><span class="p">(</span>
					<span class="n">value</span><span class="p">,</span> <span class="n">is_format_spec</span><span class="o">=</span><span class="n">is_format_spec</span>
				<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;{{&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;}}&quot;</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">is_format_spec</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FormattedValue</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">visit_FormattedValue</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Interpolation</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">visit_Interpolation</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected node inside JoinedStr&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_write_ftstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_write_ftstring_inner</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_JoinedStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_write_ftstring</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_TemplateStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_write_ftstring</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_write_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_interpolation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">is_interpolation</span><span class="p">:</span>
				<span class="n">expr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">str</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">conversion</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">conversion</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">())</span>
			<span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">format_spec</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_write_fstring_inner</span><span class="p">(</span>
					<span class="n">node</span><span class="o">.</span><span class="n">format_spec</span><span class="p">,</span> <span class="n">is_format_spec</span><span class="o">=</span><span class="kc">True</span>
				<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_FormattedValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_write_interpolation</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_write_interpolation</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">is_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_List</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_TypeVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">return</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_TypeVarTuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">return</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_ParamSpec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">return</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_TypeAlias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">return</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimit</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">items_view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">visit_Attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
			<span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span>
		<span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">digest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blake2b</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">hexdigest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blake2b</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">b64digest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="n">digest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
		<span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">standard_b64encode</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">encoded</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>



<div class="viewcode-block" id="FunctionStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">on_setattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionStore</span><span class="p">[</span><span class="n">_K</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_T</span><span class="p">:</span> <span class="n">FunctionType</span> <span class="o">|</span> <span class="n">MethodType</span><span class="p">](</span>
	<span class="n">AbstractFunctionStore</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_T</span><span class="p">],</span> <span class="n">AttrSignal</span><span class="p">,</span> <span class="n">ABC</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A module-like object that lets you alter its code and save your changes.</span>

<span class="sd">	Instantiate it with a path to a file that you want to keep the code in.</span>
<span class="sd">	Assign functions to its attributes, then call its ``save()`` method,</span>
<span class="sd">	and they&#39;ll be unparsed and written to the file.</span>

<span class="sd">	This is a ``Signal``, so you can pass a function to its ``connect`` method,</span>
<span class="sd">	and it will be called when a function is added, changed, or deleted.</span>
<span class="sd">	The keyword arguments will be ``attr``, the name of the function, and ``val``,</span>
<span class="sd">	the function itself.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_convert_filename</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">fn</span>
		<span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

	<span class="n">_filename</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="n">_convert_filename</span><span class="p">)</span>

	<span class="nd">@_filename</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_validate_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_ignores</span><span class="o">=</span><span class="p">[])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
					<span class="s2">&quot;FunctionStore can only work with pure Python source code&quot;</span><span class="p">,</span>
					<span class="n">file</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">reimport</span><span class="p">()</span>
			<span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_ignores</span><span class="o">=</span><span class="p">[])</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

	<span class="n">_module</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">_locl</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_T</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;initial&quot;</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

	<span class="nd">@_locl</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_validate_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">initial</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_T</span><span class="p">]):</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">initial</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="n">func</span> <span class="o">=</span> <span class="n">v</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">getsource</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">func</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_set_source</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>

	<span class="n">_need_save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">type_ignores</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span>
		<span class="k">yield from</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;__name__&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s2">&quot;__name__&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
			<span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No attribute &quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
			<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_source</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">getsource</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_set_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">holder</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">holder</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">holder</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
					<span class="s2">&quot;Function in source has a different name&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">source</span>
				<span class="p">)</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">holder</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="n">outdented</span> <span class="o">=</span> <span class="n">dedent_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
		<span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">outdented</span><span class="p">)</span>
		<span class="n">funcdef</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcdef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a function definition&quot;</span><span class="p">,</span> <span class="n">outdented</span><span class="p">)</span>
		<span class="n">funcdef</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">k</span>
		<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">funcdef</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">func</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">v</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
			<span class="n">v</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="vm">__name__</span>
		<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">name</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="FunctionStore.save">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore.save">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reimport</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
			<span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">reimport</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reimport</span><span class="p">()</span></div>


<div class="viewcode-block" id="FunctionStore.reimport">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore.reimport">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">reimport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">parent</span>
		<span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
		<span class="n">modname</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span>
		<span class="k">if</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
			<span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
		<span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span>
			<span class="n">modname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">__loader__</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
			<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
		<span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="FunctionStore.iterplain">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore.iterplain">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">iterplain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span></div>


<div class="viewcode-block" id="FunctionStore.store_source">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore.store_source">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">store_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="n">outdented</span> <span class="o">=</span> <span class="n">dedent_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
		<span class="n">mod</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">outdented</span><span class="p">)</span>
		<span class="n">expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tried to store more than one function&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">expr</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
		<span class="n">locl</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">),</span> <span class="p">{},</span> <span class="n">locl</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">locl</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">locl</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="vm">__name__</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">locl</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">locl</span><span class="p">[</span><span class="n">name</span><span class="p">])</span></div>


<div class="viewcode-block" id="FunctionStore.get_source">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore.get_source">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span></div>


<div class="viewcode-block" id="FunctionStore.blake2b">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore.blake2b">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">blake2b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the blake2b hash digest of the code stored here</span>

<span class="sd">		Neither formatting nor type annotations are considered significant for</span>
<span class="sd">		the purposes of this hash.</span>

<span class="sd">		The hash is returned in a base64 string.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">hasher</span> <span class="o">=</span> <span class="n">CodeHasher</span><span class="p">()</span>
		<span class="n">todo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">)</span>
		<span class="c1"># stripped_ast = deepcopy(self._ast.body)</span>
		<span class="c1"># astor.strip_tree(stripped_ast)</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">todo</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">funcdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">todo</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcdef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="s2">&quot;Only store function defs in FunctionStore&quot;</span><span class="p">,</span> <span class="n">funcdef</span>
				<span class="p">)</span>
			<span class="n">hasher</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">funcdef</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">b64digest</span><span class="p">()</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="n">state</span></div>



<div class="viewcode-block" id="GenericFunctionStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.GenericFunctionStore">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">on_setattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GenericFunctionStore</span><span class="p">(</span><span class="n">FunctionStore</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">]):</span>
	<span class="n">_store</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;function&quot;</span></div>



<div class="viewcode-block" id="MethodStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.MethodStore">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">on_setattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MethodStore</span><span class="p">(</span><span class="n">FunctionStore</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">]):</span>
	<span class="n">_store</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;method&quot;</span></div>



<div class="viewcode-block" id="TriggerStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.TriggerStore">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">on_setattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TriggerStore</span><span class="p">(</span><span class="n">FunctionStore</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">,</span> <span class="n">TriggerFunc</span><span class="p">]):</span>
	<span class="n">_store</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;trigger&quot;</span>

<div class="viewcode-block" id="TriggerStore.get_source">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.TriggerStore.get_source">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;truth&quot;</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;def truth(*args):</span><span class="se">\n\t</span><span class="s2">return True&quot;</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">truth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="PrereqStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.PrereqStore">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">on_setattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PrereqStore</span><span class="p">(</span><span class="n">FunctionStore</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">,</span> <span class="n">PrereqFunc</span><span class="p">]):</span>
	<span class="n">_store</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;prereq&quot;</span></div>



<div class="viewcode-block" id="ActionStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.ActionStore">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">on_setattr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ActionStore</span><span class="p">(</span><span class="n">FunctionStore</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">,</span> <span class="n">ActionFunc</span><span class="p">]):</span>
	<span class="n">_store</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;action&quot;</span></div>



<div class="viewcode-block" id="UniversalMapping">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.UniversalMapping">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UniversalMapping</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">AttrSignal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Mapping for variables that are global but which I keep history for&quot;&quot;&quot;</span>

	<span class="n">engine</span><span class="p">:</span> <span class="s2">&quot;engine.Engine&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> containing </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">count_keys</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">UniversalKey</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Get the current value of this key&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">wrapval</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span>
			<span class="n">k</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_cache_now</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_cache_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ValueHint</span> <span class="o">|</span> <span class="n">Value</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Set k=v at the current branch and tick&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cache_now</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
				<span class="k">return</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_nbtt</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">universal_set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_set_cache_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">UniversalKey</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Unset this key for the present (branch, tick)&quot;&quot;&quot;</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_nbtt</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">universal_del</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=...</span><span class="p">)</span></div>



<div class="viewcode-block" id="CharacterMapping">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CharacterMapping">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CharacterMapping</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">AttrSignal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A mapping by which to access :class:`Character` objects.</span>

<span class="sd">	If a character already exists, you can always get its name here to</span>
<span class="sd">	get the :class:`Character` object. Deleting an item here will</span>
<span class="sd">	delete the character from the world, even if there are still</span>
<span class="sd">	:class:`Character` objects referring to it; those won&#39;t do</span>
<span class="sd">	anything useful anymore.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">engine</span><span class="p">:</span> <span class="s2">&quot;engine.Engine&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;CharacterMapping containing </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">count_keys</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">CharName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">time</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
				<span class="o">==</span> <span class="s2">&quot;DiGraph&quot;</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">CharName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Character</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the named character, if it&#39;s been created.</span>

<span class="sd">		Try to use the cache if possible.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">.character</span><span class="w"> </span><span class="kn">import</span> <span class="n">Character</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No such character&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
		<span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_objs</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
			<span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Character</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">init_rulebooks</span><span class="o">=</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span>
			<span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Character</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;You put something weird in the Character cache&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">name</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">KeyHint</span> <span class="o">|</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">ValueHint</span> <span class="o">|</span> <span class="n">Value</span><span class="p">]</span> <span class="o">|</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span>
	<span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Make a new character by the given name, and initialize its data to</span>
<span class="sd">		the given value.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_init_graph</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">KeyHint</span> <span class="o">|</span> <span class="n">CharName</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">del_character</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>



<span class="n">_K</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_K&quot;</span><span class="p">)</span>
<span class="n">_V</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_V&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="CompositeDict">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CompositeDict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CompositeDict</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">](</span><span class="n">MutableMapping</span><span class="p">[</span><span class="n">_K</span><span class="p">,</span> <span class="n">_V</span><span class="p">],</span> <span class="n">Signal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Combine two dictionaries into one&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Store dictionaries&quot;&quot;&quot;</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">d1</span> <span class="o">=</span> <span class="n">d1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">d2</span> <span class="o">=</span> <span class="n">d2</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over both dictionaries&#39; keys&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">:</span>
			<span class="k">yield</span> <span class="n">k</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">:</span>
			<span class="k">yield</span> <span class="n">k</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Sum the lengths of both dictionaries&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Get an item from ``d1`` if possible, then ``d2``&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="n">deleted</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">:</span>
			<span class="n">deleted</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">:</span>
			<span class="n">deleted</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">deleted</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is in neither of my wrapped dicts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="CompositeDict.patch">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.CompositeDict.patch">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Recursive update&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
				<span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Lisien</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#internals">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elide/index.html">Elide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;Zachary Spector.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>