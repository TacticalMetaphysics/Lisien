<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lisien.db &#8212; Lisien 0.23.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=10ab35ec"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lisien.db</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Lisien, a framework for life simulation games.</span>
<span class="c1"># Copyright (c) Zachary Spector, public@zacharyspector.com</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;Database connectors to persist Lisien&#39;s state to disk</span>

<span class="sd">The base class, :class:`AbstractDatabaseConnector`, defines the API that</span>
<span class="sd">database connectors need to use. Most databases should implement</span>
<span class="sd">:class:`ThreadedDatabaseConnector`, which does background processing in a</span>
<span class="sd">subthread.</span>

<span class="sd">The connectors also have import/export code to save and load the whole</span>
<span class="sd">database. One concrete class, :class:`PythonDatabaseConnector`, is provided</span>
<span class="sd">for when that&#39;s all the persistence you want. The other,</span>
<span class="sd">:class:`NullDatabaseConnector`, can&#39;t import, export, or persist anything at</span>
<span class="sd">all; it&#39;s not much good for anything but tests.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserDict</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">partialmethod</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">IOBase</span><span class="p">,</span> <span class="n">StringIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">filterfalse</span><span class="p">,</span> <span class="n">starmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">EllipsisType</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">,</span> <span class="n">MethodType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">IO</span><span class="p">,</span>
	<span class="n">TYPE_CHECKING</span><span class="p">,</span>
	<span class="n">Any</span><span class="p">,</span>
	<span class="n">Callable</span><span class="p">,</span>
	<span class="n">ClassVar</span><span class="p">,</span>
	<span class="n">Iterable</span><span class="p">,</span>
	<span class="n">Iterator</span><span class="p">,</span>
	<span class="n">Literal</span><span class="p">,</span>
	<span class="n">Mapping</span><span class="p">,</span>
	<span class="n">MutableMapping</span><span class="p">,</span>
	<span class="n">MutableSet</span><span class="p">,</span>
	<span class="n">Optional</span><span class="p">,</span>
	<span class="n">Set</span><span class="p">,</span>
	<span class="n">TypeVar</span><span class="p">,</span>
	<span class="n">get_args</span><span class="p">,</span>
	<span class="n">get_type_hints</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">attr</span><span class="w"> </span><span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">attrs</span><span class="w"> </span><span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Traceback</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">ElementTree</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="kn">import</span> <span class="n">indent</span> <span class="k">as</span> <span class="n">indent_tree</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span>
<span class="k">else</span><span class="p">:</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">lxml.etree</span><span class="w"> </span><span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">ElementTree</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">lxml.etree</span><span class="w"> </span><span class="kn">import</span> <span class="n">indent</span> <span class="k">as</span> <span class="n">indent_tree</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">lxml.etree</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span>
	<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
			<span class="n">ElementTree</span><span class="p">,</span>
			<span class="n">Element</span><span class="p">,</span>
			<span class="n">indent</span> <span class="k">as</span> <span class="n">indent_tree</span><span class="p">,</span>
			<span class="n">parse</span><span class="p">,</span>
		<span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lisien.types</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">KeyframeError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..facade</span><span class="w"> </span><span class="kn">import</span> <span class="n">EngineFacade</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">AbstractEngine</span><span class="p">,</span>
	<span class="n">ActionFuncName</span><span class="p">,</span>
	<span class="n">ActionRowType</span><span class="p">,</span>
	<span class="n">AssignmentRowListType</span><span class="p">,</span>
	<span class="n">AssignmentRowType</span><span class="p">,</span>
	<span class="n">Branch</span><span class="p">,</span>
	<span class="n">BranchRowType</span><span class="p">,</span>
	<span class="n">CharacterRulesHandledRowType</span><span class="p">,</span>
	<span class="n">CharDict</span><span class="p">,</span>
	<span class="n">CharName</span><span class="p">,</span>
	<span class="n">CharRulebookRowType</span><span class="p">,</span>
	<span class="n">EdgeKeyframe</span><span class="p">,</span>
	<span class="n">EdgeRowType</span><span class="p">,</span>
	<span class="n">EdgeValRowType</span><span class="p">,</span>
	<span class="n">EternalKey</span><span class="p">,</span>
	<span class="n">FuncName</span><span class="p">,</span>
	<span class="n">GraphEdgeValKeyframe</span><span class="p">,</span>
	<span class="n">GraphNodeValKeyframe</span><span class="p">,</span>
	<span class="n">GraphRowType</span><span class="p">,</span>
	<span class="n">GraphTypeStr</span><span class="p">,</span>
	<span class="n">GraphValKeyframe</span><span class="p">,</span>
	<span class="n">GraphValRowType</span><span class="p">,</span>
	<span class="n">Key</span><span class="p">,</span>
	<span class="n">Keyframe</span><span class="p">,</span>
	<span class="n">KeyframeExtensionRowType</span><span class="p">,</span>
	<span class="n">KeyframeGraphRowType</span><span class="p">,</span>
	<span class="n">KeyHint</span><span class="p">,</span>
	<span class="n">LoadedCharWindow</span><span class="p">,</span>
	<span class="n">LoadedDict</span><span class="p">,</span>
	<span class="n">NodeKeyframe</span><span class="p">,</span>
	<span class="n">NodeName</span><span class="p">,</span>
	<span class="n">NodeRowType</span><span class="p">,</span>
	<span class="n">NodeRulebookRowType</span><span class="p">,</span>
	<span class="n">NodeRulesHandledRowType</span><span class="p">,</span>
	<span class="n">NodeValRowType</span><span class="p">,</span>
	<span class="n">PickierDefaultDict</span><span class="p">,</span>
	<span class="n">Plan</span><span class="p">,</span>
	<span class="n">PlanTicksRowType</span><span class="p">,</span>
	<span class="n">PortalRulebookRowType</span><span class="p">,</span>
	<span class="n">PortalRulesHandledRowType</span><span class="p">,</span>
	<span class="n">PrereqFuncName</span><span class="p">,</span>
	<span class="n">PrereqRowType</span><span class="p">,</span>
	<span class="n">RuleBig</span><span class="p">,</span>
	<span class="n">RuleBigRowType</span><span class="p">,</span>
	<span class="n">RulebookName</span><span class="p">,</span>
	<span class="n">RulebookPriority</span><span class="p">,</span>
	<span class="n">RulebookRowType</span><span class="p">,</span>
	<span class="n">RulebooksKeyframe</span><span class="p">,</span>
	<span class="n">RuleFuncName</span><span class="p">,</span>
	<span class="n">RuleKeyframe</span><span class="p">,</span>
	<span class="n">RuleName</span><span class="p">,</span>
	<span class="n">RuleNeighborhood</span><span class="p">,</span>
	<span class="n">RuleNeighborhoodRowType</span><span class="p">,</span>
	<span class="n">RuleRowType</span><span class="p">,</span>
	<span class="n">Stat</span><span class="p">,</span>
	<span class="n">StatDict</span><span class="p">,</span>
	<span class="n">ThingRowType</span><span class="p">,</span>
	<span class="n">Tick</span><span class="p">,</span>
	<span class="n">Time</span><span class="p">,</span>
	<span class="n">TimeWindow</span><span class="p">,</span>
	<span class="n">TriggerFuncName</span><span class="p">,</span>
	<span class="n">TriggerRowType</span><span class="p">,</span>
	<span class="n">Turn</span><span class="p">,</span>
	<span class="n">TurnRowType</span><span class="p">,</span>
	<span class="n">UnitRowType</span><span class="p">,</span>
	<span class="n">UnitRulesHandledRowType</span><span class="p">,</span>
	<span class="n">UniversalKey</span><span class="p">,</span>
	<span class="n">UniversalKeyframe</span><span class="p">,</span>
	<span class="n">UniversalRowType</span><span class="p">,</span>
	<span class="n">Value</span><span class="p">,</span>
	<span class="n">ValueHint</span><span class="p">,</span>
	<span class="n">deannotate</span><span class="p">,</span>
	<span class="n">root_type</span><span class="p">,</span>
	<span class="n">sort_set</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..util</span><span class="w"> </span><span class="kn">import</span> <span class="n">ILLEGAL_CHARACTER_NAMES</span><span class="p">,</span> <span class="n">garbage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..window</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">AssignmentTimeDict</span><span class="p">,</span>
	<span class="n">BranchingTimeListDict</span><span class="p">,</span>
	<span class="n">LinearTimeListDict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..wrap</span><span class="w"> </span><span class="kn">import</span> <span class="n">DictWrapper</span><span class="p">,</span> <span class="n">ListWrapper</span><span class="p">,</span> <span class="n">SetWrapper</span>

<span class="n">SCHEMAVER_B</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xb6</span><span class="s2">_lisien_schema_version&quot;</span>
<span class="n">SCHEMA_VERSION</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SCHEMA_VERSION_B</span> <span class="o">=</span> <span class="n">SCHEMA_VERSION</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
<span class="n">XML_SCHEMA_VERSION</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GlobalKeyValueStore</span><span class="p">(</span><span class="n">UserDict</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A dict-like object that keeps its contents in a table.</span>

<span class="sd">	Mostly this is for holding the current branch and revision.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qe</span><span class="p">:</span> <span class="n">AbstractDatabaseConnector</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">qe</span> <span class="o">=</span> <span class="n">qe</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Key</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span> <span class="o">|</span> <span class="n">DictWrapper</span> <span class="o">|</span> <span class="n">ListWrapper</span> <span class="o">|</span> <span class="n">SetWrapper</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">DictWrapper</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
				<span class="bp">self</span><span class="p">,</span>
				<span class="n">k</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">ListWrapper</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
				<span class="bp">self</span><span class="p">,</span>
				<span class="n">k</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">SetWrapper</span><span class="p">(</span>
				<span class="k">lambda</span><span class="p">:</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
				<span class="bp">self</span><span class="p">,</span>
				<span class="n">k</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;unwrap&quot;</span><span class="p">):</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">global_set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Key</span><span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">qe</span><span class="o">.</span><span class="n">global_del</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">EternalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="n">EternalKey</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;unwrap&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">}</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ConnectionLooper</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
	<span class="n">connector</span><span class="p">:</span> <span class="n">AbstractDatabaseConnector</span>
	<span class="n">_initialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">existence_lock</span><span class="p">:</span> <span class="n">Lock</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="n">Lock</span><span class="p">)</span>

	<span class="nd">@existence_lock</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_validate_existence_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">lock</span><span class="p">:</span> <span class="n">Lock</span><span class="p">):</span>
		<span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">inq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">_inq</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">outq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">_outq</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">Lock</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>

		<span class="k">return</span> <span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;lisien.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">dispatch_special_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
			<span class="s2">&quot;Don&#39;t know what to do with this type of instruction&quot;</span><span class="p">,</span>
			<span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">),</span>
			<span class="n">inst</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">largs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">convert_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">resp</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_dispatch_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inst</span><span class="p">):</span>
		<span class="k">match</span> <span class="n">inst</span><span class="p">:</span>
			<span class="k">case</span> <span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
			<span class="k">case</span> <span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
			<span class="k">case</span> <span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="k">case</span> <span class="p">(</span><span class="s2">&quot;many&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argls</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_many</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argls</span><span class="p">)</span>
			<span class="k">case</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
			<span class="k">case</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
			<span class="k">case</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,):</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
			<span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid instruction&quot;</span><span class="p">,</span> <span class="n">inst</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">dispatch_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inst</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_instruction</span><span class="p">(</span><span class="o">*</span><span class="n">inst</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">dispatch_silent_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_instruction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Do anything needed to connect to the database and start a transaction</span>

<span class="sd">		Might be nothing, if it&#39;s a file-based local database, such as ParquetDB.</span>

<span class="sd">		&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
		<span class="n">inq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inq</span>
		<span class="n">outq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outq</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
			<span class="n">inq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
			<span class="n">outq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">inst</span> <span class="o">:=</span> <span class="n">inq</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">!=</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">inst</span> <span class="o">==</span> <span class="s2">&quot;commit&quot;</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
				<span class="n">send</span><span class="p">(</span><span class="s2">&quot;committed&quot;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">inst</span> <span class="o">==</span> <span class="s2">&quot;initdb&quot;</span><span class="p">:</span>
				<span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initdb</span><span class="p">())</span>
			<span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch_special_instruction</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
				<span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
					<span class="n">send</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
					<span class="k">continue</span>
			<span class="k">elif</span> <span class="n">inst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;silent&quot;</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">dispatch_silent_instruction</span><span class="p">(</span><span class="o">*</span><span class="n">inst</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
					<span class="n">inq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
					<span class="k">continue</span>
				<span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
					<span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Got exception while silenced: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
					<span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
					<span class="k">continue</span>
			<span class="k">elif</span> <span class="n">inst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;echo&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">send</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)</span>
					<span class="k">continue</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">send</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
					<span class="k">continue</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch_instruction</span><span class="p">(</span><span class="o">*</span><span class="n">inst</span><span class="p">))</span>
				<span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
					<span class="n">send</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
					<span class="k">continue</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="n">inq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">initdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>


<span class="n">_ARGS</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_ARGS&quot;</span><span class="p">)</span>
<span class="n">_RET</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_RET&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">mutexed</span><span class="p">(</span>
	<span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_ARGS</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">_RET</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_ARGS</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">_RET</span><span class="p">]:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Decorator for when an entire method&#39;s body holds a mutex lock</span>

<span class="sd">	Should be applied to a method. Expects that the method&#39;s class has another</span>
<span class="sd">	method, `mutex()`, that is a context manager, which holds the lock.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mutexy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">():</span>
			<span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">mutexy</span>


<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Batch</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A list of tuples to be serialized with a given function and sent to the database</span>

<span class="sd">	Construct these with the :func:`batched` decorator.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">connector</span><span class="p">:</span> <span class="n">AbstractDatabaseConnector</span>
	<span class="n">table</span><span class="p">:</span> <span class="nb">str</span>
	<span class="n">key_len</span><span class="p">:</span> <span class="nb">int</span>
	<span class="n">inc_rec_counter</span><span class="p">:</span> <span class="nb">bool</span>
	<span class="n">per_character</span><span class="p">:</span> <span class="nb">bool</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_convert_sig</span><span class="p">(</span>
		<span class="n">serialize_record</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Value</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">serialize_record</span><span class="p">)</span>

	<span class="n">signature</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">converter</span><span class="o">=</span><span class="n">_convert_sig</span><span class="p">)</span>
	<span class="n">cached_properties</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">cached_property</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;`cached_property` objects produced by `@batched`&quot;&quot;&quot;</span>
	<span class="n">serializers</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Value</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Serialization functions decorated by `@batched`&quot;&quot;&quot;</span>
	<span class="n">validate</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Whether to check that records added to the batch are correctly typed tuples&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">cull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Remove records matching a condition from the batch</span>

<span class="sd">		Records are unpacked before being passed into the condition function.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">datta</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
			<span class="n">filterfalse</span><span class="p">(</span>
				<span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_with_unpacked_tuple</span><span class="p">,</span> <span class="n">condition</span><span class="p">),</span> <span class="n">datta</span>
			<span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">tuple</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">]:</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span>
		<span class="n">unpack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">unpack</span>

		<span class="n">ret_annot</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_annot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">ret_annot</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ret_annot</span><span class="p">)</span>
		<span class="n">types_on_disk</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">ret_annot</span><span class="p">)</span>

		<span class="c1"># I&#39;d like a more informative return type</span>
		<span class="k">def</span><span class="w"> </span><span class="nf">deserialize</span><span class="p">(</span><span class="n">rec</span><span class="p">:</span> <span class="n">types_on_disk</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
			<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">types_on_disk</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
				<span class="n">unpack</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">if</span> <span class="n">type_on_disk</span> <span class="ow">is</span> <span class="nb">bytes</span> <span class="k">else</span> <span class="n">item</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">type_on_disk</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">types_on_disk</span><span class="p">)</span>
			<span class="p">)</span>

		<span class="k">return</span> <span class="n">deserialize</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Queue</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">]:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_character</span><span class="p">:</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span>
			<span class="n">char_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
			<span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="k">for</span> <span class="n">char_index</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
				<span class="n">param</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
					<span class="n">annot</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">annot</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
				<span class="k">if</span> <span class="n">annot</span> <span class="ow">is</span> <span class="n">CharName</span><span class="p">:</span>
					<span class="k">break</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;per_character was set, but no CharName&quot;</span><span class="p">)</span>

			<span class="k">def</span><span class="w"> </span><span class="nf">get_lists</span><span class="p">(</span><span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">outq</span><span class="p">:</span> <span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
				<span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="n">outq</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">list</span><span class="p">):</span>
					<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">got</span><span class="p">:</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
							<span class="n">rec</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
						<span class="n">charn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">char_index</span><span class="p">])</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">ret</span><span class="p">[</span><span class="n">charn</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
							<span class="p">)</span>
						<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
							<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
					<span class="n">outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
				<span class="k">return</span> <span class="n">got</span>
		<span class="k">else</span><span class="p">:</span>

			<span class="k">def</span><span class="w"> </span><span class="nf">get_lists</span><span class="p">(</span><span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">outq</span><span class="p">:</span> <span class="n">Queue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
				<span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="n">outq</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">list</span><span class="p">):</span>
					<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">got</span><span class="p">:</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
							<span class="n">rec</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
								<span class="n">rec</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
								<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
							<span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">ret</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span>
						<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
							<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
					<span class="n">outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
				<span class="k">return</span> <span class="n">got</span>

		<span class="k">return</span> <span class="n">get_lists</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">window_getter</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span>
		<span class="p">[</span>
			<span class="n">ThreadedDatabaseConnector</span><span class="p">,</span>
			<span class="nb">dict</span><span class="p">,</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="n">Tick</span><span class="p">,</span>
			<span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
			<span class="n">Tick</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
		<span class="p">],</span>
		<span class="kc">None</span><span class="p">,</span>
	<span class="p">]:</span>
		<span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>
		<span class="n">get_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lists</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">get_a_window</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">:</span> <span class="n">ThreadedDatabaseConnector</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
			<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
			<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
			<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
			<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
		<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">outq</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="n">outq</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">!=</span> <span class="p">(</span>
				<span class="s2">&quot;begin&quot;</span><span class="p">,</span>
				<span class="n">table</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn_from</span><span class="p">,</span>
				<span class="n">tick_from</span><span class="p">,</span>
				<span class="n">turn_to</span><span class="p">,</span>
				<span class="n">tick_to</span><span class="p">,</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected beginning of &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
			<span class="n">outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
			<span class="n">got</span> <span class="o">=</span> <span class="n">get_lists</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">outq</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">got</span> <span class="o">!=</span> <span class="p">(</span>
				<span class="s2">&quot;end&quot;</span><span class="p">,</span>
				<span class="n">table</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn_from</span><span class="p">,</span>
				<span class="n">tick_from</span><span class="p">,</span>
				<span class="n">turn_to</span><span class="p">,</span>
				<span class="n">tick_to</span><span class="p">,</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected end of &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
			<span class="n">outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

		<span class="k">return</span> <span class="n">get_a_window</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_call_with_unpacked_tuple</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tup</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can only batch tuples&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="sa">f</span><span class="s2">&quot;Need a tuple of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">, not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
			<span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
			<span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">t</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="n">annot</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">root_type</span><span class="p">,</span> <span class="n">deannotate</span><span class="p">(</span><span class="n">annot</span><span class="p">)))):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="sa">f</span><span class="s2">&quot;While validating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="si">}</span><span class="s2">: &quot;</span>
					<span class="sa">f</span><span class="s2">&quot;Tuple element </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">;&quot;</span>
					<span class="sa">f</span><span class="s2">&quot; should be </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
					<span class="n">value</span><span class="p">,</span>
				<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">serialize_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong record length&quot;</span><span class="p">,</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
		<span class="n">rett</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rett</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">rett</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">rett</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rett</span><span class="p">,</span> <span class="s2">&quot;__value__&quot;</span><span class="p">):</span>
			<span class="n">rett</span> <span class="o">=</span> <span class="n">rett</span><span class="o">.</span><span class="n">__value__</span>
		<span class="k">if</span> <span class="n">rett</span> <span class="ow">is</span> <span class="n">Time</span><span class="p">:</span>
			<span class="n">rett</span> <span class="o">=</span> <span class="p">(</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">rett</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">rett</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rett</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Wrong record length&quot;</span><span class="p">,</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span><span class="p">,</span> <span class="n">rett</span><span class="p">,</span> <span class="n">args</span>
			<span class="p">)</span>
		<span class="n">pack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">pack</span>
		<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">rett</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="n">typ</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
			<span class="n">typ</span> <span class="o">=</span> <span class="n">root_type</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
				<span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Wrong type&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">return</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">:</span>
			<span class="n">deduplicated</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">rec</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">]:</span> <span class="n">rec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_len</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span>
			<span class="p">}</span>
			<span class="n">records</span> <span class="o">=</span> <span class="n">starmap</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">serialize_record</span><span class="p">,</span>
				<span class="p">((</span><span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">deduplicated</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">records</span> <span class="o">=</span> <span class="n">starmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serialize_record</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
		<span class="n">argnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">delete_many_silent</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
				<span class="p">[</span>
					<span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">argnames</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">],</span> <span class="n">datum</span><span class="p">))</span>
					<span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="p">{</span><span class="n">rec</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_len</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">data</span><span class="p">}</span>
				<span class="p">],</span>
			<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">insert_many_silent</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">datum</span><span class="p">))</span> <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
		<span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rec_counter</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">_increc</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span>


<span class="k">def</span><span class="w"> </span><span class="nf">batched</span><span class="p">(</span>
	<span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
	<span class="n">serialize_record</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="o">*</span><span class="p">,</span>
	<span class="n">key_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">inc_rec_counter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="n">per_character</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">partial</span> <span class="o">|</span> <span class="n">cached_property</span><span class="p">:</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Decorator for serializers that operate on batches of records</span>

<span class="sd">	Needs at least the name of the ``table`` the batch will be inserted into.</span>

<span class="sd">	The type annotations on the decorated function will be used to generate the</span>
<span class="sd">	schema for at least SQL and ParquetDB databases, and preferably every other.</span>
<span class="sd">	The decorated function will never be called; it&#39;s just convenient to use</span>
<span class="sd">	function signatures and annotations to express de/serialization.</span>

<span class="sd">	:param key_len: How long the primary key is. Used to delete records matching</span>
<span class="sd">		those in the batch.</span>
<span class="sd">	:param inc_rec_counter: Whether to count these records toward the number</span>
<span class="sd">		needed to trigger an automatic keyframe snap.</span>
<span class="sd">	:param per_character: Whether to group the records by the character they</span>
<span class="sd">		are about when loading. Default ``False``. Won&#39;t work unless the return</span>
<span class="sd">		type has a ``CharName`` annotation.</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">serialize_record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">partial</span><span class="p">(</span>
			<span class="n">batched</span><span class="p">,</span>
			<span class="n">table</span><span class="p">,</span>
			<span class="n">key_len</span><span class="o">=</span><span class="n">key_len</span><span class="p">,</span>
			<span class="n">inc_rec_counter</span><span class="o">=</span><span class="n">inc_rec_counter</span><span class="p">,</span>
			<span class="n">per_character</span><span class="o">=</span><span class="n">per_character</span><span class="p">,</span>
		<span class="p">)</span>
	<span class="n">Batch</span><span class="o">.</span><span class="n">serializers</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialize_record</span>
	<span class="n">serialized_tuple_type</span> <span class="o">=</span> <span class="n">get_type_hints</span><span class="p">(</span><span class="n">serialize_record</span><span class="p">)[</span><span class="s2">&quot;return&quot;</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">the_batch</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="p">[</span><span class="n">serialized_tuple_type</span><span class="p">]:</span>
		<span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">mth</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">serialize_record</span><span class="p">,</span> <span class="n">EngineFacade</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">mth</span> <span class="o">=</span> <span class="n">MethodType</span><span class="p">(</span><span class="n">serialize_record</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Batch</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span>
			<span class="n">table</span><span class="p">,</span>
			<span class="n">key_len</span><span class="p">,</span>
			<span class="n">inc_rec_counter</span><span class="p">,</span>
			<span class="n">per_character</span><span class="p">,</span>
			<span class="n">mth</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">return</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="n">table</span><span class="p">,</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">the_batch</span><span class="p">)</span>
	<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_fake_pack_or_unpack</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">obj</span>


<div class="viewcode-block" id="AbstractDatabaseConnector">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.AbstractDatabaseConnector">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AbstractDatabaseConnector</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;The interface between Lisien and wherever it&#39;s storing its data</span>

<span class="sd">	Currently, there are three implementations (and</span>
<span class="sd">	:class:`NullDatabaseConnector`, which does nothing, suitable only for tests).</span>
<span class="sd">	This module contains the concrete class :class:`PythonDatabaseConnector`,</span>
<span class="sd">	which stores all of Lisien&#39;s data as ordinary Python objects, to be</span>
<span class="sd">	exported via :meth:`to_xml` and later imported by :meth:`load_xml`.</span>
<span class="sd">	You should probably use the :meth:`lisien.engine.Engine.export`</span>
<span class="sd">	and :meth:`lisien.engine.Engine.from_archive` methods instead. Lisien&#39;s</span>
<span class="sd">	XML files are very large, and don&#39;t contain the game&#39;s code, but the</span>
<span class="sd">	archives produced by :meth:`lisien.engine.Engine.export` are compressed</span>
<span class="sd">	well, and include the code.</span>

<span class="sd">	To more conveniently persist the state of the game between play sessions,</span>
<span class="sd">	the modules :mod:`lisien.sql` and :mod:`lisien.pqdb` implement connectors</span>
<span class="sd">	for SQL and ParquetDB databases, respectively. It shouldn&#39;t be necessary</span>
<span class="sd">	to import them directly, as :class:`lisien.engine.Engine` will select</span>
<span class="sd">	the appropriate connector class itself.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">db_type</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
	<span class="n">engine</span><span class="p">:</span> <span class="n">AbstractEngine</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">pack</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">obj</span><span class="p">:</span> <span class="n">Key</span>
		<span class="o">|</span> <span class="n">KeyHint</span>
		<span class="o">|</span> <span class="n">EternalKey</span>
		<span class="o">|</span> <span class="n">UniversalKey</span>
		<span class="o">|</span> <span class="n">Stat</span>
		<span class="o">|</span> <span class="n">ValueHint</span>
		<span class="o">|</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">keyframe_interval</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">clear</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">kf_interval_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_detect_kf_interval_override</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">snap_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">snap_keyframe</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="n">_initialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">_kf_interval_overridden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">tree</span><span class="p">:</span> <span class="n">ElementTree</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_records</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">0</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_new_keyframe_times</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">Time</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">all_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">eternal</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">EternalKey</span> <span class="o">|</span> <span class="n">KeyHint</span><span class="p">,</span> <span class="n">Value</span> <span class="o">|</span> <span class="n">ValueHint</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span>
			<span class="s2">&quot;turn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;eng&quot;</span><span class="p">,</span>
			<span class="s2">&quot;trunk&quot;</span><span class="p">:</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span>
			<span class="s2">&quot;_lisien_schema_version&quot;</span><span class="p">:</span> <span class="n">SCHEMA_VERSION</span><span class="p">,</span>
		<span class="p">}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lock</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">Lock</span><span class="p">()</span>

	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mutex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">dump_everything</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]]:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the whole database in a Python dictionary.</span>

<span class="sd">		You should probably use ``to_xml`` instead, but this could be helpful</span>
<span class="sd">		for debugging, or if you have your own ideas about serialization.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">entuple</span><span class="p">(</span><span class="n">rec</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">rec</span><span class="p">,)</span>
			<span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

		<span class="k">return</span> <span class="p">{</span>
			<span class="n">table</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
				<span class="nb">map</span><span class="p">(</span><span class="n">entuple</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_dump&quot;</span><span class="p">)()),</span>
			<span class="p">)</span>
			<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
		<span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]],</span>
		<span class="nb">bool</span><span class="p">,</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dump_everything</span><span class="p">(),</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">load_everything</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]]):</span>
		<span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">prop</span> <span class="o">=</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
			<span class="n">batch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">attrname</span><span class="p">)</span>
			<span class="n">batch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">state</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span>
			<span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]],</span>
			<span class="nb">bool</span><span class="p">,</span>
		<span class="p">],</span>
	<span class="p">):</span>
		<span class="p">(</span>
			<span class="n">data</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">,</span>
		<span class="p">)</span> <span class="o">=</span> <span class="n">state</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_everything</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractDatabaseConnector</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span>

	<span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;global&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_eternal2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">EternalKey</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;branches&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_branches2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">parent</span><span class="p">:</span> <span class="n">Branch</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">parent_turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">parent_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">end_turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">end_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Branch</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;turns&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_turns2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">plan_end_tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;turns_completed&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_turns_completed_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">]:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">complete_turn</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">discard_rules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_turns_completed_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">discard_rules</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_char_rules_handled</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_unit_rules_handled_to_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_char_thing_rules_handled</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_char_place_rules_handled</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_char_portal_rules_handled</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_node_rules_handled_to_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_portal_rules_handled_to_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;plan_ticks&quot;</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_planticks2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Plan</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;bookmarks&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_bookmarks2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_bookmark</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_bookmarks2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">del_bookmark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;universals&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_universals2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;rules&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rules2set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rule</span><span class="p">,)</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;rule_triggers&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_triggers2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">triggers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;rule_prereqs&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_prereqs2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">prereqs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;rule_actions&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_actions2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;rule_neighborhood&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_neighbors2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">neighborhood</span><span class="p">:</span> <span class="n">RuleNeighborhood</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;rule_big&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_big2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">big</span><span class="p">:</span> <span class="n">RuleBig</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleBig</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;rulebooks&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rulebooks2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">priority</span><span class="p">:</span> <span class="n">RulebookPriority</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RulebookPriority</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;graphs&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_graphs2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="nb">type</span><span class="p">:</span> <span class="n">GraphTypeStr</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">GraphTypeStr</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_rulebook_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_unit_rulebook_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_thing_rulebook_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_place_rulebook_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_portal_rulebook_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;node_rulebook&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_noderb2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;portal_rulebook&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
		<span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_portrb2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_nodes2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">extant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">nodes_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_nodes2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span>
			<span class="k">lambda</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_edges2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">extant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">edges_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_edges2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span>
			<span class="k">lambda</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;node_val&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_nodevals2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_del_time</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_nodevals2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span>
			<span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;edge_val&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_edgevals2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_del_time</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_edgevals2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span>
			<span class="k">lambda</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;graph_val&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_graphvals2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_del_time</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_graphvals2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span>
			<span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;keyframes&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
		<span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_new_keyframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Time</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;keyframes_graphs&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
		<span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_new_keyframes_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">nodes</span><span class="p">:</span> <span class="n">NodeKeyframe</span><span class="p">,</span>
		<span class="n">edges</span><span class="p">:</span> <span class="n">EdgeKeyframe</span><span class="p">,</span>
		<span class="n">graph_val</span><span class="p">:</span> <span class="n">GraphValKeyframe</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;keyframe_extensions&quot;</span><span class="p">,</span>
		<span class="n">key_len</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
		<span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_new_keyframe_extensions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">universal</span><span class="p">:</span> <span class="n">UniversalKeyframe</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleKeyframe</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebooksKeyframe</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;character_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_char_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">Turn</span><span class="p">,</span>
		<span class="nb">bytes</span><span class="p">,</span>
		<span class="nb">bytes</span><span class="p">,</span>
		<span class="n">RuleName</span><span class="p">,</span>
		<span class="n">Tick</span><span class="p">,</span>
	<span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_unit_rules_handled_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_char_thing_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_char_place_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">place</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span>
		<span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span>
	<span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_char_portal_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;node_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_node_rules_handled_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;portal_rules_handled&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">inc_rec_counter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_portal_rules_handled_to_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_unitness</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character_graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit_graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit_node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">is_unit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@batched</span><span class="p">(</span><span class="s2">&quot;things&quot;</span><span class="p">,</span> <span class="n">key_len</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_things2set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">location</span><span class="p">:</span> <span class="n">NodeName</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">universal_get</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span> <span class="o">...</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universal_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span> <span class="o">|</span> <span class="nb">type</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_universals2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universal_del</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">universal_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">exist_node</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">extant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_nodes2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">extant</span><span class="p">))</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_all_keyframe_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_new_keyframes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_all_keyframe_times</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_graph_insert</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">nodes</span><span class="p">:</span> <span class="n">NodeKeyframe</span><span class="p">,</span>
		<span class="n">edges</span><span class="p">:</span> <span class="n">EdgeKeyframe</span><span class="p">,</span>
		<span class="n">graph_val</span><span class="p">:</span> <span class="n">CharDict</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_new_keyframes_graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">graph_val</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_extension_insert</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">universal</span><span class="p">:</span> <span class="n">UniversalKeyframe</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleKeyframe</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebooksKeyframe</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_new_keyframe_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn</span><span class="p">,</span>
				<span class="n">tick</span><span class="p">,</span>
				<span class="n">universal</span><span class="p">,</span>
				<span class="n">rule</span><span class="p">,</span>
				<span class="n">rulebook</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_nodevals2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_edgevals2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">plans_insert</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_planticks2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_upd_plan_times</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_upd_plan_ticks</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_upd_plan_ticks</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">plan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">insert_time</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearTimeListDict</span><span class="p">(</span>
					<span class="p">{</span><span class="n">turn</span><span class="p">:</span> <span class="p">[</span><span class="n">tick</span><span class="p">]}</span>
				<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">]</span> <span class="o">=</span> <span class="n">BranchingTimeListDict</span><span class="p">(</span>
				<span class="p">{</span><span class="n">branch</span><span class="p">:</span> <span class="p">{</span><span class="n">turn</span><span class="p">:</span> <span class="p">[</span><span class="n">tick</span><span class="p">]}}</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_upd_plan_times</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">plan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="p">[</span><span class="n">plan</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="p">[</span><span class="n">plan</span><span class="p">]</span> <span class="o">=</span> <span class="p">{(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">plans_insert_many</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">many</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Plan</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_planticks2set</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">many</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">many</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_upd_plan_times</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_upd_plan_ticks</span><span class="p">(</span><span class="o">*</span><span class="n">tup</span><span class="p">)</span>

	<span class="nd">@garbage</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Put all pending changes into the SQL transaction, or write to disk.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wat</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="s2">&quot;ready&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not ready to flush&quot;</span><span class="p">,</span> <span class="n">wat</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_flush</span><span class="p">()</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wat</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;flushed&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="s2">&quot;flushed&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed flush&quot;</span><span class="p">,</span> <span class="n">wat</span><span class="p">)</span>

	<span class="nd">@mutexed</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">serializer</span> <span class="ow">in</span> <span class="n">Batch</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">batch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">Batch</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="s2">&quot;Batch was overwritten&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">serializer</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">batch</span>
				<span class="p">)</span>
			<span class="n">batch</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">getLogger</span>

		<span class="k">return</span> <span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;lisien.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">insert_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">insert_many_silent</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">delete_many_silent</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe_extensions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">UniversalKeyframe</span><span class="p">,</span> <span class="n">RuleKeyframe</span><span class="p">,</span> <span class="n">RulebooksKeyframe</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Time</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">delete_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_insert</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="nb">type</span><span class="p">:</span> <span class="n">GraphTypeStr</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_graphs2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Stat</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">val</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_graphvals2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">exist_edge</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">extant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_edges2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">extant</span><span class="p">))</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">have_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">branches_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">BranchRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">global_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">global_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">EternalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Branch</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tick</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">EternalKey</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eternal2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">EternalKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eternal2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="o">...</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_branch</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">parent</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">parent_turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">parent_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">end_turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">end_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_branches2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">parent_turn</span><span class="p">,</span> <span class="n">parent_tick</span><span class="p">,</span> <span class="n">end_turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_turn</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">plan_end_tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_turns2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">,</span> <span class="n">plan_end_tick</span><span class="p">))</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">turns_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TurnRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphValRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_types</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Turn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tick</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">nodes_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeValRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">edges_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">EdgeRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">EdgeValRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">plan_ticks_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PlanTicksRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">truncate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="n">_infixes2load</span> <span class="o">=</span> <span class="p">[</span>
		<span class="s2">&quot;graphs&quot;</span><span class="p">,</span>
		<span class="s2">&quot;nodes&quot;</span><span class="p">,</span>
		<span class="s2">&quot;edges&quot;</span><span class="p">,</span>
		<span class="s2">&quot;graph_val&quot;</span><span class="p">,</span>
		<span class="s2">&quot;node_val&quot;</span><span class="p">,</span>
		<span class="s2">&quot;edge_val&quot;</span><span class="p">,</span>
		<span class="s2">&quot;things&quot;</span><span class="p">,</span>
		<span class="s2">&quot;units&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;node_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;portal_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;universals&quot;</span><span class="p">,</span>
		<span class="s2">&quot;rulebooks&quot;</span><span class="p">,</span>
		<span class="s2">&quot;rule_triggers&quot;</span><span class="p">,</span>
		<span class="s2">&quot;rule_prereqs&quot;</span><span class="p">,</span>
		<span class="s2">&quot;rule_actions&quot;</span><span class="p">,</span>
		<span class="s2">&quot;rule_neighborhood&quot;</span><span class="p">,</span>
		<span class="s2">&quot;rule_big&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;node_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;portal_rules_handled&quot;</span><span class="p">,</span>
	<span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_increc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Snap a keyframe, if the keyframe interval has passed.</span>

<span class="sd">		But the engine can override this behavior when it&#39;d be impractical,</span>
<span class="sd">		such as during a rule&#39;s execution. This defers the keyframe snap</span>
<span class="sd">		until next we get a falsy result from the override function.</span>

<span class="sd">		Not to be called directly. Instead, use a batch, likely created via</span>
<span class="sd">		the ``@batch`` decorator.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t reduce the count of written records&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_records</span> <span class="o">+=</span> <span class="n">n</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kf_interval_override</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">override</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_kf_interval_overridden</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">return</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_kf_interval_overridden</span>
			<span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_records</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_interval</span> <span class="o">==</span> <span class="mi">0</span>
		<span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">snap_keyframe</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_kf_interval_overridden</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">get_all_keyframe_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeKeyframe</span><span class="p">,</span> <span class="n">EdgeKeyframe</span><span class="p">,</span> <span class="n">StatDict</span><span class="p">]]:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Keyframe</span><span class="p">:</span>
		<span class="n">universal_kf</span><span class="p">,</span> <span class="n">rule_kf</span><span class="p">,</span> <span class="n">rulebook_kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keyframe_extensions</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
		<span class="p">)</span>
		<span class="n">kf</span><span class="p">:</span> <span class="n">Keyframe</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;universal&quot;</span><span class="p">:</span> <span class="n">universal_kf</span><span class="p">,</span>
			<span class="s2">&quot;rulebook&quot;</span><span class="p">:</span> <span class="n">rulebook_kf</span><span class="p">,</span>
			<span class="o">**</span><span class="n">rule_kf</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span>
			<span class="n">char</span><span class="p">,</span>
			<span class="n">node_val</span><span class="p">,</span>
			<span class="n">edge_val</span><span class="p">,</span>
			<span class="n">graph_val</span><span class="p">,</span>
		<span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_keyframe_graphs</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
			<span class="k">if</span> <span class="s2">&quot;node_val&quot;</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
				<span class="n">kf</span><span class="p">[</span><span class="s2">&quot;node_val&quot;</span><span class="p">][</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_val</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">kf</span><span class="p">[</span><span class="s2">&quot;node_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">char</span><span class="p">:</span> <span class="n">node_val</span><span class="p">}</span>
			<span class="k">if</span> <span class="s2">&quot;edge_val&quot;</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
				<span class="n">kf</span><span class="p">[</span><span class="s2">&quot;edge_val&quot;</span><span class="p">][</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_val</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">kf</span><span class="p">[</span><span class="s2">&quot;edge_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">char</span><span class="p">:</span> <span class="n">edge_val</span><span class="p">}</span>
			<span class="k">if</span> <span class="s2">&quot;graph_val&quot;</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
				<span class="n">kf</span><span class="p">[</span><span class="s2">&quot;graph_val&quot;</span><span class="p">][</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_val</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">kf</span><span class="p">[</span><span class="s2">&quot;graph_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">char</span><span class="p">:</span> <span class="n">graph_val</span><span class="p">}</span>
		<span class="k">return</span> <span class="n">kf</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_graphs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">KeyframeGraphRowType</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_extensions_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">KeyframeExtensionRowType</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">universals_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">UniversalRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rulebooks_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rules_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rule_triggers_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TriggerRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rule_prereqs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PrereqRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rule_actions_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ActionRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rule_neighborhood_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleNeighborhoodRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">rule_big_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleBigRowType</span><span class="p">]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">node_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">portal_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PortalRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unit_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_thing_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_place_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_portal_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharacterRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unit_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">UnitRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_thing_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_place_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">character_portal_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">node_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">portal_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">things_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">units_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">count_all_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_triggers</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">triggers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rules</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_triggers2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">triggers</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">triggers</span><span class="o">=</span><span class="n">triggers</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_prereqs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">prereqs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rules</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_prereqs2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">prereqs</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">prereqs</span><span class="o">=</span><span class="n">prereqs</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_actions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rules</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_actions2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">actions</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_neighborhood</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">neighborhood</span><span class="p">:</span> <span class="n">RuleNeighborhood</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rules</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_neighbors2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
				<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span>
				<span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">neighborhood</span><span class="o">=</span><span class="n">neighborhood</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_big</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">big</span><span class="p">:</span> <span class="n">RuleBig</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rules</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_big2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">big</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">big</span><span class="o">=</span><span class="n">big</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">create_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">triggers</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">prereqs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">actions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">neighborhood</span><span class="p">:</span> <span class="n">RuleNeighborhood</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">big</span><span class="p">:</span> <span class="n">RuleBig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_triggers2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">triggers</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_prereqs2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">prereqs</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_actions2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_neighbors2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">neighborhood</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_big2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">big</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_rules2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rule</span><span class="p">,))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">all_rules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">name</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">prio</span><span class="p">:</span> <span class="n">RulebookPriority</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">prio</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_character_rulebook_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_unit_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_unit_rulebook_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_thing_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_character_thing_rulebook_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_place_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_character_place_rulebook_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_portal_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_character_portal_rulebook_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rulebook_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span>
		<span class="n">priority</span><span class="p">:</span> <span class="n">RulebookPriority</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_node_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_noderb2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_portal_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_portrb2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_char_rules_handled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_unit_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_unit_rules_handled_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_thing_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_char_thing_rules_handled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_place_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">place</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_char_place_rules_handled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_portal_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_char_portal_rules_handled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_node_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_node_rules_handled_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_portal_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_portal_rules_handled_to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_thing_loc</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">loc</span><span class="p">:</span> <span class="n">NodeName</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_things2set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">things_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_things2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span>
			<span class="k">lambda</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unit_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">is_unit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_unitness</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">turns_completed_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">]]:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">bookmarks_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Time</span><span class="p">]]:</span> <span class="o">...</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_load_windows_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeWindow</span><span class="p">]):</span> <span class="o">...</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">empty_char</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">LoadedCharWindow</span><span class="p">:</span>
		<span class="n">nodes_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">edges_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EdgeRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">graph_val_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GraphValRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">node_val_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeValRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">edge_val_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EdgeValRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">things_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ThingRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">units_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UnitRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">character_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">unit_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">char_thing_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">char_place_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">char_portal_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">node_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">portal_rulebook_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PortalRulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">nodes_l</span><span class="p">,</span>
			<span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">edges_l</span><span class="p">,</span>
			<span class="s2">&quot;graph_val&quot;</span><span class="p">:</span> <span class="n">graph_val_l</span><span class="p">,</span>
			<span class="s2">&quot;node_val&quot;</span><span class="p">:</span> <span class="n">node_val_l</span><span class="p">,</span>
			<span class="s2">&quot;edge_val&quot;</span><span class="p">:</span> <span class="n">edge_val_l</span><span class="p">,</span>
			<span class="s2">&quot;things&quot;</span><span class="p">:</span> <span class="n">things_l</span><span class="p">,</span>
			<span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">units_l</span><span class="p">,</span>
			<span class="s2">&quot;character_rulebook&quot;</span><span class="p">:</span> <span class="n">character_rulebook_l</span><span class="p">,</span>
			<span class="s2">&quot;unit_rulebook&quot;</span><span class="p">:</span> <span class="n">unit_rulebook_l</span><span class="p">,</span>
			<span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">:</span> <span class="n">char_thing_rulebook_l</span><span class="p">,</span>
			<span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">:</span> <span class="n">char_place_rulebook_l</span><span class="p">,</span>
			<span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">:</span> <span class="n">char_portal_rulebook_l</span><span class="p">,</span>
			<span class="s2">&quot;node_rulebook&quot;</span><span class="p">:</span> <span class="n">node_rulebook_l</span><span class="p">,</span>
			<span class="s2">&quot;portal_rulebook&quot;</span><span class="p">:</span> <span class="n">portal_rulebook_l</span><span class="p">,</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">load_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeWindow</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">LoadedDict</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load_windows(</span><span class="si">{</span><span class="n">windows</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

		<span class="n">ret</span><span class="p">:</span> <span class="n">LoadedDict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">empty_char</span><span class="p">)</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;universals&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UniversalRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;rule_triggers&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;rule_prereqs&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;rule_actions&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;rule_neighborhood&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;rule_big&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;rulebooks&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;character_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharacterRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UnitRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span>
			<span class="n">NodeRulesHandledRowType</span>
		<span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span>
			<span class="n">NodeRulesHandledRowType</span>
		<span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span>
			<span class="n">PortalRulesHandledRowType</span>
		<span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;node_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;portal_rules_handled&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ret</span><span class="p">[</span><span class="s2">&quot;graphs&quot;</span><span class="p">]:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_load_windows_into</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">windows</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finished loading windows </span><span class="si">{</span><span class="n">windows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Character name not unpacked&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;handled&quot;</span><span class="p">):</span>
				<span class="c1"># The rules-handled tables have the tick at the end because it&#39;s</span>
				<span class="c1"># not in the primary key</span>
				<span class="n">v</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
				<span class="n">v</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">vv</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Bad loaded dictionary&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_plan_ticks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Plan</span><span class="p">,</span> <span class="n">BranchingTimeListDict</span><span class="p">]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">BranchingTimeListDict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">to_etree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElementTree</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;lisien&quot;</span><span class="p">))</span>
		<span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="n">eternals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
		<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
			<span class="s2">&quot;db-schema-version&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_lisien_schema_version&quot;</span><span class="p">))</span>
		<span class="p">)</span>
		<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;xml-schema-version&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">XML_SCHEMA_VERSION</span><span class="p">))</span>
		<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;trunk&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;trunk&quot;</span><span class="p">)))</span>
		<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;branch&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;branch&quot;</span><span class="p">)))</span>
		<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;turn&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;turn&quot;</span><span class="p">)))</span>
		<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">)))</span>
		<span class="k">if</span> <span class="s2">&quot;language&quot;</span> <span class="ow">in</span> <span class="n">eternals</span><span class="p">:</span>
			<span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)))</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">eternals</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dict-item&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
			<span class="n">root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
			<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">eternals</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
		<span class="n">trunks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="n">branches_d</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">branch_descendants</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">turn_end_plan_d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">branch_elements</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">playtrees</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">turns_completed_d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">turns_completed_dump</span><span class="p">()</span>
		<span class="p">)</span>
		<span class="n">keyframe_times</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Time</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes_dump</span><span class="p">())</span>
		<span class="k">for</span> <span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">last_real_tick</span><span class="p">,</span>
			<span class="n">last_planned_tick</span><span class="p">,</span>
		<span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">turns_dump</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">turn_end_plan_d</span><span class="p">:</span>
				<span class="n">turn_end_plan_d</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
					<span class="n">last_real_tick</span><span class="p">,</span>
					<span class="n">last_planned_tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">turn_end_plan_d</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
					<span class="n">turn</span><span class="p">:</span> <span class="p">(</span><span class="n">last_real_tick</span><span class="p">,</span> <span class="n">last_planned_tick</span><span class="p">)</span>
				<span class="p">}</span>
		<span class="n">branch2do</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches_dump</span><span class="p">()))</span>
		<span class="k">while</span> <span class="n">branch2do</span><span class="p">:</span>
			<span class="p">(</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">parent</span><span class="p">,</span>
				<span class="n">parent_turn</span><span class="p">,</span>
				<span class="n">parent_tick</span><span class="p">,</span>
				<span class="n">end_turn</span><span class="p">,</span>
				<span class="n">end_tick</span><span class="p">,</span>
			<span class="p">)</span> <span class="o">=</span> <span class="n">branch2do</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
			<span class="n">branches_d</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
				<span class="n">parent</span><span class="p">,</span>
				<span class="n">parent_turn</span><span class="p">,</span>
				<span class="n">parent_tick</span><span class="p">,</span>
				<span class="n">end_turn</span><span class="p">,</span>
				<span class="n">end_tick</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">trunks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
				<span class="n">playtree</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;playtree&quot;</span><span class="p">,</span> <span class="n">trunk</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">playtree</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;game&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
				<span class="n">playtrees</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">playtree</span>
				<span class="n">branch_element</span> <span class="o">=</span> <span class="n">branch_elements</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
					<span class="s2">&quot;branch&quot;</span><span class="p">,</span>
					<span class="p">{</span>
						<span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span>
						<span class="s2">&quot;start-turn&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
						<span class="s2">&quot;start-tick&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
						<span class="s2">&quot;end-turn&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_turn</span><span class="p">),</span>
						<span class="s2">&quot;end-tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_tick</span><span class="p">),</span>
					<span class="p">},</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">turns_completed_d</span><span class="p">:</span>
					<span class="n">branch_element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
						<span class="s2">&quot;last-turn-completed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">turns_completed_d</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>
					<span class="p">)</span>
				<span class="n">root</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">playtree</span><span class="p">)</span>
				<span class="n">playtree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch_element</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">branch_descendants</span><span class="p">:</span>
					<span class="n">branch_descendants</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">branch_descendants</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">branch</span><span class="p">}</span>
				<span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">branch_elements</span><span class="p">:</span>
					<span class="n">branch_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
						<span class="s2">&quot;branch&quot;</span><span class="p">,</span>
						<span class="p">{</span>
							<span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span>
							<span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">parent</span><span class="p">,</span>
							<span class="s2">&quot;start-turn&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_turn</span><span class="p">),</span>
							<span class="s2">&quot;start-tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_tick</span><span class="p">),</span>
							<span class="s2">&quot;end-turn&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_turn</span><span class="p">),</span>
							<span class="s2">&quot;end-tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_tick</span><span class="p">),</span>
						<span class="p">},</span>
					<span class="p">)</span>
					<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">turns_completed_d</span><span class="p">:</span>
						<span class="n">branch_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
							<span class="s2">&quot;last-turn-completed&quot;</span><span class="p">,</span>
							<span class="nb">str</span><span class="p">(</span><span class="n">turns_completed_d</span><span class="p">[</span><span class="n">branch</span><span class="p">]),</span>
						<span class="p">)</span>
					<span class="n">branch_elements</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch_el</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">branch2do</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
						<span class="p">(</span>
							<span class="n">branch</span><span class="p">,</span>
							<span class="n">parent</span><span class="p">,</span>
							<span class="n">parent_turn</span><span class="p">,</span>
							<span class="n">parent_tick</span><span class="p">,</span>
							<span class="n">end_turn</span><span class="p">,</span>
							<span class="n">end_tick</span><span class="p">,</span>
						<span class="p">)</span>
					<span class="p">)</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">recurse_branch</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">Branch</span><span class="p">):</span>
			<span class="n">parent</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="o">=</span> <span class="n">branches_d</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">turn_end_plan_d</span><span class="p">:</span>
				<span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
					<span class="p">[</span>
						<span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">),</span>
						<span class="o">*</span><span class="p">(</span>
							<span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
							<span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">turn_end_plan_d</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
						<span class="p">),</span>
					<span class="p">]</span>
				<span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_windows</span><span class="p">(</span>
				<span class="p">[(</span><span class="n">b</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">)]</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_fill_branch_element</span><span class="p">(</span>
				<span class="n">branch_elements</span><span class="p">[</span><span class="n">b</span><span class="p">],</span>
				<span class="n">turn_end_plan_d</span><span class="p">[</span><span class="n">b</span><span class="p">],</span>
				<span class="n">keyframe_times</span><span class="p">,</span>
				<span class="n">data</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branch_descendants</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">branch_descendants</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">branches_d</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
					<span class="n">recurse_branch</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">trunk</span> <span class="ow">in</span> <span class="n">trunks</span><span class="p">:</span>
			<span class="n">recurse_branch</span><span class="p">(</span><span class="n">trunk</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>

	<span class="nd">@classmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_value_to_xml_el</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Value</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;Ellipsis&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lisien</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">):</span>
			<span class="c1"># Since entity names are restricted to what we can use for dict</span>
			<span class="c1"># keys and also serialize to msgpack, I don&#39;t think there&#39;s any name</span>
			<span class="c1"># an entity can have that can&#39;t be repr&#39;d</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lisien</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;node&quot;</span><span class="p">,</span>
				<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
				<span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lisien</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Edge</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;portal&quot;</span><span class="p">,</span>
				<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
				<span class="n">origin</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">orig</span><span class="p">),</span>
				<span class="n">destination</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">dest</span><span class="p">),</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">):</span>
			<span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">readwrite</span><span class="o">.</span><span class="n">GraphMLWriter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">myElement</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MethodType</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
				<span class="s2">&quot;trigger&quot;</span><span class="p">,</span>
				<span class="s2">&quot;prereq&quot;</span><span class="p">,</span>
				<span class="s2">&quot;action&quot;</span><span class="p">,</span>
				<span class="s2">&quot;function&quot;</span><span class="p">,</span>
				<span class="s2">&quot;method&quot;</span><span class="p">,</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
					<span class="s2">&quot;Callable is not stored in the Lisien engine&quot;</span><span class="p">,</span> <span class="n">value</span>
				<span class="p">)</span>
			<span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
			<span class="c1"># weird but ok</span>
			<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;exception&quot;</span><span class="p">,</span> <span class="n">pyclass</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;__traceback__&quot;</span><span class="p">):</span>
				<span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;traceback&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Traceback</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)))</span>
			<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
				<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">el</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
				<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">el</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
			<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;tuple&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
				<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">el</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Set</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">MutableSet</span><span class="p">)):</span>
				<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;set&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
					<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">el</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;frozenset&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
					<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">el</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
			<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">dict_item</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dict-item&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
				<span class="n">dict_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
				<span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dict_item</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">el</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t convert to XML&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

	<span class="nd">@classmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_add_keyframe_to_turn_el</span><span class="p">(</span>
		<span class="bp">cls</span><span class="p">,</span>
		<span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">keyframe</span><span class="p">:</span> <span class="n">Keyframe</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">kfel</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;keyframe&quot;</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">))</span>
		<span class="n">turn_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kfel</span><span class="p">)</span>
		<span class="n">universal_d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Value</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;universal&quot;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="n">univel</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">universal_d</span><span class="p">)</span>
		<span class="n">univel</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;universal&quot;</span>
		<span class="n">kfel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">univel</span><span class="p">)</span>
		<span class="n">triggers_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
			<span class="s2">&quot;triggers&quot;</span><span class="p">,</span> <span class="p">{}</span>
		<span class="p">)</span>
		<span class="n">prereqs_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
			<span class="s2">&quot;prereqs&quot;</span><span class="p">,</span> <span class="p">{}</span>
		<span class="p">)</span>
		<span class="n">actions_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
			<span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="p">{}</span>
		<span class="p">)</span>
		<span class="n">neighborhoods_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
			<span class="s2">&quot;neighborhood&quot;</span><span class="p">,</span> <span class="p">{}</span>
		<span class="p">)</span>
		<span class="n">bigs_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleBig</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">for</span> <span class="n">rule_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
			<span class="n">triggers_kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">prereqs_kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">actions_kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="n">rule_name</span><span class="p">:</span> <span class="n">RuleName</span>
			<span class="n">rule_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;rule&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="o">=</span><span class="n">rule_name</span><span class="p">,</span>
			<span class="p">)</span>
			<span class="n">kfel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule_el</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">rule_name</span> <span class="ow">in</span> <span class="n">bigs_kf</span> <span class="ow">and</span> <span class="n">bigs_kf</span><span class="p">[</span><span class="n">rule_name</span><span class="p">]:</span>
				<span class="n">rule_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="n">rule_name</span> <span class="ow">in</span> <span class="n">neighborhoods_kf</span>
				<span class="ow">and</span> <span class="n">neighborhoods_kf</span><span class="p">[</span><span class="n">rule_name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
			<span class="p">):</span>
				<span class="n">rule_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
					<span class="s2">&quot;neighborhood&quot;</span><span class="p">,</span>
					<span class="nb">str</span><span class="p">(</span><span class="n">neighborhoods_kf</span><span class="p">[</span><span class="n">rule_name</span><span class="p">]),</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="n">trigs</span> <span class="o">:=</span> <span class="n">triggers_kf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rule_name</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">trig</span> <span class="ow">in</span> <span class="n">trigs</span><span class="p">:</span>
					<span class="n">rule_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;trigger&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">trig</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">preqs</span> <span class="o">:=</span> <span class="n">prereqs_kf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rule_name</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">preq</span> <span class="ow">in</span> <span class="n">preqs</span><span class="p">:</span>
					<span class="n">rule_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;prereq&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">preq</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">acts</span> <span class="o">:=</span> <span class="n">actions_kf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rule_name</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">acts</span><span class="p">:</span>
					<span class="n">rule_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">act</span><span class="p">))</span>
		<span class="n">rulebook_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
			<span class="n">RulebookName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]</span>
		<span class="p">]</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">for</span> <span class="n">rulebook_name</span><span class="p">,</span> <span class="p">(</span><span class="n">rule_list</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rulebook_kf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">rulebook_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">rulebook_name</span><span class="p">),</span> <span class="n">priority</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
			<span class="p">)</span>
			<span class="n">kfel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rulebook_el</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">rule_name</span> <span class="ow">in</span> <span class="n">rule_list</span><span class="p">:</span>
				<span class="n">rulebook_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rule_name</span><span class="p">))</span>
		<span class="n">char_els</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">graph_val_kf</span><span class="p">:</span> <span class="n">GraphValKeyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graph_val&quot;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">for</span> <span class="n">char_name</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">graph_val_kf</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
			<span class="n">graph_el</span> <span class="o">=</span> <span class="n">char_els</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char_name</span><span class="p">)</span>
			<span class="p">)</span>
			<span class="n">kfel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">graph_el</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units_kf</span> <span class="o">:=</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="p">{}):</span>
				<span class="n">units_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span>
				<span class="n">any_unit_graphs</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="k">for</span> <span class="n">graph</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">units_kf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">unit_graphs_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span>
					<span class="n">any_unit_nodes</span> <span class="o">=</span> <span class="kc">False</span>
					<span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">is_unit</span><span class="p">:</span>
							<span class="n">any_unit_nodes</span> <span class="o">=</span> <span class="kc">True</span>
							<span class="n">unit_graphs_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
								<span class="n">Element</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
							<span class="p">)</span>
					<span class="k">if</span> <span class="n">any_unit_nodes</span><span class="p">:</span>
						<span class="n">units_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_graphs_el</span><span class="p">)</span>
						<span class="n">any_unit_graphs</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">if</span> <span class="n">any_unit_graphs</span><span class="p">:</span>
					<span class="n">graph_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units_el</span><span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;character_rulebook&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
				<span class="n">graph_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
					<span class="s2">&quot;character-rulebook&quot;</span><span class="p">,</span>
					<span class="nb">repr</span><span class="p">(</span>
						<span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
							<span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span>
							<span class="p">(</span><span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span> <span class="n">char_name</span><span class="p">),</span>
						<span class="p">)</span>
					<span class="p">),</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;unit_rulebook&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
				<span class="n">graph_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
					<span class="s2">&quot;unit-rulebook&quot;</span><span class="p">,</span>
					<span class="nb">repr</span><span class="p">(</span>
						<span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span> <span class="n">char_name</span><span class="p">))</span>
					<span class="p">),</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;character_thing_rulebook&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
				<span class="n">graph_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
					<span class="s2">&quot;character-thing-rulebook&quot;</span><span class="p">,</span>
					<span class="nb">repr</span><span class="p">(</span>
						<span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
							<span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span>
							<span class="p">(</span><span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span> <span class="n">char_name</span><span class="p">),</span>
						<span class="p">)</span>
					<span class="p">),</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;character_place_rulebook&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
				<span class="n">graph_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
					<span class="s2">&quot;character-place-rulebook&quot;</span><span class="p">,</span>
					<span class="nb">repr</span><span class="p">(</span>
						<span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
							<span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span>
							<span class="p">(</span><span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span> <span class="n">char_name</span><span class="p">),</span>
						<span class="p">)</span>
					<span class="p">),</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;character_portal_rulebook&quot;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
				<span class="n">graph_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
					<span class="s2">&quot;character-portal-rulebook&quot;</span><span class="p">,</span>
					<span class="nb">repr</span><span class="p">(</span>
						<span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
							<span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span>
							<span class="p">(</span><span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span> <span class="n">char_name</span><span class="p">),</span>
						<span class="p">)</span>
					<span class="p">),</span>
				<span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">item_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dict-item&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
				<span class="n">graph_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_el</span><span class="p">)</span>
				<span class="n">item_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="n">node_val_kf</span><span class="p">:</span> <span class="n">GraphNodeValKeyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node_val&quot;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">for</span> <span class="n">char_name</span><span class="p">,</span> <span class="n">node_vals</span> <span class="ow">in</span> <span class="n">node_val_kf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">char_name</span> <span class="ow">in</span> <span class="n">char_els</span><span class="p">:</span>
				<span class="n">char_el</span> <span class="o">=</span> <span class="n">char_els</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">char_el</span> <span class="o">=</span> <span class="n">char_els</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
					<span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char_name</span><span class="p">)</span>
				<span class="p">)</span>
				<span class="n">kfel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_el</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">node_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">node_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
					<span class="s2">&quot;node&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="s2">&quot;rulebook&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
					<span class="n">node_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)))</span>
				<span class="n">char_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_el</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">item_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dict-item&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
					<span class="n">node_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_el</span><span class="p">)</span>
					<span class="n">item_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="n">edge_val_kf</span><span class="p">:</span> <span class="n">GraphEdgeValKeyframe</span> <span class="o">=</span> <span class="n">keyframe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edge_val&quot;</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">for</span> <span class="n">char_name</span><span class="p">,</span> <span class="n">edge_vals</span> <span class="ow">in</span> <span class="n">edge_val_kf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">char_name</span> <span class="ow">in</span> <span class="n">char_els</span><span class="p">:</span>
				<span class="n">char_el</span> <span class="o">=</span> <span class="n">char_els</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">char_el</span> <span class="o">=</span> <span class="n">char_els</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
					<span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char_name</span><span class="p">)</span>
				<span class="p">)</span>
				<span class="n">kfel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_el</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="n">edge_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">edge_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
						<span class="s2">&quot;edge&quot;</span><span class="p">,</span>
						<span class="n">orig</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span>
						<span class="n">dest</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span>
					<span class="p">)</span>
					<span class="k">if</span> <span class="s2">&quot;rulebook&quot;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
						<span class="n">edge_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)))</span>
					<span class="n">char_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_el</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="n">item_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;dict-item&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
						<span class="n">edge_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_el</span><span class="p">)</span>
						<span class="n">item_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<div class="viewcode-block" id="AbstractDatabaseConnector.to_xml">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.AbstractDatabaseConnector.to_xml">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return a string XML representation of the whole database</span>

<span class="sd">		Use ``load_xml`` to load it later.</span>

<span class="sd">		:param name: What to call the game in the XML.</span>
<span class="sd">		:param indent: Whether to format the XML for human readers. Default</span>
<span class="sd">			``True``.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">write_xml</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>


<div class="viewcode-block" id="AbstractDatabaseConnector.write_xml">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.AbstractDatabaseConnector.write_xml">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">write_xml</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">|</span> <span class="n">IO</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">],</span>
		<span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">indent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Serialize the whole database to an XML file</span>

<span class="sd">		:param file: A file name, or a file object.</span>
<span class="sd">		:param name: Optional name to give to the game in the XML. Defaults</span>
<span class="sd">			to the name of the file, minus .xml extension.</span>
<span class="sd">		:param indent: Whether to format the XML for a human reader. Default</span>
<span class="sd">			``True``.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">IOBase</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need a name or a path&quot;</span><span class="p">)</span>
				<span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
			<span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span>

		<span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_etree</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
			<span class="n">indent_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
		<span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">_set_plans</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">plans</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">plan</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
				<span class="n">plans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">plans</span><span class="p">:</span>
			<span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">plans</span><span class="p">)))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_universals_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universal_rec</span><span class="p">:</span> <span class="n">UniversalRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">universal_rec</span>
		<span class="n">univ_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;universal&quot;</span><span class="p">,</span>
			<span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="n">univ_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">univ_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">univ_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rulebooks_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rulebook_rec</span><span class="p">:</span> <span class="n">RulebookRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">rulebook_rec</span>
		<span class="n">rb_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;rulebook&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">),</span>
			<span class="n">priority</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">prio</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
			<span class="n">rb_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rule</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">rb_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rb_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_flist_el</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">typ</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
		<span class="n">rec</span><span class="p">:</span> <span class="n">TriggerRowType</span> <span class="o">|</span> <span class="n">PrereqRowType</span> <span class="o">|</span> <span class="n">ActionRowType</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">funcs</span> <span class="o">=</span> <span class="n">rec</span>
		<span class="n">func_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
			<span class="n">func_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">typ</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">name</span><span class="o">=</span><span class="n">func</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">func_el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">func_el</span>

	<span class="n">_rule_triggers_el</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">_rule_flist_el</span><span class="p">,</span> <span class="s2">&quot;rule-trigger&quot;</span><span class="p">)</span>
	<span class="n">_rule_prereqs_el</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">_rule_flist_el</span><span class="p">,</span> <span class="s2">&quot;rule-prereq&quot;</span><span class="p">)</span>
	<span class="n">_rule_actions_el</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">_rule_flist_el</span><span class="p">,</span> <span class="s2">&quot;rule-action&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_neighborhood_el</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">nbr_rec</span><span class="p">:</span> <span class="n">RuleNeighborhoodRowType</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">nbr</span> <span class="o">=</span> <span class="n">nbr_rec</span>
		<span class="k">if</span> <span class="n">nbr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">nbr_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;rule-neighborhood&quot;</span><span class="p">,</span>
				<span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span>
				<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">),</span>
				<span class="n">neighbors</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">nbr</span><span class="p">),</span>
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">nbr_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="s2">&quot;rule-neighborhood&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span> <span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">nbr_el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nbr_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_big_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">big_rec</span><span class="p">:</span> <span class="n">RuleBigRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">big</span> <span class="o">=</span> <span class="n">big_rec</span>
		<span class="n">el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;rule-big&quot;</span><span class="p">,</span>
			<span class="n">rule</span><span class="o">=</span><span class="n">rule</span><span class="p">,</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">),</span>
			<span class="n">big</span><span class="o">=</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">big</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_graphs_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">:</span> <span class="n">GraphRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">typ_str</span> <span class="o">=</span> <span class="n">graph</span>
		<span class="n">graph_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;graph&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="nb">type</span><span class="o">=</span><span class="n">typ_str</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">graph_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">graph_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_graph_val_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_val</span><span class="p">:</span> <span class="n">GraphValRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">graph_val</span>
		<span class="n">graph_val_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;graph-val&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="n">graph_val_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">graph_val_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">graph_val_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_nodes_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">NodeRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">nodes</span>
		<span class="n">node_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;node&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">name</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="n">exists</span><span class="o">=</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">ex</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">node_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">node_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_node_val_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_val</span><span class="p">:</span> <span class="n">NodeValRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">node_val</span>
		<span class="n">node_val_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;node-val&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">node</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
			<span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="n">node_val_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">node_val_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">node_val_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_edges_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edges</span><span class="p">:</span> <span class="n">EdgeRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">edges</span>
		<span class="n">edge_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;edge&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">orig</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span>
			<span class="n">dest</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="n">exists</span><span class="o">=</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">ex</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">edge_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">edge_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_edge_val_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_val</span><span class="p">:</span> <span class="n">EdgeValRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">edge_val</span>
		<span class="n">edge_val_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;edge-val&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">orig</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span>
			<span class="n">dest</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span>
			<span class="n">key</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="n">edge_val_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value_to_xml_el</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">edge_val_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">edge_val_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_things_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">:</span> <span class="n">ThingRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">thing</span>
		<span class="n">loc_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;location&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">thing</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">thing</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="n">location</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">loc</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">loc_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">loc_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_units_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="n">UnitRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span> <span class="o">=</span> <span class="n">unit</span>
		<span class="n">unit_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;unit&quot;</span><span class="p">,</span>
			<span class="p">{</span>
				<span class="s2">&quot;character-graph&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
				<span class="s2">&quot;unit-graph&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">graph</span><span class="p">),</span>
				<span class="s2">&quot;unit-node&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
				<span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">)</span>
		<span class="n">unit_el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;is-unit&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">is_unit</span> <span class="k">else</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">unit_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">unit_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_char_rb_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rbtyp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rbrow</span><span class="p">:</span> <span class="n">CharRulebookRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">rbrow</span>
		<span class="n">chrbel</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="n">rbtyp</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="n">rulebook</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">chrbel</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">chrbel</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_node_rulebook_el</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrb_row</span><span class="p">:</span> <span class="n">NodeRulebookRowType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">nrb_row</span>
		<span class="n">nrb_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;node-rulebook&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">node</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="n">rulebook</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">nrb_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nrb_el</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_portal_rulebook_el</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">port_rb_row</span><span class="p">:</span> <span class="n">PortalRulebookRowType</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
		<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">port_rb_row</span>
		<span class="n">porb_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;portal-rulebook&quot;</span><span class="p">,</span>
			<span class="n">character</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
			<span class="n">orig</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">orig</span><span class="p">),</span>
			<span class="n">dest</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span>
			<span class="n">tick</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
			<span class="n">rulebook</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_plans</span><span class="p">(</span><span class="n">porb_el</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">porb_el</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_get_current_rule_el</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Element</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1"># Rules record the time they finished running, not the time they</span>
		<span class="c1"># started. So we need to peek ahead to find out what the current</span>
		<span class="c1"># rule is.</span>
		<span class="n">earliest</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
		<span class="n">earliest_key</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;character_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;unit_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;character_thing_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;character_place_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;character_portal_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;node_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;node_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;node_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;portal_rules_handled&quot;</span><span class="p">]:</span>
			<span class="n">rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;portal_rules_handled&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">handled_at</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">handled_at</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
				<span class="n">earliest</span> <span class="o">=</span> <span class="n">handled_at</span>
				<span class="n">earliest_key</span> <span class="o">=</span> <span class="s2">&quot;portal_rules_handled&quot;</span>
		<span class="k">if</span> <span class="n">earliest_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
			<span class="s2">&quot;rule&quot;</span><span class="p">,</span>
			<span class="p">{</span><span class="s2">&quot;end-tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">earliest</span><span class="p">[</span><span class="mi">1</span><span class="p">])},</span>
		<span class="p">)</span>
		<span class="k">match</span> <span class="n">earliest_key</span><span class="p">:</span>
			<span class="k">case</span> <span class="s2">&quot;character_rules_handled&quot;</span><span class="p">:</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;character_rules_handled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
					<span class="mi">0</span>
				<span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;character&quot;</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">:</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
					<span class="s2">&quot;unit_rules_handled&quot;</span>
				<span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">unit</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">:</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
					<span class="s2">&quot;character_thing_rules_handled&quot;</span>
				<span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;character-thing&quot;</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">thing</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">:</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
					<span class="s2">&quot;character_place_rules_handled&quot;</span>
				<span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;character-place&quot;</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;place&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">place</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">:</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
					<span class="s2">&quot;character_portal_rules_handled&quot;</span>
				<span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;character-portal&quot;</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;node_rules_handled&quot;</span><span class="p">:</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;node_rules_handled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
					<span class="mi">0</span>
				<span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
				<span class="n">ret</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_fill_branch_element</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
		<span class="n">turn_ends</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]],</span>
		<span class="n">keyframe_times</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Time</span><span class="p">],</span>
		<span class="n">data</span><span class="p">:</span> <span class="n">LoadedDict</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">branch_</span> <span class="o">=</span> <span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">branch_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;branch missing&quot;</span><span class="p">)</span>
		<span class="n">branch_now</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">(</span><span class="n">branch_</span><span class="p">)</span>

		<span class="n">uncharacterized</span> <span class="o">=</span> <span class="n">ILLEGAL_CHARACTER_NAMES</span>
		<span class="k">for</span> <span class="n">turn_now</span><span class="p">,</span> <span class="p">(</span><span class="n">ending_tick</span><span class="p">,</span> <span class="n">plan_ending_tick</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
			<span class="n">turn_ends</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="n">turn_el</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span>
				<span class="s2">&quot;turn&quot;</span><span class="p">,</span>
				<span class="p">{</span>
					<span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">turn_now</span><span class="p">),</span>
					<span class="s2">&quot;end-tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ending_tick</span><span class="p">),</span>
					<span class="s2">&quot;plan-end-tick&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">plan_ending_tick</span><span class="p">),</span>
				<span class="p">},</span>
			<span class="p">)</span>
			<span class="n">branch_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_el</span><span class="p">)</span>
			<span class="n">current_rule_el</span><span class="p">:</span> <span class="n">Element</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_rule_el</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">current_rule_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">turn_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_rule_el</span><span class="p">)</span>

			<span class="k">def</span><span class="w"> </span><span class="nf">get_current_el</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Element</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">current_rule_el</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">turn_el</span>
				<span class="k">return</span> <span class="n">current_rule_el</span>

			<span class="n">tick_now</span><span class="p">:</span> <span class="n">Tick</span>
			<span class="k">for</span> <span class="n">tick_now</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plan_ending_tick</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
				<span class="n">now</span> <span class="o">=</span> <span class="p">(</span><span class="n">branch_now</span><span class="p">,</span> <span class="n">turn_now</span><span class="p">,</span> <span class="n">tick_now</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">current_rule_el</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">current_rule_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_rule_el</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">current_rule_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">turn_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_rule_el</span><span class="p">)</span>
				<span class="c1"># Loop over rules that didn&#39;t result in any changes, if needed</span>
				<span class="k">while</span> <span class="n">current_rule_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tick_now</span> <span class="o">&gt;=</span> <span class="p">(</span>
					<span class="nb">int</span><span class="p">(</span><span class="n">current_rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end-tick&quot;</span><span class="p">))</span>
				<span class="p">):</span>
					<span class="n">current_rule_el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_rule_el</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">current_rule_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">current_rule_el</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
						<span class="n">turn_el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_rule_el</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">now</span> <span class="ow">in</span> <span class="n">keyframe_times</span><span class="p">:</span>
					<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keyframe</span><span class="p">(</span><span class="n">branch_now</span><span class="p">,</span> <span class="n">turn_now</span><span class="p">,</span> <span class="n">tick_now</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_add_keyframe_to_turn_el</span><span class="p">(</span><span class="n">turn_el</span><span class="p">,</span> <span class="n">tick_now</span><span class="p">,</span> <span class="n">kf</span><span class="p">)</span>
					<span class="n">keyframe_times</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">branch_now</span><span class="p">,</span> <span class="n">turn_now</span><span class="p">,</span> <span class="n">tick_now</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">uncharacter</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uncharacterized</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">recs</span> <span class="o">:=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uncharacter</span><span class="p">):</span>
						<span class="n">rec</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						<span class="k">while</span> <span class="n">rec</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">now</span><span class="p">:</span>
							<span class="n">el</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">uncharacter</span><span class="si">}</span><span class="s2">_el&quot;</span><span class="p">)(</span><span class="n">rec</span><span class="p">)</span>
							<span class="n">get_current_el</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
							<span class="k">del</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
							<span class="k">if</span> <span class="ow">not</span> <span class="n">recs</span><span class="p">:</span>
								<span class="k">break</span>
							<span class="n">rec</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">char_name</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">uncharacterized</span><span class="p">):</span>
					<span class="n">char_data</span><span class="p">:</span> <span class="n">LoadedCharWindow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span>
					<span class="n">charkey_literal</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
						<span class="s2">&quot;graph_val&quot;</span><span class="p">,</span>
						<span class="s2">&quot;nodes&quot;</span><span class="p">,</span>
						<span class="s2">&quot;node_val&quot;</span><span class="p">,</span>
						<span class="s2">&quot;edges&quot;</span><span class="p">,</span>
						<span class="s2">&quot;edge_val&quot;</span><span class="p">,</span>
						<span class="s2">&quot;units&quot;</span><span class="p">,</span>
						<span class="s2">&quot;node_rulebook&quot;</span><span class="p">,</span>
						<span class="s2">&quot;portal_rulebook&quot;</span><span class="p">,</span>
						<span class="s2">&quot;things&quot;</span><span class="p">,</span>
					<span class="p">]</span>
					<span class="n">charkey</span><span class="p">:</span> <span class="n">charkey_literal</span>
					<span class="k">for</span> <span class="n">charkey</span> <span class="ow">in</span> <span class="n">get_args</span><span class="p">(</span><span class="n">charkey_literal</span><span class="p">):</span>
						<span class="k">if</span> <span class="n">recs</span> <span class="o">:=</span> <span class="n">char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">charkey</span><span class="p">):</span>
							<span class="n">rec</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
							<span class="k">while</span> <span class="n">rec</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">now</span><span class="p">:</span>
								<span class="n">el</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">charkey</span><span class="si">}</span><span class="s2">_el&quot;</span><span class="p">)(</span><span class="n">rec</span><span class="p">)</span>
								<span class="n">get_current_el</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
								<span class="k">del</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">recs</span><span class="p">:</span>
									<span class="k">break</span>
								<span class="n">rec</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">char_rb_typ_literal</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
						<span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span>
						<span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span>
						<span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span>
						<span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span>
						<span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span>
					<span class="p">]</span>
					<span class="n">char_rb_typ</span><span class="p">:</span> <span class="n">char_rb_typ_literal</span>
					<span class="k">for</span> <span class="n">char_rb_typ</span> <span class="ow">in</span> <span class="n">get_args</span><span class="p">(</span><span class="n">char_rb_typ_literal</span><span class="p">):</span>
						<span class="k">if</span> <span class="n">char_rb_rows</span> <span class="o">:=</span> <span class="n">char_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">char_rb_typ</span><span class="p">):</span>
							<span class="n">char_rb_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]</span>
							<span class="n">char_rb_row</span> <span class="o">=</span> <span class="n">char_rb_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
							<span class="k">while</span> <span class="n">now</span> <span class="o">==</span> <span class="n">char_rb_row</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
								<span class="n">crbel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_char_rb_el</span><span class="p">(</span>
									<span class="n">char_rb_typ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
									<span class="n">char_rb_row</span><span class="p">,</span>
								<span class="p">)</span>
								<span class="n">get_current_el</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crbel</span><span class="p">)</span>
								<span class="k">del</span> <span class="n">char_rb_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">char_rb_rows</span><span class="p">:</span>
									<span class="k">break</span>
								<span class="n">char_rb_row</span> <span class="o">=</span> <span class="n">char_rb_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">uncharacterized</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="k">assert</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Leftover data in </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
		<span class="k">for</span> <span class="n">char_name</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">uncharacterized</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">assert</span> <span class="ow">not</span> <span class="n">v</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Leftover data in </span><span class="si">{</span><span class="n">char_name</span><span class="si">}</span><span class="s2">&#39;s </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">keyframe_times</span><span class="p">,</span> <span class="n">keyframe_times</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_known_triggers</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">RuleName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]],</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">))</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_known_prereqs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">RuleName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]],</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">))</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_known_actions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">RuleName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]],</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">))</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_known_neighborhoods</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">RuleName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">RuleNeighborhood</span><span class="p">],</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">))</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_known_big</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">RuleName</span><span class="p">,</span>
		<span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">RuleBig</span><span class="p">]],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">))</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_plan_times</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Plan</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">Time</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_element_to_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span> <span class="o">|</span> <span class="n">EllipsisType</span><span class="p">:</span>
		<span class="n">eng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
		<span class="k">match</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
			<span class="k">case</span> <span class="s2">&quot;Ellipsis&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="o">...</span>
			<span class="k">case</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)))</span>
			<span class="k">case</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)))</span>
			<span class="k">case</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
			<span class="k">case</span> <span class="s2">&quot;bool&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>
			<span class="k">case</span> <span class="s2">&quot;character&quot;</span><span class="p">:</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">eng</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
			<span class="k">case</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
				<span class="n">char_name</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
				<span class="n">place_name</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">eng</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">place_name</span><span class="p">])</span>
			<span class="k">case</span> <span class="s2">&quot;portal&quot;</span><span class="p">:</span>
				<span class="n">char_name</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
				<span class="n">orig</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)))</span>
				<span class="n">dest</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">eng</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">dest</span><span class="p">])</span>
			<span class="k">case</span> <span class="s2">&quot;list&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">listel</span><span class="p">)</span> <span class="k">for</span> <span class="n">listel</span> <span class="ow">in</span> <span class="n">el</span><span class="p">])</span>
			<span class="k">case</span> <span class="s2">&quot;tuple&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span>
					<span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">tupel</span><span class="p">)</span> <span class="k">for</span> <span class="n">tupel</span> <span class="ow">in</span> <span class="n">el</span><span class="p">)</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">setel</span><span class="p">)</span> <span class="k">for</span> <span class="n">setel</span> <span class="ow">in</span> <span class="n">el</span><span class="p">})</span>
			<span class="k">case</span> <span class="s2">&quot;frozenset&quot;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span>
					<span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">setel</span><span class="p">)</span> <span class="k">for</span> <span class="n">setel</span> <span class="ow">in</span> <span class="n">el</span><span class="p">)</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;dict&quot;</span><span class="p">:</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">for</span> <span class="n">dict_item_el</span> <span class="ow">in</span> <span class="n">el</span><span class="p">:</span>
					<span class="n">ret</span><span class="p">[</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">dict_item_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">(</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">dict_item_el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="p">)</span>
				<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;exception&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
					<span class="s2">&quot;Deserializing exceptions from XML not implemented&quot;</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="n">s</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">{</span>
				<span class="s2">&quot;trigger&quot;</span><span class="p">,</span>
				<span class="s2">&quot;prereq&quot;</span><span class="p">,</span>
				<span class="s2">&quot;action&quot;</span><span class="p">,</span>
				<span class="s2">&quot;function&quot;</span><span class="p">,</span>
				<span class="s2">&quot;method&quot;</span><span class="p">,</span>
			<span class="p">}:</span>
				<span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">eng</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
			<span class="k">case</span> <span class="n">default</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t deserialize the element&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Time</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">Branch</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)),</span>
			<span class="n">Turn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">turn_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">))),</span>
			<span class="n">Tick</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">))),</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;nonstring branch&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_keyframe_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">kf_el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">kf_el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">keyframe_insert</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">universal_kf</span><span class="p">:</span> <span class="n">UniversalKeyframe</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">triggers_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">prereqs_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">actions_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">neighborhoods_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">bigs_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleBig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">rule_kf</span><span class="p">:</span> <span class="n">RuleKeyframe</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;triggers&quot;</span><span class="p">:</span> <span class="n">triggers_kf</span><span class="p">,</span>
			<span class="s2">&quot;prereqs&quot;</span><span class="p">:</span> <span class="n">prereqs_kf</span><span class="p">,</span>
			<span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="n">actions_kf</span><span class="p">,</span>
			<span class="s2">&quot;neighborhood&quot;</span><span class="p">:</span> <span class="n">neighborhoods_kf</span><span class="p">,</span>
			<span class="s2">&quot;big&quot;</span><span class="p">:</span> <span class="n">bigs_kf</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="n">rulebook_kf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
			<span class="n">RulebookName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]</span>
		<span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">graph_val_kf</span><span class="p">:</span> <span class="n">GraphValKeyframe</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">node_val_kf</span><span class="p">:</span> <span class="n">GraphNodeValKeyframe</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">edge_val_kf</span><span class="p">:</span> <span class="n">GraphEdgeValKeyframe</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">subel</span> <span class="ow">in</span> <span class="n">kf_el</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">subel</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;universal&quot;</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">univel</span> <span class="ow">in</span> <span class="n">subel</span><span class="p">:</span>
					<span class="n">k</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">univel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))</span>
					<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">univel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">universal_kf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
			<span class="k">elif</span> <span class="n">subel</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span>
				<span class="n">rule</span> <span class="o">=</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">rule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Rules need names&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="s2">&quot;big&quot;</span> <span class="ow">in</span> <span class="n">subel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">bigs_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="n">RuleBig</span><span class="p">(</span><span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;big&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>
				<span class="k">if</span> <span class="s2">&quot;neighborhood&quot;</span> <span class="ow">in</span> <span class="n">subel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">neighborhoods_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;neighborhood&quot;</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">neighborhoods_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="k">for</span> <span class="n">funcl_el</span> <span class="ow">in</span> <span class="n">subel</span><span class="p">:</span>
					<span class="n">name</span> <span class="o">=</span> <span class="n">FuncName</span><span class="p">(</span><span class="n">funcl_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
						<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Function name must be str&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">funcl_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">triggers_kf</span><span class="p">:</span>
							<span class="n">triggers_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TriggerFuncName</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">triggers_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
					<span class="k">elif</span> <span class="n">funcl_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;prereq&quot;</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">prereqs_kf</span><span class="p">:</span>
							<span class="n">prereqs_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PrereqFuncName</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">prereqs_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
					<span class="k">elif</span> <span class="n">funcl_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;action&quot;</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">actions_kf</span><span class="p">:</span>
							<span class="n">actions_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionFuncName</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">actions_kf</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ActionFuncName</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown rule tag&quot;</span><span class="p">,</span> <span class="n">funcl_el</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">subel</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;rulebook&quot;</span><span class="p">:</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;rulebook tag missing name&quot;</span><span class="p">)</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Rulebook name must be Key&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="n">prio</span> <span class="o">=</span> <span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">prio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;rulebook tag missing priority&quot;</span><span class="p">)</span>
				<span class="n">prio</span> <span class="o">=</span> <span class="n">RulebookPriority</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">prio</span><span class="p">))</span>
				<span class="n">rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">rule_el</span> <span class="ow">in</span> <span class="n">subel</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">rule_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected a rule tag&quot;</span><span class="p">,</span> <span class="n">rule_el</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
					<span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RuleName</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)))</span>
				<span class="n">rulebook_kf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">prio</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">subel</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;character&quot;</span><span class="p">:</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;character tag missing name&quot;</span><span class="p">)</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;character names must be Key&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
				<span class="n">char_name</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">EngineFacade</span><span class="p">):</span>
					<span class="c1"># Only needed for deserializing later entities.</span>
					<span class="c1"># Real Engines don&#39;t require this, because they have the</span>
					<span class="c1"># keyframe to work with.</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">add_character</span><span class="p">(</span><span class="n">char_name</span><span class="p">)</span>
				<span class="n">graph_vals</span> <span class="o">=</span> <span class="n">graph_val_kf</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
					<span class="s2">&quot;character-rulebook&quot;</span><span class="p">,</span>
					<span class="s2">&quot;unit-rulebook&quot;</span><span class="p">,</span>
					<span class="s2">&quot;character-thing-rulebook&quot;</span><span class="p">,</span>
					<span class="s2">&quot;character-place-rulebook&quot;</span><span class="p">,</span>
					<span class="s2">&quot;character-portal-rulebook&quot;</span><span class="p">,</span>
				<span class="p">):</span>
					<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">subel</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
						<span class="n">graph_vals</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span>
							<span class="n">subel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
						<span class="p">)</span>
				<span class="n">node_vals</span> <span class="o">=</span> <span class="n">node_val_kf</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="n">edge_vals</span> <span class="o">=</span> <span class="n">edge_val_kf</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">for</span> <span class="n">key_el</span> <span class="ow">in</span> <span class="n">subel</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">key_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;dict-item&quot;</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">key_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))</span>
						<span class="n">graph_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">key_el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="k">elif</span> <span class="n">key_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
						<span class="n">name</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">key_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">EngineFacade</span><span class="p">):</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node_vals</span><span class="p">:</span>
							<span class="n">val</span> <span class="o">=</span> <span class="n">node_vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">val</span> <span class="o">=</span> <span class="n">node_vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
						<span class="k">if</span> <span class="s2">&quot;rulebook&quot;</span> <span class="ow">in</span> <span class="n">key_el</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
							<span class="n">val</span><span class="p">[</span><span class="s2">&quot;rulebook&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span>
								<span class="n">key_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)</span>
							<span class="p">)</span>
						<span class="k">for</span> <span class="n">item_el</span> <span class="ow">in</span> <span class="n">key_el</span><span class="p">:</span>
							<span class="n">val</span><span class="p">[</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">(</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">item_el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
							<span class="p">)</span>
					<span class="k">elif</span> <span class="n">key_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;edge&quot;</span><span class="p">:</span>
						<span class="n">orig</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">key_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orig&quot;</span><span class="p">))</span>
						<span class="n">dest</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">key_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dest&quot;</span><span class="p">))</span>
						<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">EngineFacade</span><span class="p">):</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">char_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
								<span class="n">orig</span><span class="p">,</span> <span class="n">dest</span>
							<span class="p">)</span>
						<span class="k">if</span> <span class="n">orig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_vals</span><span class="p">:</span>
							<span class="n">edge_vals</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dest</span><span class="p">:</span> <span class="p">{}}</span>
						<span class="k">if</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_vals</span><span class="p">[</span><span class="n">orig</span><span class="p">]:</span>
							<span class="n">edge_vals</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
						<span class="n">val</span> <span class="o">=</span> <span class="n">edge_vals</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">dest</span><span class="p">]</span>
						<span class="k">if</span> <span class="s2">&quot;rulebook&quot;</span> <span class="ow">in</span> <span class="n">key_el</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
							<span class="n">val</span><span class="p">[</span><span class="s2">&quot;rulebook&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span>
								<span class="n">key_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)</span>
							<span class="p">)</span>
						<span class="k">for</span> <span class="n">item_el</span> <span class="ow">in</span> <span class="n">key_el</span><span class="p">:</span>
							<span class="n">val</span><span class="p">[</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">item_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))]</span> <span class="o">=</span> <span class="p">(</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">item_el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
							<span class="p">)</span>
					<span class="k">elif</span> <span class="n">key_el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span>
						<span class="n">graph_vals</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
						<span class="k">for</span> <span class="n">unit_graph_el</span> <span class="ow">in</span> <span class="n">key_el</span><span class="p">:</span>
							<span class="n">unit_graph_name</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span>
								<span class="n">unit_graph_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)</span>
							<span class="p">)</span>
							<span class="n">unit_graph_nodes_d</span> <span class="o">=</span> <span class="n">graph_vals</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">][</span>
								<span class="n">unit_graph_name</span>
							<span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
							<span class="k">for</span> <span class="n">unit_node_el</span> <span class="ow">in</span> <span class="n">unit_graph_el</span><span class="p">:</span>
								<span class="n">unit_graph_nodes_d</span><span class="p">[</span>
									<span class="n">literal_eval</span><span class="p">(</span><span class="n">unit_node_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">))</span>
								<span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
							<span class="s2">&quot;Don&#39;t know how to deal with tag&quot;</span><span class="p">,</span> <span class="n">key_el</span><span class="o">.</span><span class="n">tag</span>
						<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to deal with tag&quot;</span><span class="p">,</span> <span class="n">subel</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">keyframe_insert</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">keyframe_extension_insert</span><span class="p">(</span>
			<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">universal_kf</span><span class="p">,</span> <span class="n">rule_kf</span><span class="p">,</span> <span class="n">rulebook_kf</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="p">(</span>
			<span class="n">graph_val_kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">node_val_kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">edge_val_kf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">keyframe_graph_insert</span><span class="p">(</span>
				<span class="n">graph</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn</span><span class="p">,</span>
				<span class="n">tick</span><span class="p">,</span>
				<span class="n">node_val_kf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="p">{}),</span>
				<span class="n">edge_val_kf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="p">{}),</span>
				<span class="n">graph_val_kf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="p">{}),</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_universal_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">UniversalKey</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">universal_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_plans</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="s2">&quot;plans&quot;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">plan_id</span><span class="p">:</span> <span class="n">Plan</span>
			<span class="k">for</span> <span class="n">plan_id</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)):</span>
				<span class="k">if</span> <span class="n">plan_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="p">[</span><span class="n">plan_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="p">[</span><span class="n">plan_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_func_list</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">what</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;triggers&quot;</span><span class="p">,</span> <span class="s2">&quot;prereqs&quot;</span><span class="p">,</span> <span class="s2">&quot;actions&quot;</span><span class="p">],</span>
		<span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
		<span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
		<span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">rule</span> <span class="o">=</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">))</span>
		<span class="n">funcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">func_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">func_el</span> <span class="ow">in</span> <span class="n">el</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_memorize_rule</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">funcs</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_memorize_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">what</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;triggers&quot;</span><span class="p">,</span> <span class="s2">&quot;prereqs&quot;</span><span class="p">,</span> <span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="s2">&quot;neighborhood&quot;</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">],</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">datum</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]</span>
		<span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]</span>
		<span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]</span>
		<span class="o">|</span> <span class="n">RuleNeighborhood</span>
		<span class="o">|</span> <span class="n">RuleBig</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;triggers&quot;</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_triggers</span>
		<span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;prereqs&quot;</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_prereqs</span>
		<span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;actions&quot;</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_actions</span>
		<span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;neighborhood&quot;</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_neighborhoods</span>
		<span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_big</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
		<span class="n">d</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">datum</span><span class="p">)</span>

	<span class="n">_rule_triggers_rec</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">_rule_func_list</span><span class="p">,</span> <span class="s2">&quot;triggers&quot;</span><span class="p">)</span>
	<span class="n">_rule_prereqs_rec</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">_rule_func_list</span><span class="p">,</span> <span class="s2">&quot;prereqs&quot;</span><span class="p">)</span>
	<span class="n">_rule_actions_rec</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">_rule_func_list</span><span class="p">,</span> <span class="s2">&quot;actions&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_neighborhood_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">rule</span> <span class="o">=</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">))</span>
		<span class="n">neighborhood</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;neighbors&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">neighborhood</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">neighborhood</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">neighborhood</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_memorize_rule</span><span class="p">(</span>
			<span class="s2">&quot;neighborhood&quot;</span><span class="p">,</span>
			<span class="n">rule</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">neighborhood</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_big_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">big</span> <span class="o">=</span> <span class="n">RuleBig</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;big&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>
		<span class="n">rule</span> <span class="o">=</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rule&quot;</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_memorize_rule</span><span class="p">(</span><span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">rbn</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">rulebook</span> <span class="o">=</span> <span class="n">RulebookName</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">rbn</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook name&quot;</span><span class="p">,</span> <span class="n">rbn</span><span class="p">,</span> <span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
		<span class="n">pri</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priority&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">priority</span> <span class="o">=</span> <span class="n">RulebookPriority</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pri</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook priority&quot;</span><span class="p">,</span> <span class="n">pri</span><span class="p">,</span> <span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
		<span class="n">child_el</span><span class="p">:</span> <span class="n">Element</span>
		<span class="n">rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">child_el</span> <span class="ow">in</span> <span class="n">el</span><span class="p">:</span>
			<span class="n">rule</span> <span class="o">=</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">child_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
			<span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks2set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
			<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_graph_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">graph</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">typ_str_</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">typ_str_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Missing graph type&quot;</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">GraphTypeStr</span><span class="p">,</span> <span class="s2">&quot;evaluate_value&quot;</span><span class="p">):</span>
			<span class="n">literal</span> <span class="o">=</span> <span class="n">GraphTypeStr</span><span class="o">.</span><span class="n">evaluate_value</span><span class="p">()</span>
		<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">GraphTypeStr</span><span class="p">,</span> <span class="s2">&quot;__value__&quot;</span><span class="p">):</span>
			<span class="n">literal</span> <span class="o">=</span> <span class="n">GraphTypeStr</span><span class="o">.</span><span class="n">__value__</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">literal</span> <span class="o">=</span> <span class="n">GraphTypeStr</span>
		<span class="k">if</span> <span class="n">typ_str_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_args</span><span class="p">(</span><span class="n">literal</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unknown graph type&quot;</span><span class="p">,</span> <span class="n">typ_str_</span><span class="p">)</span>
		<span class="n">typ_str</span><span class="p">:</span> <span class="n">GraphTypeStr</span> <span class="o">=</span> <span class="n">typ_str_</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">graphs_insert</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">typ_str</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_graph_val_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">graph</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">Stat</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">graph_val_set</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_node_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)))</span>
		<span class="n">ex</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exists&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">exist_node</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_node_val_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)))</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">Stat</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">node_val_set</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_edge_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">orig</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orig&quot;</span><span class="p">)))</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dest&quot;</span><span class="p">)))</span>
		<span class="n">ex</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exists&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">exist_edge</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_edge_val_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">orig</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orig&quot;</span><span class="p">)))</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dest&quot;</span><span class="p">)))</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">Stat</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">edge_val_set</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_location_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">thing</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">)))</span>
		<span class="n">location</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_thing_loc</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unit_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character-graph&quot;</span><span class="p">)))</span>
		<span class="n">graph</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit-graph&quot;</span><span class="p">)))</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit-node&quot;</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">unit_set</span><span class="p">(</span>
			<span class="n">char</span><span class="p">,</span>
			<span class="n">graph</span><span class="p">,</span>
			<span class="n">node</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn</span><span class="p">,</span>
			<span class="n">tick</span><span class="p">,</span>
			<span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is-unit&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_some_character_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">rbtyp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;set_</span><span class="si">{</span><span class="n">rbtyp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">rb</span> <span class="o">=</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)))</span>
		<span class="n">meth</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_character_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_some_character_rulebook</span><span class="p">(</span>
			<span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span> <span class="n">el</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unit_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_some_character_rulebook</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_character_thing_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_some_character_rulebook</span><span class="p">(</span>
			<span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span> <span class="n">el</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_character_place_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_some_character_rulebook</span><span class="p">(</span>
			<span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span> <span class="n">el</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_character_portal_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_some_character_rulebook</span><span class="p">(</span>
			<span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span> <span class="n">el</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_node_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)))</span>
		<span class="n">rb</span> <span class="o">=</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_node_rulebook</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_portal_rulebook_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_get_plans</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="n">char</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">orig</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orig&quot;</span><span class="p">)))</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dest&quot;</span><span class="p">)))</span>
		<span class="n">rb</span> <span class="o">=</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_portal_rulebook</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>

	<span class="nd">@classmethod</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_iter_descendants</span><span class="p">(</span>
		<span class="bp">cls</span><span class="p">,</span>
		<span class="n">branch_descendants</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Branch</span><span class="p">]],</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span> <span class="o">=</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span>
		<span class="n">stop</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
		<span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">branch_descendants</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">branch_descendants</span><span class="p">[</span><span class="n">branch</span><span class="p">]:</span>
			<span class="k">yield</span> <span class="n">desc</span>
			<span class="k">if</span> <span class="n">stop</span><span class="p">(</span><span class="n">desc</span><span class="p">):</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">branch_descendants</span><span class="p">:</span>
				<span class="k">yield from</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_iter_descendants</span><span class="p">(</span><span class="n">branch_descendants</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_create_rule_from_etree</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="p">[</span>
			<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_triggers</span><span class="p">,</span> <span class="s2">&quot;triggers&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_prereqs</span><span class="p">,</span> <span class="s2">&quot;prereqs&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_actions</span><span class="p">,</span> <span class="s2">&quot;actions&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_neighborhoods</span><span class="p">,</span> <span class="s2">&quot;neighborhood&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_big</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">),</span>
		<span class="p">]:</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="n">rule</span> <span class="ow">in</span> <span class="n">mapping</span>
				<span class="ow">and</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span>
				<span class="ow">and</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span>
				<span class="ow">and</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span>
			<span class="p">):</span>
				<span class="n">kwargs</span><span class="p">[</span><span class="n">kwarg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">rule_el</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">branch</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
		<span class="n">turn</span> <span class="o">=</span> <span class="n">Turn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">turn_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)))</span>
		<span class="n">tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end-tick&quot;</span><span class="p">)))</span>
		<span class="n">character</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;character&quot;</span><span class="p">)))</span>
		<span class="n">rulebook</span> <span class="o">=</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rulebook&quot;</span><span class="p">)))</span>
		<span class="n">rule</span> <span class="o">=</span> <span class="n">RuleName</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule name&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
		<span class="k">match</span> <span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span>
			<span class="k">case</span> <span class="s2">&quot;character&quot;</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_character_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span>
				<span class="n">graph</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graph&quot;</span><span class="p">)))</span>
				<span class="n">unit</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_unit_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">graph</span><span class="p">,</span>
					<span class="n">unit</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;character-thing&quot;</span><span class="p">:</span>
				<span class="n">thing</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_character_thing_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">thing</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;character-place&quot;</span><span class="p">:</span>
				<span class="n">place</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;place&quot;</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_character_place_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">place</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;character-portal&quot;</span><span class="p">:</span>
				<span class="n">orig</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)))</span>
				<span class="n">dest</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_character_portal_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">orig</span><span class="p">,</span>
					<span class="n">dest</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
				<span class="n">node</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_node_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">node</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">case</span> <span class="s2">&quot;portal&quot;</span><span class="p">:</span>
				<span class="n">orig</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)))</span>
				<span class="n">dest</span> <span class="o">=</span> <span class="n">NodeName</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">rule_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">)))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">handled_portal_rule</span><span class="p">(</span>
					<span class="n">character</span><span class="p">,</span>
					<span class="n">orig</span><span class="p">,</span>
					<span class="n">dest</span><span class="p">,</span>
					<span class="n">rulebook</span><span class="p">,</span>
					<span class="n">rule</span><span class="p">,</span>
					<span class="n">branch</span><span class="p">,</span>
					<span class="n">turn</span><span class="p">,</span>
					<span class="n">tick</span><span class="p">,</span>
				<span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_element_dispatch_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;keyframe&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe_rec</span><span class="p">,</span>
			<span class="s2">&quot;universal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universal_rec</span><span class="p">,</span>
			<span class="s2">&quot;rule-triggers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_triggers_rec</span><span class="p">,</span>
			<span class="s2">&quot;rule-prereqs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_prereqs_rec</span><span class="p">,</span>
			<span class="s2">&quot;rule-actions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_actions_rec</span><span class="p">,</span>
			<span class="s2">&quot;rule-neighborhood&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_neighborhood_rec</span><span class="p">,</span>
			<span class="s2">&quot;rule-big&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_big_rec</span><span class="p">,</span>
			<span class="s2">&quot;rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;graph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_rec</span><span class="p">,</span>
			<span class="s2">&quot;graph-val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_val_rec</span><span class="p">,</span>
			<span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_rec</span><span class="p">,</span>
			<span class="s2">&quot;node-val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_val_rec</span><span class="p">,</span>
			<span class="s2">&quot;edge&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_rec</span><span class="p">,</span>
			<span class="s2">&quot;edge-val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_val_rec</span><span class="p">,</span>
			<span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_location_rec</span><span class="p">,</span>
			<span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_rec</span><span class="p">,</span>
			<span class="s2">&quot;character-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;unit-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;character-thing-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_thing_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;character-place-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_place_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;character-portal-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_portal_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;node-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_rulebook_rec</span><span class="p">,</span>
			<span class="s2">&quot;portal-rulebook&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_rulebook_rec</span><span class="p">,</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_dispatch_element</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span> <span class="n">elem</span><span class="p">:</span> <span class="n">Element</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_element_dispatch_table</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">](</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">load_etree</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">tree</span><span class="p">:</span> <span class="n">ElementTree</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
		<span class="n">branch_descendants</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Branch</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">Branch</span><span class="p">(</span><span class="s2">&quot;trunk&quot;</span><span class="p">):</span> <span class="p">[]}</span>
		<span class="n">branch_starts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="s2">&quot;_lisien_schema_version&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;_lisien_schema_version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span>
				<span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db-schema-version&quot;</span><span class="p">)</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Incompatible database versions&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;_lisien_schema_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
				<span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db-schema-version&quot;</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;xml-schema-version&quot;</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xml-schema-version&quot;</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">ver</span> <span class="o">&gt;</span> <span class="n">XML_SCHEMA_VERSION</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Incompatible XML schema version&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;trunk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trunk&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;turn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;turn&quot;</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;tick&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;language&quot;</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;playtree&quot;</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">branch_el</span> <span class="ow">in</span> <span class="n">el</span><span class="p">:</span>
					<span class="n">parent</span><span class="p">:</span> <span class="n">Branch</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
					<span class="n">branch</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
					<span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">branch_descendants</span><span class="p">:</span>
							<span class="n">branch_descendants</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">branch_descendants</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="n">start_turn</span> <span class="o">=</span> <span class="n">Turn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start-turn&quot;</span><span class="p">)))</span>
					<span class="n">start_tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start-tick&quot;</span><span class="p">)))</span>
					<span class="n">branch_starts</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_turn</span><span class="p">,</span> <span class="n">start_tick</span><span class="p">)</span>
					<span class="n">end_turn</span> <span class="o">=</span> <span class="n">Turn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end-turn&quot;</span><span class="p">)))</span>
					<span class="n">end_tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end-tick&quot;</span><span class="p">)))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">set_branch</span><span class="p">(</span>
						<span class="n">branch</span><span class="p">,</span>
						<span class="n">parent</span><span class="p">,</span>
						<span class="n">start_turn</span><span class="p">,</span>
						<span class="n">start_tick</span><span class="p">,</span>
						<span class="n">end_turn</span><span class="p">,</span>
						<span class="n">end_tick</span><span class="p">,</span>
					<span class="p">)</span>
					<span class="k">if</span> <span class="s2">&quot;last-turn-completed&quot;</span> <span class="ow">in</span> <span class="n">branch_el</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
						<span class="n">last_completed_turn</span> <span class="o">=</span> <span class="n">Turn</span><span class="p">(</span>
							<span class="nb">int</span><span class="p">(</span><span class="n">branch_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last-turn-completed&quot;</span><span class="p">))</span>
						<span class="p">)</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">complete_turn</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">last_completed_turn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

					<span class="k">for</span> <span class="n">turn_el</span> <span class="ow">in</span> <span class="n">branch_el</span><span class="p">:</span>
						<span class="n">turn</span> <span class="o">=</span> <span class="n">Turn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">turn_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)))</span>
						<span class="n">end_tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">turn_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end-tick&quot;</span><span class="p">)))</span>
						<span class="n">plan_end_tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">turn_el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan-end-tick&quot;</span><span class="p">)))</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">set_turn</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">,</span> <span class="n">plan_end_tick</span><span class="p">)</span>
						<span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">turn_el</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;rule&quot;</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_rule</span><span class="p">(</span><span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
								<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
									<span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_element</span><span class="p">(</span>
										<span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">element</span>
									<span class="p">)</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_element</span><span class="p">(</span>
									<span class="n">branch_el</span><span class="p">,</span> <span class="n">turn_el</span><span class="p">,</span> <span class="n">elem</span>
								<span class="p">)</span>
				<span class="n">known_rules</span> <span class="o">=</span> <span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_known_triggers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
					<span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_prereqs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
					<span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_actions</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
					<span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_neighborhoods</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
					<span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_big</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
				<span class="p">)</span>
				<span class="n">trunk</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trunk&quot;</span><span class="p">))</span>
				<span class="n">rules_created</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_dump</span><span class="p">())</span>
				<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">known_rules</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">mapp</span> <span class="ow">in</span> <span class="p">[</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_triggers</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_prereqs</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_actions</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_neighborhoods</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_big</span><span class="p">,</span>
					<span class="p">]:</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapp</span><span class="p">:</span>
							<span class="k">continue</span>
						<span class="k">if</span> <span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rules_created</span><span class="p">:</span>
							<span class="c1"># Iterate depth first down the timestream, but no</span>
							<span class="c1"># deeper than when the rule is first set.</span>
							<span class="c1"># The game may have a rule by the same name</span>
							<span class="c1"># created in many branches independently.</span>
							<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="p">(</span>
								<span class="n">trunk</span><span class="p">,</span>
								<span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_descendants</span><span class="p">(</span>
									<span class="n">branch_descendants</span><span class="p">,</span>
									<span class="n">trunk</span><span class="p">,</span>
									<span class="n">mapp</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">,</span>
									<span class="n">branch_starts</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
								<span class="p">),</span>
							<span class="p">):</span>
								<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">mapp</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">start_time</span><span class="p">()</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_create_rule_from_etree</span><span class="p">(</span>
									<span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
								<span class="p">)</span>
								<span class="n">rules_created</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">mapp</span><span class="p">,</span> <span class="n">setter</span> <span class="ow">in</span> <span class="p">[</span>
					<span class="p">(</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_triggers</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">set_rule_triggers</span><span class="p">,</span>
					<span class="p">),</span>
					<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_prereqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_rule_prereqs</span><span class="p">),</span>
					<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_actions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_rule_actions</span><span class="p">),</span>
					<span class="p">(</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_known_neighborhoods</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">set_rule_neighborhood</span><span class="p">,</span>
					<span class="p">),</span>
					<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_known_big</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_rule_big</span><span class="p">),</span>
				<span class="p">]:</span>
					<span class="k">for</span> <span class="n">rule</span><span class="p">,</span> <span class="n">branches</span> <span class="ow">in</span> <span class="n">mapp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">assignments</span> <span class="ow">in</span> <span class="n">branches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
							<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">assignments</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
								<span class="c1"># Turn and tick are guaranteed to be in</span>
								<span class="c1"># chronological order here, because that&#39;s what</span>
								<span class="c1"># an AssignmentTimeDict does.</span>
								<span class="n">datum</span> <span class="o">=</span> <span class="n">assignments</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
								<span class="n">setter</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">datum</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">plan</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_times</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">plans_insert</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))</span>
				<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_to_value</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<div class="viewcode-block" id="AbstractDatabaseConnector.load_xml">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.AbstractDatabaseConnector.load_xml">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">load_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_or_file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">|</span> <span class="n">IO</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">]):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Restore data from an XML export</span>

<span class="sd">		Supports a string with the XML in it, a path to an XML file, or</span>
<span class="sd">		a file object.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_etree</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_or_file_path</span><span class="p">))</span></div>
</div>



<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="PythonDatabaseConnector">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.PythonDatabaseConnector">[docs]</a>
<span class="nd">@define</span><span class="p">(</span><span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PythonDatabaseConnector</span><span class="p">(</span><span class="n">AbstractDatabaseConnector</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Database connector that holds all data in memory</span>

<span class="sd">	You&#39;ll have to write it to disk yourself. Use the ``write_xml`` method</span>
<span class="sd">	for that.</span>

<span class="sd">	This does not start any threads, unlike the connectors that really</span>
<span class="sd">	connect to databases, making it an appropriate choice if running in</span>
<span class="sd">	an environment that lacks threading, such as WASI.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">engine</span><span class="p">:</span> <span class="n">AbstractEngine</span>
	<span class="n">_old_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
	<span class="n">is_python</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="n">db_type</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>

	<span class="nd">@_old_data</span><span class="o">.</span><span class="n">validator</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_load_old_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">old_data</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">old_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_everything</span><span class="p">(</span><span class="n">old_data</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">att</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
				<span class="k">continue</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">val</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">att</span><span class="si">}</span><span class="s2"> is nonempty&quot;</span><span class="p">)</span>
					<span class="k">return</span> <span class="kc">False</span>
		<span class="k">return</span> <span class="kc">True</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_bookmarks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Time</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_plan_ticks_insert_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">][</span><span class="n">branch</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span> <span class="ow">or</span> <span class="n">tick</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="n">turn</span><span class="p">]:</span>
			<span class="n">b</span><span class="o">.</span><span class="n">insert_time</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_keyframe_extensions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">AssignmentTimeDict</span><span class="p">[</span>
			<span class="nb">tuple</span><span class="p">[</span><span class="n">UniversalKeyframe</span><span class="p">,</span> <span class="n">RuleKeyframe</span><span class="p">,</span> <span class="n">RulebooksKeyframe</span><span class="p">]</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_keyframes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">Time</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_all_keyframe_times</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">Time</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_keyframes_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">AssignmentTimeDict</span><span class="p">[</span>
			<span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NodeKeyframe</span><span class="p">,</span> <span class="n">EdgeKeyframe</span><span class="p">,</span> <span class="n">StatDict</span><span class="p">]]</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_keyframes_graphs_insert_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">nodes</span><span class="p">:</span> <span class="n">NodeKeyframe</span><span class="p">,</span>
		<span class="n">edges</span><span class="p">:</span> <span class="n">EdgeKeyframe</span><span class="p">,</span>
		<span class="n">graph_val</span><span class="p">:</span> <span class="n">StatDict</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keyframes_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)[</span>
				<span class="n">graph</span>
			<span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
				<span class="n">nodes</span><span class="p">,</span>
				<span class="n">edges</span><span class="p">,</span>
				<span class="n">graph_val</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keyframes_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span>
				<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="p">{</span><span class="n">graph</span><span class="p">:</span> <span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">graph_val</span><span class="p">)}</span>
			<span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_branches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_global</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">EternalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="p">[]</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">eternal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GlobalKeyValueStore</span><span class="p">:</span>
		<span class="n">initial</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">EternalKey</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span>
				<span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span>
				<span class="s2">&quot;turn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s2">&quot;tick&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;eng&quot;</span><span class="p">,</span>
				<span class="s2">&quot;trunk&quot;</span><span class="p">:</span> <span class="s2">&quot;trunk&quot;</span><span class="p">,</span>
				<span class="s2">&quot;_lisien_schema_version&quot;</span><span class="p">:</span> <span class="n">SCHEMA_VERSION</span><span class="p">,</span>
			<span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="n">initial</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_global</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">GlobalKeyValueStore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_turns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tick</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">GraphTypeStr</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_graphs_insert_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="nb">type</span><span class="p">:</span> <span class="n">GraphTypeStr</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">d</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_graph_val</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_nodes</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_node_val</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_edges</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_edge_val</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Stat</span><span class="p">,</span> <span class="n">Value</span><span class="p">]],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_universals</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">UniversalKey</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_universals_insert_rec</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span>
		<span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_universals</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universal_get</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universals</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Universal key not set in this branch&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
		<span class="n">td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universals</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">turn</span> <span class="ow">in</span> <span class="n">td</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">tck</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
				<span class="n">td</span><span class="p">[</span><span class="n">turn</span><span class="p">]</span><span class="o">.</span><span class="n">past</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">include_same_rev</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">):</span>
				<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">v</span>
		<span class="k">for</span> <span class="n">trn</span><span class="p">,</span> <span class="n">tck</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">iter_times</span><span class="p">(</span><span class="n">time_to</span><span class="o">=</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))):</span>
			<span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">trn</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">v</span>
		<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
			<span class="s2">&quot;Universal key not set at this time&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
		<span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rulebooks</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">AssignmentTimeDict</span><span class="p">[</span>
			<span class="nb">tuple</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="n">RulebookPriority</span><span class="p">]</span>
		<span class="p">],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_triggers</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_neighborhood</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_prereqs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_actions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_big</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleBig</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_unit_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_thing_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_place_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_portal_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">PickierDefaultDict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_node_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">],</span> <span class="n">Tick</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_portal_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span>
		<span class="p">],</span>
		<span class="n">Tick</span><span class="p">,</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_things</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_node_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_portal_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span>
		<span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]],</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_units</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">AssignmentTimeDict</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">],</span> <span class="n">Tick</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_unit_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span>
		<span class="p">],</span>
		<span class="n">Tick</span><span class="p">,</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_thing_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">],</span> <span class="n">Tick</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_place_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">],</span> <span class="n">Tick</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_character_portal_rules_handled</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span>
		<span class="p">],</span>
		<span class="n">Tick</span><span class="p">,</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_turns_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">{}</span>

	<span class="n">_table_names</span> <span class="o">=</span> <span class="p">[</span>
		<span class="s2">&quot;_bookmarks&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_global&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_branches&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_turns&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_graphs&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_keyframes&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_keyframes_graphs&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_keyframe_extensions&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_graph_val&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_nodes&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_node_val&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_edges&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_edge_val&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_plans&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_plan_ticks&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_universals&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rules&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rulebooks&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rule_triggers&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rule_neighborhood&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rule_prereqs&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rule_actions&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_rule_big&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_unit_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_thing_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_place_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_portal_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_node_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_portal_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_things&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_node_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_portal_rulebook&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_units&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_unit_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_thing_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_place_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_character_portal_rules_handled&quot;</span><span class="p">,</span>
		<span class="s2">&quot;_turns_completed&quot;</span><span class="p">,</span>
	<span class="p">]</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lock</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">Lock</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">pack</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">obj</span><span class="p">:</span> <span class="n">Key</span>
		<span class="o">|</span> <span class="n">KeyHint</span>
		<span class="o">|</span> <span class="n">EternalKey</span>
		<span class="o">|</span> <span class="n">UniversalKey</span>
		<span class="o">|</span> <span class="n">Stat</span>
		<span class="o">|</span> <span class="n">ValueHint</span>
		<span class="o">|</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">Value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">b</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_load_window</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">:</span> <span class="n">LoadedDict</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">turn_to</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tick_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">tick_to</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
		<span class="n">universals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UniversalRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;universals&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="n">rulebooks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RulebookRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;rulebooks&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="n">rule_triggers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
			<span class="s2">&quot;rule_triggers&quot;</span><span class="p">,</span> <span class="p">[]</span>
		<span class="p">)</span>
		<span class="n">rule_prereqs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;rule_prereqs&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="n">rule_actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;rule_actions&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="n">rule_neighborhood</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleNeighborhoodRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
			<span class="s2">&quot;rule_neighborhood&quot;</span><span class="p">,</span> <span class="p">[]</span>
		<span class="p">)</span>
		<span class="n">rule_big</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleBigRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;rule_big&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="n">character_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CharacterRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;character_rules_handled&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="p">)</span>
		<span class="n">unit_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UnitRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
			<span class="s2">&quot;unit_rules_handled&quot;</span><span class="p">,</span> <span class="p">[]</span>
		<span class="p">)</span>
		<span class="n">character_thing_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;character_thing_rules_handled&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="p">)</span>
		<span class="n">character_place_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;character_place_rules_handled&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="p">)</span>
		<span class="n">character_portal_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;character_portal_rules_handled&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="p">)</span>
		<span class="n">node_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
			<span class="s2">&quot;node_rules_handled&quot;</span><span class="p">,</span> <span class="p">[]</span>
		<span class="p">)</span>
		<span class="n">portal_rules_handled</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
			<span class="s2">&quot;portal_rules_handled&quot;</span><span class="p">,</span> <span class="p">[]</span>
		<span class="p">)</span>
		<span class="n">graphs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;graphs&quot;</span><span class="p">,</span> <span class="p">[])</span>
		<span class="n">rbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">rbs</span><span class="p">:</span>
			<span class="n">rbb</span> <span class="o">=</span> <span class="n">rbs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
				<span class="n">rbb</span><span class="o">.</span><span class="n">iter_times</span><span class="p">((</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">),</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">))</span>
			<span class="p">):</span>
				<span class="n">rulebook</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">rbb</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
				<span class="n">rulebooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
					<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rulebook</span><span class="p">,</span> <span class="n">rules</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">prio</span><span class="p">)</span>
				<span class="p">)</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">:</span>
			<span class="n">turns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
				<span class="n">turns</span><span class="o">.</span><span class="n">iter_times</span><span class="p">((</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">),</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">))</span>
			<span class="p">):</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">turns</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
				<span class="n">graphs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
					<span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
				<span class="p">)</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universals</span><span class="p">:</span>
			<span class="n">turns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universals</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
				<span class="n">turns</span><span class="o">.</span><span class="n">iter_times</span><span class="p">((</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">),</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">))</span>
			<span class="p">):</span>
				<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">turns</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
				<span class="n">universals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">uncharacter_l</span><span class="p">,</span> <span class="n">my_table</span> <span class="ow">in</span> <span class="p">[</span>
			<span class="p">(</span><span class="n">rule_triggers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_triggers</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rule_prereqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_prereqs</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rule_actions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_actions</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rule_neighborhood</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_neighborhood</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rule_big</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_big</span><span class="p">),</span>
		<span class="p">]:</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">my_table</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
					<span class="n">my_table</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">iter_times</span><span class="p">(</span>
						<span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">),</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">)</span>
					<span class="p">)</span>
				<span class="p">):</span>
					<span class="n">rule</span><span class="p">,</span> <span class="n">the_datum</span> <span class="o">=</span> <span class="n">my_table</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span>
						<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">the_datum</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
						<span class="n">the_datum</span> <span class="o">=</span> <span class="n">the_datum</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="n">uncharacter_l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">the_datum</span><span class="p">))</span>
		<span class="n">my_table</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">char_d_key</span><span class="p">,</span> <span class="n">my_table</span> <span class="ow">in</span> <span class="p">[</span>
			<span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;node_val&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_val</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;edge_val&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_val</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;graph_val&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_val</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;things&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_rulebook</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_rulebook</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_thing_rulebook</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_place_rulebook</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_portal_rulebook</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;node_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_rulebook</span><span class="p">),</span>
			<span class="p">(</span><span class="s2">&quot;portal_rulebook&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_rulebook</span><span class="p">),</span>
		<span class="p">]:</span>
			<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_table</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="n">assignments</span> <span class="o">=</span> <span class="n">my_table</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
				<span class="n">assignments</span><span class="o">.</span><span class="n">iter_times</span><span class="p">(</span>
					<span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">),</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">)</span>
				<span class="p">)</span>
			<span class="p">):</span>
				<span class="n">row</span><span class="p">:</span> <span class="n">AssignmentRowType</span> <span class="o">=</span> <span class="n">assignments</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
				<span class="n">g</span><span class="p">:</span> <span class="n">CharName</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">the_list</span><span class="p">:</span> <span class="n">AssignmentRowListType</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">char_d_key</span><span class="p">]</span>
				<span class="n">the_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">row</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">handled_l</span><span class="p">,</span> <span class="n">my_table</span> <span class="ow">in</span> <span class="p">[</span>
			<span class="p">(</span><span class="n">node_rules_handled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_rules_handled</span><span class="p">),</span>
			<span class="p">(</span><span class="n">portal_rules_handled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_rules_handled</span><span class="p">),</span>
			<span class="p">(</span><span class="n">character_rules_handled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_rules_handled</span><span class="p">),</span>
			<span class="p">(</span><span class="n">unit_rules_handled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_rules_handled</span><span class="p">),</span>
			<span class="p">(</span>
				<span class="n">character_thing_rules_handled</span><span class="p">,</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_character_thing_rules_handled</span><span class="p">,</span>
			<span class="p">),</span>
			<span class="p">(</span>
				<span class="n">character_place_rules_handled</span><span class="p">,</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_character_place_rules_handled</span><span class="p">,</span>
			<span class="p">),</span>
			<span class="p">(</span>
				<span class="n">character_portal_rules_handled</span><span class="p">,</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_character_portal_rules_handled</span><span class="p">,</span>
			<span class="p">),</span>
		<span class="p">]:</span>
			<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span>
				<span class="p">{(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">my_table</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
			<span class="p">):</span>
				<span class="n">b</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">branch</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
					<span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">)</span>
					<span class="o">&lt;=</span> <span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="o">&lt;=</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">)</span>
				<span class="p">):</span>
					<span class="k">continue</span>
				<span class="n">datum</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">tick</span><span class="p">)</span>
				<span class="n">handled_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_load_windows_into</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">:</span> <span class="n">LoadedDict</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeWindow</span><span class="p">]</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_load_window</span><span class="p">(</span>
				<span class="n">ret</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">del_bookmark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_bookmarks2set</span><span class="o">.</span><span class="n">cull</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bookmarks</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bookmarks</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">args</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a real database, so can&#39;t call it&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a real database, so can&#39;t call it&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a real database, so can&#39;t call it&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Not a real database, so can&#39;t call it&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">insert_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">tab_serializer</span> <span class="o">=</span> <span class="n">Batch</span><span class="o">.</span><span class="n">serializers</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
		<span class="n">key_len</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrname</span>
		<span class="p">)</span><span class="o">.</span><span class="n">key_len</span>
		<span class="k">if</span> <span class="n">key_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">key_len</span> <span class="o">=</span> <span class="o">...</span>
		<span class="n">tab_spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">tab_serializer</span><span class="p">)</span>
		<span class="n">tab</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">table_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="n">tab</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
				<span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># self, and one actual column name</span>
				<span class="n">the_arg</span> <span class="o">=</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">tab</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">the_arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">tab</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
					<span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span>
				<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">mth</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot;_insert_rec&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
					<span class="n">mth</span><span class="p">(</span><span class="o">**</span><span class="n">rec</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">key_len</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dict table without key_len&quot;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">key_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">key_name</span> <span class="o">=</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
					<span class="n">val_name</span> <span class="o">=</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span>
						<span class="n">tab</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">val_name</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span>
						<span class="n">tab</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
			<span class="k">elif</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">,</span> <span class="s2">&quot;turn&quot;</span><span class="p">,</span> <span class="s2">&quot;tick&quot;</span><span class="p">]:</span>
				<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
					<span class="n">record</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
					<span class="n">tab</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">store_at</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;turn&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tick&quot;</span><span class="p">],</span> <span class="n">record</span><span class="p">)</span>
			<span class="k">elif</span> <span class="p">(</span>
				<span class="n">key_len</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
			<span class="p">):</span>  <span class="c1"># the self argument, and the value</span>
				<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
					<span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
					<span class="n">tab</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
					<span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">key_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
					<span class="n">tab</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
						<span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">key_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
					<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to insert here&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="p">)</span>

	<span class="n">insert_many_silent</span> <span class="o">=</span> <span class="n">insert_many</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">delete_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">cached</span><span class="p">:</span> <span class="n">cached_property</span> <span class="o">=</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
		<span class="n">the_batch</span><span class="p">:</span> <span class="n">Batch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cached</span><span class="o">.</span><span class="n">attrname</span><span class="p">)</span>
		<span class="n">tab_serializer</span> <span class="o">=</span> <span class="n">Batch</span><span class="o">.</span><span class="n">serializers</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
		<span class="n">tab_spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">tab_serializer</span><span class="p">)</span>
		<span class="n">tab</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">table_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">the_batch</span><span class="o">.</span><span class="n">key_len</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">key_len</span> <span class="o">=</span> <span class="n">the_batch</span><span class="o">.</span><span class="n">key_len</span>
			<span class="n">key_args</span> <span class="o">=</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">the_batch</span><span class="o">.</span><span class="n">key_len</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">key_args</span> <span class="o">=</span> <span class="n">tab_spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
			<span class="n">key_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_args</span><span class="p">)</span>
		<span class="n">keys2del</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">key_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
			<span class="nb">setattr</span><span class="p">(</span>
				<span class="bp">self</span><span class="p">,</span>
				<span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">table_name</span><span class="p">,</span>
				<span class="nb">list</span><span class="p">(</span>
					<span class="n">filterfalse</span><span class="p">(</span>
						<span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[:</span><span class="n">key_len</span><span class="p">]</span> <span class="ow">in</span> <span class="n">keys2del</span><span class="p">,</span>
						<span class="n">tab</span><span class="p">,</span>
					<span class="p">)</span>
				<span class="p">),</span>
			<span class="p">)</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys2del</span> <span class="o">&amp;</span> <span class="n">tab</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">del</span> <span class="n">tab</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
			<span class="n">tab</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">keys2del</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to delete from this table&quot;</span><span class="p">,</span> <span class="n">tab</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe_extensions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">UniversalKeyframe</span><span class="p">,</span> <span class="n">RuleKeyframe</span><span class="p">,</span> <span class="n">RulebooksKeyframe</span><span class="p">]:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe_extensions</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">KeyframeError</span><span class="p">(</span><span class="s2">&quot;No keyframe at that time&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Time</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframes</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">delete_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keyframes</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">))</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframe_extensions</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyframes</span><span class="p">):</span>
				<span class="k">yield</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">have_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">branch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">branches_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">BranchRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_branches</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">parent</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">EternalKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Value</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Branch</span><span class="p">:</span>
		<span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">EternalKey</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="s2">&quot;branch&quot;</span><span class="p">))]</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Branch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span><span class="p">:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">EternalKey</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="s2">&quot;turn&quot;</span><span class="p">))]</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Turn</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tick</span><span class="p">:</span>
		<span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">EternalKey</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">))]</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">Tick</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">turns_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TurnRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">),</span> <span class="p">(</span>
				<span class="n">end_tick</span><span class="p">,</span>
				<span class="n">plan_end_tick</span><span class="p">,</span>
			<span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_turns</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">,</span> <span class="n">plan_end_tick</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphValRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">gv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_val</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">gv</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">gv</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">gv</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_del_time</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">graph_val_del_time</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_val</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edges_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">edges_del_time</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edges</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_types</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Turn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tick</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">GraphTypeStr</span><span class="p">]]:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">turn_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">tick_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Need both or neither of &#39;turn_to&#39; and &#39;tick_to&#39;&quot;</span><span class="p">,</span>
				<span class="n">turn_to</span><span class="p">,</span>
				<span class="n">tick_to</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="n">branch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">time_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">)</span>
			<span class="n">time_to</span> <span class="o">=</span> <span class="p">(</span>
				<span class="kc">None</span> <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span><span class="p">)</span>
			<span class="p">)</span>
			<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">iter_times</span><span class="p">(</span>
				<span class="n">time_from</span><span class="p">,</span> <span class="n">time_to</span>
			<span class="p">):</span>
				<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">yield</span> <span class="n">g</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">v</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_chron_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">table</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Time</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">turns</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">turns</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">turns</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="n">row</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chron_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graphs</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">graph</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">nodes_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">nodes_del_time</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">nodes_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRowType</span><span class="p">]:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chron_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ex</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeValRowType</span><span class="p">]:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chron_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_node_val</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_del_time</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">node_val_del_time</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_val</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edges_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">EdgeRowType</span><span class="p">]:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chron_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_edges</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ex</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">EdgeValRowType</span><span class="p">]:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="p">(</span>
			<span class="n">char</span><span class="p">,</span>
			<span class="n">orig</span><span class="p">,</span>
			<span class="n">dest</span><span class="p">,</span>
			<span class="n">key</span><span class="p">,</span>
			<span class="n">val</span><span class="p">,</span>
		<span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chron_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_val</span><span class="p">):</span>
			<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_del_time</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">edge_val_del_time</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_val</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">plan_ticks_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Plan</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">plan_ticks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span>
			<span class="k">for</span> <span class="n">plan</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_ticks</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">branches</span> <span class="o">=</span> <span class="n">plan_ticks</span><span class="p">[</span><span class="n">plan</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">branches</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
					<span class="n">turns</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">turn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">turns</span><span class="p">):</span>
						<span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">turns</span><span class="p">[</span><span class="n">turn</span><span class="p">]:</span>
							<span class="k">yield</span> <span class="n">plan</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">truncate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span><span class="p">:</span>
			<span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_all_keyframe_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeKeyframe</span><span class="p">,</span> <span class="n">EdgeKeyframe</span><span class="p">,</span> <span class="n">StatDict</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframes_graphs</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">nkf</span><span class="p">,</span> <span class="n">ekf</span><span class="p">,</span> <span class="n">gvkf</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">yield</span> <span class="p">(</span>
					<span class="n">g</span><span class="p">,</span>
					<span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span> <span class="ow">in</span> <span class="n">nkf</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
					<span class="p">{</span>
						<span class="n">orig</span><span class="p">:</span> <span class="p">{</span>
							<span class="n">dest</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
						<span class="p">}</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dests</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ekf</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
					<span class="p">},</span>
					<span class="n">gvkf</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
				<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_graphs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">KeyframeGraphRowType</span><span class="p">]:</span>
		<span class="n">kfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyframes_graphs</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">kfg</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">kfgb</span> <span class="o">=</span> <span class="n">kfg</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">kfgb</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">kfgb</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
						<span class="n">nkf</span><span class="p">,</span> <span class="n">ekf</span><span class="p">,</span> <span class="n">gkf</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
						<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">nkf</span><span class="p">,</span> <span class="n">ekf</span><span class="p">,</span> <span class="n">gkf</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_extensions_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">KeyframeExtensionRowType</span><span class="p">]:</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span> <span class="p">(</span><span class="n">ukf</span><span class="p">,</span> <span class="n">rkf</span><span class="p">,</span> <span class="n">rbkf</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chron_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_keyframe_extensions</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">ukf</span><span class="p">,</span> <span class="n">rkf</span><span class="p">,</span> <span class="n">rbkf</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universals_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">UniversalRowType</span><span class="p">]:</span>
		<span class="n">univ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universals</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">univ</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">univb</span> <span class="o">=</span> <span class="n">univ</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">univb</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">univb</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rulebooks_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RulebookRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">rb</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">prio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rulebooks</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span>
						<span class="n">turn</span><span class="p">,</span> <span class="n">tick</span>
					<span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">prio</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rules_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_rule_something_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">tab</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">AssignmentTimeDict</span><span class="p">[</span>
				<span class="nb">tuple</span><span class="p">[</span>
					<span class="n">RuleName</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleFuncName</span><span class="p">]</span> <span class="o">|</span> <span class="n">RuleNeighborhood</span> <span class="o">|</span> <span class="n">RuleBig</span>
				<span class="p">]</span>
			<span class="p">],</span>
		<span class="p">],</span>
	<span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">turns</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">turns</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">rule</span><span class="p">,</span> <span class="n">funcs</span> <span class="o">=</span> <span class="n">turns</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
						<span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">funcs</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_triggers_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TriggerRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_something_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rule_triggers</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_prereqs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PrereqRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_something_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rule_prereqs</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_actions_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ActionRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_something_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rule_actions</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_neighborhood_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleNeighborhoodRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_something_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rule_neighborhood</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_big_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RuleBigRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rule_something_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rule_big</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulebookRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_node_rulebook</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">nrb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_rulebook</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">nrb</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">nrb</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">portal_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PortalRulebookRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_portal_rulebook</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">porb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_rulebook</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">porb</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">porb</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">rb</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_character_something_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">what</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">AssignmentTimeDict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]],</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">what</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">that</span> <span class="o">=</span> <span class="n">what</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">that</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">graph</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">that</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">rb</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_something_rulebook_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_character_rulebook</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unit_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_something_rulebook_dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_rulebook</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_thing_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_something_rulebook_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_character_thing_rulebook</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_place_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_something_rulebook_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_character_place_rulebook</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_portal_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharRulebookRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_something_rulebook_dump</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_character_portal_rulebook</span>
		<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">CharacterRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">crh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">crh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">crh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unit_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">UnitRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">urh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unit_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">urh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">urh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_thing_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">ctrh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_thing_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">ctrh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">ctrh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_place_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">cprh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_place_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">cprh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">cprh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_portal_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">cporh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_character_portal_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">cporh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">cporh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">nrh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">nrh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">nrh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">portal_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">PortalRulesHandledRowType</span><span class="p">]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="n">porh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_rules_handled</span>
			<span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">porh</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">porh</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">]</span>
				<span class="k">yield</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">t</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">things_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ThingRowType</span><span class="p">]:</span>
		<span class="n">things</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">things</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">thb</span> <span class="o">=</span> <span class="n">things</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">thb</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">char</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">thb</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">loc</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">units_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">UnitRowType</span><span class="p">]:</span>
		<span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="n">ub</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ub</span><span class="o">.</span><span class="n">iter_times</span><span class="p">():</span>
					<span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">retrieve_exact</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
					<span class="k">yield</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">char</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">is_unit</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_all_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tbl</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rules_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">):</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">things_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">things_del_time</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">turn</span><span class="p">][</span><span class="n">tick</span><span class="p">]</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">turns_completed_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_turns_completed</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">bookmarks_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Time</span><span class="p">]]:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield from</span> <span class="n">sort_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bookmarks</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>



<div class="viewcode-block" id="NullDatabaseConnector">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.NullDatabaseConnector">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NullDatabaseConnector</span><span class="p">(</span><span class="n">AbstractDatabaseConnector</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Database connector that does nothing, connects to no database</span>

<span class="sd">	This will never return any data, either. If you want it to hold data</span>
<span class="sd">	you put into it, instead use :class:`PythonDatabaseConnector`.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">engine</span><span class="p">:</span> <span class="n">AbstractEngine</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">pack</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">obj</span><span class="p">:</span> <span class="n">Key</span>
		<span class="o">|</span> <span class="n">KeyHint</span>
		<span class="o">|</span> <span class="n">EternalKey</span>
		<span class="o">|</span> <span class="n">UniversalKey</span>
		<span class="o">|</span> <span class="n">Stat</span>
		<span class="o">|</span> <span class="n">ValueHint</span>
		<span class="o">|</span> <span class="n">Value</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">obj</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">b</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">args</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">delete_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">insert_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">insert_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rules_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_keyframe_extensions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">UniversalKeyframe</span><span class="p">,</span> <span class="n">RuleKeyframe</span><span class="p">,</span> <span class="n">RulebooksKeyframe</span><span class="p">]:</span>
		<span class="k">return</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">new_graph</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">typ</span><span class="p">:</span> <span class="nb">str</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_all_keyframe_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeKeyframe</span><span class="p">,</span> <span class="n">EdgeKeyframe</span><span class="p">,</span> <span class="n">GraphValKeyframe</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_graphs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">CharName</span><span class="p">,</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="n">Tick</span><span class="p">,</span>
			<span class="n">NodeKeyframe</span><span class="p">,</span>
			<span class="n">EdgeKeyframe</span><span class="p">,</span>
			<span class="n">GraphValKeyframe</span><span class="p">,</span>
		<span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframe_extensions_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="n">Tick</span><span class="p">,</span>
			<span class="n">UniversalKeyframe</span><span class="p">,</span>
			<span class="n">RuleKeyframe</span><span class="p">,</span>
			<span class="n">RulebooksKeyframe</span><span class="p">,</span>
		<span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_insert</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">typ</span><span class="p">:</span> <span class="nb">str</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">keyframes_graphs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">delete_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">have_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">branches_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">BranchRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Branch</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Turn</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;turn&quot;</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tick</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;tick&quot;</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">global_del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">):</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_branch</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">parent</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">parent_turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">parent_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">end_turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">end_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_turn</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">end_tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">plan_end_tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">turns_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphValRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graph_val_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_types</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Turn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tick</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">graphs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">GraphRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">exist_node</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">extant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">nodes_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">nodes_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NodeValRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_val_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edges_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">EdgeRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edges_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">EdgeValRowType</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">edge_val_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">plan_ticks_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">truncate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universals_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rulebooks_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">RulebookName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rules_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_triggers_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_prereqs_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_actions_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_neighborhood_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rule_big_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RuleBig</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">portal_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unit_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_thing_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_place_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_portal_rulebook_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unit_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">CharName</span><span class="p">,</span>
			<span class="n">CharName</span><span class="p">,</span>
			<span class="n">NodeName</span><span class="p">,</span>
			<span class="n">RulebookName</span><span class="p">,</span>
			<span class="n">RuleName</span><span class="p">,</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="n">Tick</span><span class="p">,</span>
		<span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_thing_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_place_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">character_portal_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">CharName</span><span class="p">,</span>
			<span class="n">NodeName</span><span class="p">,</span>
			<span class="n">NodeName</span><span class="p">,</span>
			<span class="n">RulebookName</span><span class="p">,</span>
			<span class="n">RuleName</span><span class="p">,</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="n">Tick</span><span class="p">,</span>
		<span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">node_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">RulebookName</span><span class="p">,</span> <span class="n">RuleName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">portal_rules_handled_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span>
			<span class="n">CharName</span><span class="p">,</span>
			<span class="n">NodeName</span><span class="p">,</span>
			<span class="n">NodeName</span><span class="p">,</span>
			<span class="n">RulebookName</span><span class="p">,</span>
			<span class="n">RuleName</span><span class="p">,</span>
			<span class="n">Branch</span><span class="p">,</span>
			<span class="n">Turn</span><span class="p">,</span>
			<span class="n">Tick</span><span class="p">,</span>
		<span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">things_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">units_dump</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span>
		<span class="nb">tuple</span><span class="p">[</span><span class="n">CharName</span><span class="p">,</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">NodeName</span><span class="p">,</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">Tick</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
	<span class="p">]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universal_get</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;NOTHING&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">universal_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">key</span><span class="p">:</span> <span class="n">UniversalKey</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">count_all_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">0</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">create_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">triggers</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">prereqs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">actions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
		<span class="n">neighborhood</span><span class="p">:</span> <span class="n">RuleNeighborhood</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">big</span><span class="p">:</span> <span class="n">RuleBig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="kc">False</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_triggers</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">flist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_prereqs</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">flist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_actions</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">flist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ActionFuncName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_neighborhood</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">neighborhood</span><span class="p">:</span> <span class="n">RuleNeighborhood</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rule_big</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">big</span><span class="p">:</span> <span class="n">RuleBig</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">name</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">prio</span><span class="p">:</span> <span class="n">RulebookPriority</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_unit_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_thing_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_place_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_character_portal_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">char</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rb</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_node_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_portal_rulebook</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_unit_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">unit</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_thing_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_place_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">place</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_character_portal_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_node_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">handled_portal_rule</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">orig</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">dest</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">rule</span><span class="p">:</span> <span class="n">RuleName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_thing_loc</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">thing</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">loc</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">things_del_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unit_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">character</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">graph</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span>
		<span class="n">node</span><span class="p">:</span> <span class="n">NodeName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">is_unit</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">rulebook_set</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">rulebook</span><span class="p">:</span> <span class="n">RulebookName</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RuleName</span><span class="p">],</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">turns_completed_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Branch</span><span class="p">,</span> <span class="n">Turn</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">complete_turn</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">discard_rules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_put_window_tick_to_end</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_put_window_tick_to_tick</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_load_windows_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeWindow</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_increc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_one_window</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">bookmarks_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Key</span><span class="p">,</span> <span class="n">Time</span><span class="p">]]:</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">set_bookmark</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">del_bookmark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">load_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeWindow</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
		<span class="k">return</span> <span class="p">{}</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">window_getter</span><span class="p">(</span>
	<span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
	<span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Branch</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="n">partial</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
	<span class="n">per_character</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Decorator for functions that get a window of time from the output queue&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">window_getter</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">per_character</span><span class="o">=</span><span class="n">per_character</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">partial</span><span class="p">):</span>
		<span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">per_character</span><span class="p">:</span>
		<span class="k">if</span> <span class="s2">&quot;return&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argspec</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;No character in return annotation&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
		<span class="n">ret_sig</span> <span class="o">=</span> <span class="n">argspec</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s2">&quot;return&quot;</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_sig</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">ret_sig</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ret_sig</span><span class="p">)</span>
		<span class="n">char_index</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">ret_sig</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">CharName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">char_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;per_character window getter needs CharName in its return signature&quot;</span>
			<span class="p">)</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">get_a_window</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
			<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
			<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
			<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
			<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
		<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">!=</span> <span class="p">(</span>
				<span class="s2">&quot;begin&quot;</span><span class="p">,</span>
				<span class="n">table</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn_from</span><span class="p">,</span>
				<span class="n">tick_from</span><span class="p">,</span>
				<span class="n">turn_to</span><span class="p">,</span>
				<span class="n">tick_to</span><span class="p">,</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected beginning of &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
			<span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">list</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">got</span><span class="p">:</span>
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
						<span class="n">rec</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
					<span class="n">charn</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="n">char_index</span><span class="p">]</span>
					<span class="k">try</span><span class="p">:</span>
						<span class="n">ret</span><span class="p">[</span><span class="n">charn</span><span class="p">][</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">))</span>
					<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">got</span> <span class="o">!=</span> <span class="p">(</span>
				<span class="s2">&quot;end&quot;</span><span class="p">,</span>
				<span class="n">table</span><span class="p">,</span>
				<span class="n">branch</span><span class="p">,</span>
				<span class="n">turn_from</span><span class="p">,</span>
				<span class="n">tick_from</span><span class="p">,</span>
				<span class="n">turn_to</span><span class="p">,</span>
				<span class="n">tick_to</span><span class="p">,</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected end of &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

		<span class="n">window_getter</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_a_window</span>
		<span class="k">return</span> <span class="n">get_a_window</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">get_a_window</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">!=</span> <span class="p">(</span>
			<span class="s2">&quot;begin&quot;</span><span class="p">,</span>
			<span class="n">table</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn_from</span><span class="p">,</span>
			<span class="n">tick_from</span><span class="p">,</span>
			<span class="n">turn_to</span><span class="p">,</span>
			<span class="n">tick_to</span><span class="p">,</span>
		<span class="p">):</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected beginning of &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
		<span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">got</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">list</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">got</span><span class="p">:</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
					<span class="n">rec</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">ret</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">))</span>
				<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">got</span> <span class="o">!=</span> <span class="p">(</span>
			<span class="s2">&quot;end&quot;</span><span class="p">,</span>
			<span class="n">table</span><span class="p">,</span>
			<span class="n">branch</span><span class="p">,</span>
			<span class="n">turn_from</span><span class="p">,</span>
			<span class="n">tick_from</span><span class="p">,</span>
			<span class="n">turn_to</span><span class="p">,</span>
			<span class="n">tick_to</span><span class="p">,</span>
		<span class="p">):</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected end of &quot;</span> <span class="o">+</span> <span class="n">table</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

	<span class="n">window_getter</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_a_window</span>
	<span class="k">return</span> <span class="n">get_a_window</span>


<span class="n">window_getter</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="ThreadedDatabaseConnector">
<a class="viewcode-back" href="../../lisien/index.html#lisien.db.ThreadedDatabaseConnector">[docs]</a>
<span class="nd">@define</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ThreadedDatabaseConnector</span><span class="p">(</span><span class="n">AbstractDatabaseConnector</span><span class="p">):</span>
	<span class="n">Looper</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">ConnectionLooper</span><span class="p">]]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_make_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_looper</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rundb&quot;</span><span class="p">)</span>

	<span class="n">_t</span><span class="p">:</span> <span class="n">Thread</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
		<span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Factory</span><span class="p">(</span><span class="n">_make_thread</span><span class="p">,</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="p">)</span>
	<span class="n">_initialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_looper</span><span class="o">.</span><span class="n">existence_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">TimeoutError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t close looper&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_looper</span><span class="o">.</span><span class="n">existence_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;commit&quot;</span><span class="p">)</span>
		<span class="n">got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">got</span> <span class="o">!=</span> <span class="s2">&quot;committed&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed commit&quot;</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>

	<span class="nd">@contextmanager</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mutex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">def</span><span class="w"> </span><span class="nf">consume_errors</span><span class="p">():</span>
			<span class="n">excs</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">unfinished_tasks</span>
			<span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
				<span class="n">got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
					<span class="n">excs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">got</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">excs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unconsumed output&quot;</span><span class="p">,</span> <span class="n">got</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">excs</span><span class="p">:</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">excs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">excs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="k">raise</span> <span class="n">ExceptionGroup</span><span class="p">(</span>
					<span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unfinished_tasks</span><span class="si">}</span><span class="s2"> unfinished tasks in output queue &quot;</span>
					<span class="s2">&quot;before call_one&quot;</span><span class="p">,</span>
					<span class="n">excs</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
					<span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">unfinished_tasks</span><span class="si">}</span><span class="s2"> unfinished tasks in output queue &quot;</span>
					<span class="s2">&quot;before call_one&quot;</span>
				<span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">unfinished_tasks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">consume_errors</span><span class="p">()</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
			<span class="k">yield</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">unfinished_tasks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">consume_errors</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_looper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConnectionLooper</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Looper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_looper</span><span class="o">.</span><span class="n">lock</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_inq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">Queue</span><span class="p">()</span>

	<span class="nd">@cached_property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_outq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">Queue</span><span class="p">()</span>

	<span class="nd">@mutexed</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">ret</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;silent&quot;</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

	<span class="nd">@mutexed</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">call_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;many&quot;</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">ret</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">call_many_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;silent&quot;</span><span class="p">,</span> <span class="s2">&quot;many&quot;</span><span class="p">,</span> <span class="n">query_name</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
			<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_put_window_tick_to_end</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span>
	<span class="p">):</span>
		<span class="n">putkwargs</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span>
			<span class="s2">&quot;turn_from&quot;</span><span class="p">:</span> <span class="n">turn_from</span><span class="p">,</span>
			<span class="s2">&quot;tick_from&quot;</span><span class="p">:</span> <span class="n">tick_from</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="n">infix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infixes2load</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
				<span class="p">(</span>
					<span class="s2">&quot;echo&quot;</span><span class="p">,</span>
					<span class="p">(</span>
						<span class="s2">&quot;begin&quot;</span><span class="p">,</span>
						<span class="n">infix</span><span class="p">,</span>
						<span class="n">branch</span><span class="p">,</span>
						<span class="n">turn_from</span><span class="p">,</span>
						<span class="n">tick_from</span><span class="p">,</span>
						<span class="kc">None</span><span class="p">,</span>
						<span class="kc">None</span><span class="p">,</span>
					<span class="p">),</span>
					<span class="p">{},</span>
				<span class="p">)</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;load_</span><span class="si">{</span><span class="n">infix</span><span class="si">}</span><span class="s2">_tick_to_end&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">putkwargs</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
				<span class="p">(</span>
					<span class="s2">&quot;echo&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">infix</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
					<span class="p">{},</span>
				<span class="p">)</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_put_window_tick_to_tick</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="n">putkwargs</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;branch&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span>
			<span class="s2">&quot;turn_from&quot;</span><span class="p">:</span> <span class="n">turn_from</span><span class="p">,</span>
			<span class="s2">&quot;tick_from&quot;</span><span class="p">:</span> <span class="n">tick_from</span><span class="p">,</span>
			<span class="s2">&quot;turn_to&quot;</span><span class="p">:</span> <span class="n">turn_to</span><span class="p">,</span>
			<span class="s2">&quot;tick_to&quot;</span><span class="p">:</span> <span class="n">tick_to</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="n">infix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infixes2load</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
				<span class="p">(</span>
					<span class="s2">&quot;echo&quot;</span><span class="p">,</span>
					<span class="p">(</span>
						<span class="s2">&quot;begin&quot;</span><span class="p">,</span>
						<span class="n">infix</span><span class="p">,</span>
						<span class="n">branch</span><span class="p">,</span>
						<span class="n">turn_from</span><span class="p">,</span>
						<span class="n">tick_from</span><span class="p">,</span>
						<span class="n">turn_to</span><span class="p">,</span>
						<span class="n">tick_to</span><span class="p">,</span>
					<span class="p">),</span>
					<span class="p">{},</span>
				<span class="p">)</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;load_</span><span class="si">{</span><span class="n">infix</span><span class="si">}</span><span class="s2">_tick_to_tick&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">putkwargs</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
				<span class="p">(</span>
					<span class="s2">&quot;echo&quot;</span><span class="p">,</span>
					<span class="p">(</span>
						<span class="s2">&quot;end&quot;</span><span class="p">,</span>
						<span class="n">infix</span><span class="p">,</span>
						<span class="n">branch</span><span class="p">,</span>
						<span class="n">turn_from</span><span class="p">,</span>
						<span class="n">tick_from</span><span class="p">,</span>
						<span class="n">turn_to</span><span class="p">,</span>
						<span class="n">tick_to</span><span class="p">,</span>
					<span class="p">),</span>
					<span class="p">{},</span>
				<span class="p">)</span>
			<span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unpack_node_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_kf_packed</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeKeyframe</span><span class="p">:</span>
		<span class="n">node_kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">node_kf_packed</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_kf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid node keyframe&quot;</span><span class="p">,</span> <span class="n">node_kf</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="n">NodeName</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span> <span class="p">{</span><span class="n">Stat</span><span class="p">(</span><span class="n">kk</span><span class="p">):</span> <span class="n">Value</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node_kf</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unpack_edge_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_kf_packed</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EdgeKeyframe</span><span class="p">:</span>
		<span class="n">unpacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">edge_kf_packed</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid edge keyframe&quot;</span><span class="p">,</span> <span class="n">unpacked</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">{</span>
				<span class="n">NodeName</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">orig</span><span class="p">)):</span> <span class="p">{</span>
					<span class="n">NodeName</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">dest</span><span class="p">)):</span> <span class="p">{</span>
						<span class="n">Stat</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">key</span><span class="p">)):</span> <span class="n">Value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
					<span class="p">}</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dests</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
				<span class="p">}</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dests</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">}</span>
		<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">unpacked</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ex</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unpack_graph_val_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_val_packed</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CharDict</span><span class="p">:</span>
		<span class="n">unpacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">graph_val_packed</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid graph stat keyframe&quot;</span><span class="p">,</span> <span class="n">unpacked</span><span class="p">)</span>
		<span class="n">rulebooks</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;character_rulebook&quot;</span><span class="p">,</span>
			<span class="s2">&quot;unit_rulebook&quot;</span><span class="p">,</span>
			<span class="s2">&quot;character_thing_rulebook&quot;</span><span class="p">,</span>
			<span class="s2">&quot;character_place_rulebook&quot;</span><span class="p">,</span>
			<span class="s2">&quot;character_portal_rulebook&quot;</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="n">k</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rulebooks</span> <span class="k">else</span> <span class="n">Stat</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span> <span class="n">RulebookName</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rulebooks</span>
			<span class="k">else</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unpack_universal_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">universal_packed</span><span class="p">:</span> <span class="nb">bytes</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UniversalKeyframe</span><span class="p">:</span>
		<span class="n">unpacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">universal_packed</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid universal keyframe&quot;</span><span class="p">,</span> <span class="n">unpacked</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span><span class="n">UniversalKey</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span> <span class="n">Value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unpack_rules_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_packed</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RuleKeyframe</span><span class="p">:</span>
		<span class="n">unpacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">rule_packed</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule keyframe&quot;</span><span class="p">,</span> <span class="n">unpacked</span><span class="p">)</span>
		<span class="n">neighborhood_d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RuleName</span><span class="p">,</span> <span class="n">RuleNeighborhood</span><span class="p">]</span> <span class="o">=</span> <span class="n">unpacked</span><span class="p">[</span>
			<span class="s2">&quot;neighborhood&quot;</span>
		<span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neighborhood_d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid neighborhood dict&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">neighborhood_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rule name&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid neighborhood&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;triggers&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="n">RuleName</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span> <span class="p">[</span><span class="n">TriggerFuncName</span><span class="p">(</span><span class="n">trig</span><span class="p">)</span> <span class="k">for</span> <span class="n">trig</span> <span class="ow">in</span> <span class="n">trigs</span><span class="p">]</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">trigs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="p">[</span><span class="s2">&quot;triggers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">},</span>
			<span class="s2">&quot;prereqs&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="n">RuleName</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span> <span class="p">[</span><span class="n">PrereqFuncName</span><span class="p">(</span><span class="n">preq</span><span class="p">)</span> <span class="k">for</span> <span class="n">preq</span> <span class="ow">in</span> <span class="n">preqs</span><span class="p">]</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">preqs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="p">[</span><span class="s2">&quot;prereqs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">},</span>
			<span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="n">RuleName</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span> <span class="p">[</span><span class="n">ActionFuncName</span><span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">acts</span><span class="p">]</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">acts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">},</span>
			<span class="s2">&quot;neighborhood&quot;</span><span class="p">:</span> <span class="n">neighborhood_d</span><span class="p">,</span>
			<span class="s2">&quot;big&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="n">RuleName</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span> <span class="n">RuleBig</span><span class="p">(</span><span class="n">big</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">big</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="p">[</span><span class="s2">&quot;big&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
			<span class="p">},</span>
		<span class="p">}</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_unpack_rulebooks_keyframe</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">rulebook_packed</span><span class="p">:</span> <span class="nb">bytes</span>
	<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RulebooksKeyframe</span><span class="p">:</span>
		<span class="n">unpacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">rulebook_packed</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid rulebook keyframe&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="n">RulebookName</span><span class="p">(</span><span class="n">rb</span><span class="p">):</span> <span class="p">(</span>
				<span class="p">[</span><span class="n">RuleName</span><span class="p">(</span><span class="n">ru</span><span class="p">)</span> <span class="k">for</span> <span class="n">ru</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">],</span>
				<span class="n">RulebookPriority</span><span class="p">(</span><span class="n">prio</span><span class="p">),</span>
			<span class="p">)</span>
			<span class="k">for</span> <span class="n">rb</span><span class="p">,</span> <span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">prio</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
		<span class="p">}</span>

	<span class="nd">@mutexed</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_load_windows_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TimeWindow</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">assert</span> <span class="s2">&quot;graphs&quot;</span> <span class="ow">in</span> <span class="n">ret</span>
		<span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">turn_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_put_window_tick_to_end</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_put_window_tick_to_tick</span><span class="p">(</span>
					<span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span>
				<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_inq</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_one_window</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="o">*</span><span class="n">window</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">unpack_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Key</span><span class="p">:</span>
		<span class="n">unpacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unpacked</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid key&quot;</span><span class="p">,</span> <span class="n">unpacked</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">unpacked</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_one_window</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">,</span>
		<span class="n">branch</span><span class="p">:</span> <span class="n">Branch</span><span class="p">,</span>
		<span class="n">turn_from</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_from</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
		<span class="n">turn_to</span><span class="p">:</span> <span class="n">Turn</span><span class="p">,</span>
		<span class="n">tick_to</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="sa">f</span><span class="s2">&quot;_get_one_window(</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">turn_from</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">tick_from</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">turn_to</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">tick_to</span><span class="si">}</span><span class="s2">)&quot;</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infixes2load</span><span class="p">:</span>
			<span class="n">prop</span> <span class="o">=</span> <span class="n">Batch</span><span class="o">.</span><span class="n">cached_properties</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
			<span class="n">batch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">attrname</span><span class="p">)</span>
			<span class="n">batch</span><span class="o">.</span><span class="n">window_getter</span><span class="p">(</span>
				<span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn_from</span><span class="p">,</span> <span class="n">tick_from</span><span class="p">,</span> <span class="n">turn_to</span><span class="p">,</span> <span class="n">tick_to</span>
			<span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Lisien</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#internals">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elide/index.html">Elide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;Zachary Spector.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>