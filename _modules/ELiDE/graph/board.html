<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ELiDE.graph.board &#8212; LiSE 0.14.0a documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=fbc7b204"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ELiDE.graph.board</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of ELiDE, frontend to LiSE, a framework for life simulation games.</span>
<span class="c1"># Copyright (c) Zachary Spector, public@zacharyspector.com</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;The big widget that shows the graph of the selected Character.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">monotonic</span>

<span class="kn">from</span> <span class="nn">kivy.app</span> <span class="kn">import</span> <span class="n">App</span>
<span class="kn">from</span> <span class="nn">kivy.properties</span> <span class="kn">import</span> <span class="p">(</span>
	<span class="n">BooleanProperty</span><span class="p">,</span>
	<span class="n">ReferenceListProperty</span><span class="p">,</span>
	<span class="n">DictProperty</span><span class="p">,</span>
	<span class="n">ObjectProperty</span><span class="p">,</span>
	<span class="n">NumericProperty</span><span class="p">,</span>
	<span class="n">ListProperty</span><span class="p">,</span>
	<span class="n">StringProperty</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">kivy.lang</span> <span class="kn">import</span> <span class="n">Builder</span>
<span class="kn">from</span> <span class="nn">kivy.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">kivy.clock</span> <span class="kn">import</span> <span class="n">Clock</span><span class="p">,</span> <span class="n">mainthread</span>
<span class="kn">from</span> <span class="nn">kivy.uix.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">kivy.uix.relativelayout</span> <span class="kn">import</span> <span class="n">RelativeLayout</span>
<span class="kn">from</span> <span class="nn">kivy.uix.floatlayout</span> <span class="kn">import</span> <span class="n">FloatLayout</span>
<span class="kn">from</span> <span class="nn">kivy.uix.widget</span> <span class="kn">import</span> <span class="n">Widget</span>
<span class="kn">from</span> <span class="nn">kivy.vector</span> <span class="kn">import</span> <span class="n">Vector</span>

<span class="kn">from</span> <span class="nn">ELiDE.pawnspot</span> <span class="kn">import</span> <span class="n">TextureStackPlane</span><span class="p">,</span> <span class="n">Stack</span>
<span class="kn">from</span> <span class="nn">LiSE.util</span> <span class="kn">import</span> <span class="n">normalize_layout</span>
<span class="kn">from</span> <span class="nn">.spot</span> <span class="kn">import</span> <span class="n">GraphSpot</span>
<span class="kn">from</span> <span class="nn">.arrow</span> <span class="kn">import</span> <span class="p">(</span>
	<span class="n">GraphArrow</span><span class="p">,</span>
	<span class="n">GraphArrowWidget</span><span class="p">,</span>
	<span class="n">ArrowPlane</span><span class="p">,</span>
	<span class="n">get_points_multi</span><span class="p">,</span>
	<span class="n">DEFAULT_ARROW_LABEL_KWARGS</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.pawn</span> <span class="kn">import</span> <span class="n">Pawn</span>
<span class="kn">from</span> <span class="nn">..dummy</span> <span class="kn">import</span> <span class="n">Dummy</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">trigger</span>
<span class="kn">from</span> <span class="nn">..boardview</span> <span class="kn">import</span> <span class="n">BoardView</span>
<span class="kn">from</span> <span class="nn">..boardscatter</span> <span class="kn">import</span> <span class="n">BoardScatterPlane</span>


<div class="viewcode-block" id="KvLayoutBack">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.KvLayoutBack">[docs]</a>
<span class="k">class</span> <span class="nc">KvLayoutBack</span><span class="p">(</span><span class="n">FloatLayout</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;What to show behind the graph.</span>

<span class="sd">	By default, shows nothing.</span>

<span class="sd">	&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="KvLayoutFront">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.KvLayoutFront">[docs]</a>
<span class="k">class</span> <span class="nc">KvLayoutFront</span><span class="p">(</span><span class="n">FloatLayout</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;What to show in front of the graph.</span>

<span class="sd">	By default, shows nothing.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">pass</span></div>



<div class="viewcode-block" id="FinalLayout">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.FinalLayout">[docs]</a>
<span class="k">class</span> <span class="nc">FinalLayout</span><span class="p">(</span><span class="n">FloatLayout</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">finalize_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
			<span class="n">child</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trigger_finalize_all</span><span class="p">)</span>

	<span class="n">_trigger_finalize_all</span> <span class="o">=</span> <span class="n">trigger</span><span class="p">(</span><span class="n">finalize_all</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">get_label_kwargs_from_portal</span><span class="p">(</span><span class="n">portal</span><span class="p">):</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">portal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">portal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_label_stat&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
		<span class="o">**</span><span class="n">portal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_label_kwargs&quot;</span><span class="p">,</span> <span class="p">{}),</span>
		<span class="o">**</span><span class="n">DEFAULT_ARROW_LABEL_KWARGS</span><span class="p">,</span>
	<span class="p">}</span>


<div class="viewcode-block" id="GraphBoard">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard">[docs]</a>
<span class="k">class</span> <span class="nc">GraphBoard</span><span class="p">(</span><span class="n">RelativeLayout</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A graphical view onto a :class:`LiSE.Character`, resembling a game</span>
<span class="sd">	graph.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">app</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">character</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">wallpaper_path</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
	<span class="n">spot</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">({})</span>
	<span class="n">pawn</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">({})</span>
	<span class="n">arrow</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">({})</span>
	<span class="n">pred_arrow</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">({})</span>
	<span class="n">wallpaper</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">kvlayoutback</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">arrow_plane</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">stack_plane</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">kvlayoutfront</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">wids</span> <span class="o">=</span> <span class="n">ReferenceListProperty</span><span class="p">(</span>
		<span class="n">wallpaper</span><span class="p">,</span> <span class="n">kvlayoutback</span><span class="p">,</span> <span class="n">arrow_plane</span><span class="p">,</span> <span class="n">stack_plane</span><span class="p">,</span> <span class="n">kvlayoutfront</span>
	<span class="p">)</span>
	<span class="n">spots_unposd</span> <span class="o">=</span> <span class="n">ListProperty</span><span class="p">([])</span>
	<span class="n">layout_tries</span> <span class="o">=</span> <span class="n">NumericProperty</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="n">tracking_vel</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">selection_candidates</span> <span class="o">=</span> <span class="n">ListProperty</span><span class="p">([])</span>
	<span class="n">selection</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="n">allownone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">keep_selection</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">adding_portal</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">reciprocal_portal</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">grabbing</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">grabbed</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">allownone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">spot_cls</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="n">Stack</span><span class="p">)</span>
	<span class="n">pawn_cls</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="n">Stack</span><span class="p">)</span>
	<span class="n">arrow_cls</span> <span class="o">=</span> <span class="n">GraphArrow</span>
	<span class="n">proto_arrow_cls</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="n">GraphArrowWidget</span><span class="p">)</span>
	<span class="n">_scheduled_rm_spot</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">()</span>
	<span class="n">_scheduled_rm_arrow</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">()</span>
	<span class="n">_scheduled_discard_pawn</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">()</span>
	<span class="n">_scheduled_add_pawn</span> <span class="o">=</span> <span class="n">DictProperty</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">widkwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;size_hint&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>

<div class="viewcode-block" id="GraphBoard.on_touch_down">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.on_touch_down">[docs]</a>
	<span class="k">def</span> <span class="nf">on_touch_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touch</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Check for collisions and select an appropriate entity.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lasttouch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasttouch</span> <span class="o">==</span> <span class="n">touch</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">apply_transform_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_local</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collide_point</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
			<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">collide_point</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;__self__&quot;</span>
			<span class="p">):</span>
				<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: hit selection&quot;</span><span class="p">)</span>
				<span class="n">touch</span><span class="o">.</span><span class="n">grab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span>
		<span class="n">pawns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pawns_at</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">pawns</span><span class="p">:</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: hit </span><span class="si">{}</span><span class="s2"> pawns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pawns</span><span class="p">)))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span> <span class="o">=</span> <span class="n">pawns</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span>
			<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">True</span>
		<span class="n">spots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spots_at</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">spots</span><span class="p">:</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: hit </span><span class="si">{}</span><span class="s2"> spots&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spots</span><span class="p">)))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span> <span class="o">=</span> <span class="n">spots</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adding_portal</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">origspot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">protodest</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">(</span>
					<span class="n">name</span><span class="o">=</span><span class="s2">&quot;protodest&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protodest</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">protodest</span><span class="o">.</span><span class="n">on_touch_down</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">protoportal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto_arrow_cls</span><span class="p">(</span>
					<span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
					<span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origspot</span><span class="p">,</span>
					<span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protodest</span><span class="p">,</span>
				<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protoportal</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_portal</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">protoportal2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto_arrow_cls</span><span class="p">(</span>
						<span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
						<span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origspot</span><span class="p">,</span>
						<span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protodest</span><span class="p">,</span>
					<span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protoportal2</span><span class="p">)</span>
			<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">True</span>
		<span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">iter_collided_edges</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">edges</span><span class="p">:</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: hit </span><span class="si">{}</span><span class="s2"> arrows&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span> <span class="o">=</span> <span class="p">[</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">dest</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="ow">in</span> <span class="n">edges</span>
			<span class="p">]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="n">GraphArrow</span><span class="p">)</span>
				<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">reciprocal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span>
			<span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">)</span>
			<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">True</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>


<div class="viewcode-block" id="GraphBoard.on_touch_move">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.on_touch_move">[docs]</a>
	<span class="k">def</span> <span class="nf">on_touch_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touch</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;If an entity is selected, drag it.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lasttouch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasttouch</span> <span class="o">==</span> <span class="n">touch</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">edit_locked</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">keep_selection</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_touch_move</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>
			<span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">Stack</span><span class="p">):</span>
				<span class="n">sel</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">pos</span>
				<span class="n">name</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">proxy</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">()):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">dest</span><span class="p">]</span><span class="o">.</span><span class="n">repoint</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">orig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">()):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">repoint</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">contents</span><span class="p">():</span>
					<span class="n">pawn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">thing</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
					<span class="n">pawn</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">top</span>  <span class="c1"># real layout needed</span>
			<span class="k">return</span> <span class="n">ret</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">cand</span><span class="o">.</span><span class="n">collide_point</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">cand</span>
					<span class="n">cand</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cand</span><span class="p">,</span> <span class="n">Widget</span><span class="p">):</span>
						<span class="n">touch</span><span class="o">.</span><span class="n">grab</span><span class="p">(</span><span class="n">cand</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_touch_move</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">ret</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protodest&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">protodest</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">pos</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">protoportal</span><span class="o">.</span><span class="n">_trigger_repoint</span><span class="p">()</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protoportal2&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">protoportal2</span><span class="o">.</span><span class="n">_trigger_repoint</span><span class="p">()</span></div>


<div class="viewcode-block" id="GraphBoard.portal_touch_up">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.portal_touch_up">[docs]</a>
	<span class="k">def</span> <span class="nf">portal_touch_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touch</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Try to create a portal between the spots the user chose.&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="c1"># If the touch ended upon a spot, and there isn&#39;t</span>
			<span class="c1"># already a portal between the origin and this</span>
			<span class="c1"># destination, create one.</span>
			<span class="n">destspot</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spots_at</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
			<span class="n">orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origspot</span><span class="o">.</span><span class="n">proxy</span>
			<span class="n">dest</span> <span class="o">=</span> <span class="n">destspot</span><span class="o">.</span><span class="n">proxy</span>
			<span class="k">if</span> <span class="n">orig</span> <span class="o">!=</span> <span class="n">dest</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
				<span class="n">orig</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span>
				<span class="ow">and</span> <span class="n">dest</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
			<span class="p">):</span>
				<span class="n">symmetrical</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protoportal2&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
					<span class="n">orig</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">preportal</span>
					<span class="ow">and</span> <span class="n">dest</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">preportal</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
				<span class="p">)</span>
				<span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">new_portal</span><span class="p">(</span>
					<span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">symmetrical</span><span class="o">=</span><span class="n">symmetrical</span>
				<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">add_new_portal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_arrow</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">orig</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">][</span>
					<span class="n">orig</span><span class="o">.</span><span class="n">name</span>
				<span class="p">]</span> <span class="o">=</span> <span class="n">GraphArrow</span><span class="p">(</span>
					<span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
					<span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
					<span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
				<span class="p">)</span>
				<span class="k">if</span> <span class="n">symmetrical</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">add_new_portal</span><span class="p">(</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">make_arrow</span><span class="p">(</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
						<span class="p">)</span>
					<span class="p">)</span>
					<span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">if</span> <span class="n">orig</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span>
						<span class="n">orig</span><span class="o">.</span><span class="n">name</span>
					<span class="p">][</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">GraphArrow</span><span class="p">(</span>
						<span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
						<span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">dest</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
						<span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">orig</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
					<span class="p">)</span>
		<span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">remove_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protoportal</span><span class="p">)</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoportal</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protoportal2&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">remove_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protoportal2</span><span class="p">)</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">protoportal2</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">protodest</span></div>


<div class="viewcode-block" id="GraphBoard.on_touch_up">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.on_touch_up">[docs]</a>
	<span class="k">def</span> <span class="nf">on_touch_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">touch</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delegate touch handling if possible, else select something.&quot;&quot;&quot;</span>

		<span class="k">def</span> <span class="nf">unsel_graph_arrow</span><span class="p">():</span>
			<span class="n">origspot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">origin</span>
			<span class="n">destspot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">destination</span>
			<span class="n">insts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">_instructions_map</span><span class="p">[</span>
				<span class="n">origspot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">destspot</span><span class="o">.</span><span class="n">name</span>
			<span class="p">]</span>
			<span class="n">fbo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">_fbo</span>
			<span class="n">fbo</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
			<span class="n">insts</span><span class="p">[</span><span class="s2">&quot;color0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rgba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">bg_color_unselected</span>
			<span class="n">insts</span><span class="p">[</span><span class="s2">&quot;color1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rgba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">fg_color_unselected</span>
			<span class="n">fbo</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
			<span class="n">fbo</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ask_update</span><span class="p">()</span>

		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_lasttouch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasttouch</span> <span class="o">==</span> <span class="n">touch</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lasttouch</span> <span class="o">=</span> <span class="n">touch</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">apply_transform_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_local</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;protodest&quot;</span><span class="p">):</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: on_touch_up making a portal&quot;</span><span class="p">)</span>
			<span class="n">touch</span><span class="o">.</span><span class="n">ungrab</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portal_touch_up</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>
			<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
			<span class="k">return</span> <span class="n">ret</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">:</span>
			<span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">Widget</span><span class="p">):</span>
				<span class="n">sel</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;on_touch_up&quot;</span><span class="p">,</span> <span class="n">touch</span><span class="p">)</span>
			<span class="k">elif</span> <span class="p">(</span>
				<span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">Stack</span><span class="p">)</span>
				<span class="ow">and</span> <span class="n">touch</span><span class="o">.</span><span class="n">pos</span> <span class="o">==</span> <span class="n">sel</span><span class="o">.</span><span class="n">center</span>
				<span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">edit_locked</span>
			<span class="p">):</span>
				<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">):</span>
					<span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">iter_collided_keys</span><span class="p">(</span>
						<span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span>
					<span class="p">):</span>
						<span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
							<span class="n">newloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">place</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
							<span class="n">sel</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">newloc</span>
							<span class="n">newspot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
							<span class="n">sel</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">newspot</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">newspot</span><span class="o">.</span><span class="n">top</span>
							<span class="k">return</span>
					<span class="n">oldloc</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">location</span>
					<span class="n">oldspot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">oldloc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
					<span class="n">sel</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">oldspot</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">oldspot</span><span class="o">.</span><span class="n">top</span>
					<span class="k">return</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">prox</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">proxy</span>
					<span class="n">prox</span><span class="p">[</span><span class="s2">&quot;_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
					<span class="n">prox</span><span class="p">[</span><span class="s2">&quot;_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
		<span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">collide_point</span><span class="p">(</span><span class="o">*</span><span class="n">touch</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">GraphArrow</span><span class="p">):</span>
					<span class="n">portal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">candidate</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">name</span><span class="p">][</span>
						<span class="n">candidate</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">name</span>
					<span class="p">]</span>
					<span class="n">insts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">_instructions_map</span><span class="p">[</span>
						<span class="n">portal</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span> <span class="n">portal</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span>
					<span class="p">]</span>
					<span class="n">fbo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">_fbo</span>
					<span class="n">fbo</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
					<span class="n">insts</span><span class="p">[</span><span class="s2">&quot;color0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rgba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">bg_color_selected</span>
					<span class="n">insts</span><span class="p">[</span><span class="s2">&quot;color1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rgba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">fg_color_selected</span>
					<span class="n">fbo</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">()</span>
					<span class="n">fbo</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">ask_update</span><span class="p">()</span>
				<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="s2">&quot;selected&quot;</span><span class="p">):</span>
					<span class="n">candidate</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;selected&quot;</span><span class="p">)</span>
					<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="o">!=</span> <span class="n">candidate</span>
				<span class="p">):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="n">GraphArrow</span><span class="p">):</span>
					<span class="n">unsel_graph_arrow</span><span class="p">()</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">candidate</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">keep_selection</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">break</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_selection</span><span class="p">:</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: deselecting &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">))</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;selected&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="n">GraphArrow</span><span class="p">):</span>
				<span class="n">unsel_graph_arrow</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">keep_selection</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">ungrab</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="n">touch</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
		<span class="k">return</span></div>


	<span class="k">def</span> <span class="nf">_pull_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallpaper</span><span class="o">.</span><span class="n">texture</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pull_size</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallpaper</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallpaper</span><span class="o">.</span><span class="n">texture</span><span class="o">.</span><span class="n">size</span>

	<span class="k">def</span> <span class="nf">_pull_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">wallpaper</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_pull_size</span><span class="p">()</span>

<div class="viewcode-block" id="GraphBoard.on_parent">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.on_parent">[docs]</a>
	<span class="k">def</span> <span class="nf">on_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Create some subwidgets and trigger the first update.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_parented&quot;</span><span class="p">):</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span><span class="p">:</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Board: waiting for wallpaper_path&quot;</span><span class="p">)</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_parented</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">wallpaper</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">wallpaper_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pull_image</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_pull_size</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutback</span> <span class="o">=</span> <span class="n">KvLayoutBack</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">widkwargs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span> <span class="o">=</span> <span class="n">ArrowPlane</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">widkwargs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span> <span class="o">=</span> <span class="n">TextureStackPlane</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">widkwargs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutfront</span> <span class="o">=</span> <span class="n">KvLayoutFront</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">widkwargs</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">wid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wids</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">wid</span><span class="p">)</span>
			<span class="n">wid</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
			<span class="n">wid</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
			<span class="k">if</span> <span class="n">wid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallpaper</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">wid</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>


	<span class="k">def</span> <span class="nf">on_character</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_character</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
			<span class="s2">&quot;wallpaper&quot;</span><span class="p">,</span> <span class="s2">&quot;wallpape.jpg&quot;</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="s2">&quot;_control&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">stat</span>
			<span class="ow">or</span> <span class="s2">&quot;wallpaper&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;_control&quot;</span><span class="p">]</span>
		<span class="p">):</span>
			<span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_control&quot;</span><span class="p">,</span> <span class="p">{})</span>
			<span class="n">control</span><span class="p">[</span><span class="s2">&quot;wallpaper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;textinput&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
			<span class="s2">&quot;wallpaper&quot;</span><span class="p">,</span> <span class="s2">&quot;wallpape.jpg&quot;</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">trigger_update</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">update_from_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;wallpaper&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span> <span class="o">=</span> <span class="n">v</span>

	<span class="k">def</span> <span class="nf">_trigger_pull_wallpaper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;wallpaper&quot;</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_scheduled_pull_wallpaper&quot;</span><span class="p">):</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_pull_wallpaper</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_pull_wallpaper</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pull_wallpaper</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">)</span>

	<span class="nd">@trigger</span>
	<span class="k">def</span> <span class="nf">kv_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">wallpaper_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutback</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;wallpaper_path&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">wid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wids</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">remove_widget</span><span class="p">(</span><span class="n">wid</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutback</span> <span class="o">=</span> <span class="n">KvLayoutBack</span><span class="p">(</span>
			<span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">wallpaper_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wallpaper_path</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">wallpaper_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutback</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;wallpaper_path&quot;</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutfront</span> <span class="o">=</span> <span class="n">KvLayoutFront</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">widkwargs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutback</span><span class="o">.</span><span class="n">size</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kvlayoutback</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">wid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wids</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">wid</span><span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.make_pawn">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.make_pawn">[docs]</a>
	<span class="k">def</span> <span class="nf">make_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Make a :class:`Pawn` to represent a :class:`Thing`, store it, and</span>
<span class="sd">		return a dict suitable for `StackPlane.add_datum`</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">thing</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Already have a Pawn for this Thing&quot;</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn_cls</span><span class="p">(</span><span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">thing</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">thing</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span>
		<span class="n">locspot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">thing</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]]</span>
		<span class="k">if</span> <span class="s2">&quot;_image_paths&quot;</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
			<span class="n">texs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thing</span><span class="p">[</span><span class="s2">&quot;_image_paths&quot;</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">texs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Pawn</span><span class="o">.</span><span class="n">default_image_paths</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">tex</span> <span class="ow">in</span> <span class="n">texs</span><span class="p">:</span>
			<span class="n">wide</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">tex</span><span class="p">)</span><span class="o">.</span><span class="n">texture_size</span>
			<span class="k">if</span> <span class="n">wide</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
				<span class="n">width</span> <span class="o">=</span> <span class="n">wide</span>
			<span class="k">if</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
				<span class="n">height</span> <span class="o">=</span> <span class="n">high</span>
		<span class="k">return</span> <span class="p">{</span>  <span class="c1"># need to lay out multiple pawns per spot properly</span>
			<span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">locspot</span><span class="o">.</span><span class="n">right</span><span class="p">),</span>
			<span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">locspot</span><span class="o">.</span><span class="n">top</span><span class="p">),</span>
			<span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
			<span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
			<span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">thing</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
			<span class="s2">&quot;textures&quot;</span><span class="p">:</span> <span class="n">texs</span><span class="p">,</span>
		<span class="p">}</span></div>


<div class="viewcode-block" id="GraphBoard.make_spot">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.make_spot">[docs]</a>
	<span class="k">def</span> <span class="nf">make_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Make a :class:`Spot` to represent a :class:`Place`, store it, and</span>
<span class="sd">		return a dict suitable for `StackPlane.add_datum`</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">place</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Already have a Spot for this Place&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">place</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_cls</span><span class="p">(</span><span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;_image_paths&quot;</span> <span class="ow">in</span> <span class="n">place</span><span class="p">:</span>
			<span class="n">texs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">place</span><span class="p">[</span><span class="s2">&quot;_image_paths&quot;</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">texs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">GraphSpot</span><span class="o">.</span><span class="n">default_image_paths</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">tex</span> <span class="ow">in</span> <span class="n">texs</span><span class="p">:</span>
			<span class="n">wide</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">tex</span><span class="p">)</span><span class="o">.</span><span class="n">texture_size</span>
			<span class="k">if</span> <span class="n">wide</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
				<span class="n">width</span> <span class="o">=</span> <span class="n">wide</span>
			<span class="k">if</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
				<span class="n">height</span> <span class="o">=</span> <span class="n">high</span>
		<span class="k">return</span> <span class="p">{</span>
			<span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">place</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
			<span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">place</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_y&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
			<span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
			<span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
			<span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">place</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
			<span class="s2">&quot;textures&quot;</span><span class="p">:</span> <span class="n">texs</span><span class="p">,</span>
		<span class="p">}</span></div>


	<span class="k">def</span> <span class="nf">make_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portal</span><span class="p">):</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="n">portal</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span>
			<span class="ow">or</span> <span class="n">portal</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span>
		<span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
				<span class="s2">&quot;An :class:`Arrow` should only be made after &quot;</span>
				<span class="s2">&quot;the :class:`Spot`s it connects&quot;</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="n">portal</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span>
			<span class="ow">and</span> <span class="n">portal</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">portal</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]]</span>
		<span class="p">):</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Already have an Arrow for this Portal&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_core_make_arrow</span><span class="p">(</span>
			<span class="n">portal</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">portal</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]],</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">portal</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]],</span>
		<span class="p">)</span>

	<span class="k">def</span> <span class="nf">_core_make_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portal</span><span class="p">,</span> <span class="n">origspot</span><span class="p">,</span> <span class="n">destspot</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
			<span class="s2">&quot;portal&quot;</span><span class="p">:</span> <span class="n">portal</span><span class="p">,</span>
			<span class="s2">&quot;origspot&quot;</span><span class="p">:</span> <span class="n">origspot</span><span class="p">,</span>
			<span class="s2">&quot;destspot&quot;</span><span class="p">:</span> <span class="n">destspot</span><span class="p">,</span>
			<span class="s2">&quot;label_kwargs&quot;</span><span class="p">:</span> <span class="n">get_label_kwargs_from_portal</span><span class="p">(</span><span class="n">portal</span><span class="p">),</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">r</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>
		<span class="k">return</span> <span class="n">r</span>

	<span class="k">def</span> <span class="nf">rm_arrows_to_and_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_arrow</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">orig</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_arrow</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.rm_pawn">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.rm_pawn">[docs]</a>
	<span class="k">def</span> <span class="nf">rm_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Remove the :class:`Pawn` by the given name.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No Pawn named </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="c1"># Currently there&#39;s no way to connect Pawns with Arrows but I</span>
		<span class="c1"># think there will be, so, insurance</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rm_arrows_to_and_from</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">pwn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">pwn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


	<span class="k">def</span> <span class="nf">_trigger_rm_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_pawn</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.rm_spot">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.rm_spot">[docs]</a>
	<span class="k">def</span> <span class="nf">rm_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Remove the :class:`Spot` by the given name.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No Spot named </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="n">spot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">spot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
		<span class="n">pawns_here</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">spot</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">contents</span><span class="p">():</span>
			<span class="n">pawns_here</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rm_arrows_to_and_from</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">pawn</span> <span class="ow">in</span> <span class="n">pawns_here</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rm_pawn</span><span class="p">(</span><span class="n">pawn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_spot</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_spot</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


	<span class="k">def</span> <span class="nf">_trigger_rm_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="n">part</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_spot</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_spot</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_spot</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_spot</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.rm_arrow">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.rm_arrow">[docs]</a>
	<span class="k">def</span> <span class="nf">rm_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Remove the :class:`Arrow` that goes from ``orig`` to ``dest``.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">orig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span> <span class="ow">or</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No Arrow from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
		<span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">arr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">selection_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_arrow</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">]</span></div>


	<span class="k">def</span> <span class="nf">_trigger_rm_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
		<span class="n">part</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rm_arrow</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_arrow</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_rm_arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">graph_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
		<span class="kn">from</span> <span class="nn">networkx.drawing.layout</span> <span class="kn">import</span> <span class="n">spring_layout</span>

		<span class="k">return</span> <span class="n">normalize_layout</span><span class="p">(</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">discard_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thingn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">thingn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rm_pawn</span><span class="p">(</span><span class="n">thingn</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">thingn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_discard_pawn</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_discard_pawn</span><span class="p">[</span><span class="n">thingn</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">_trigger_discard_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
		<span class="n">part</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discard_pawn</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_discard_pawn</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_discard_pawn</span><span class="p">[</span><span class="n">thing</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_discard_pawn</span><span class="p">[</span><span class="n">thing</span><span class="p">]</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">remove_absent_pawns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="s2">&quot;Board: removing pawns absent from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">pawn_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="k">if</span> <span class="n">pawn_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">thing</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_pawn</span><span class="p">(</span><span class="n">pawn_name</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">discard_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placen</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">placen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rm_spot</span><span class="p">(</span><span class="n">placen</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_trigger_discard_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">):</span>
		<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discard_spot</span><span class="p">,</span> <span class="n">place</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">remove_absent_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="s2">&quot;Board: removing spots absent from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">spot_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="k">if</span> <span class="n">spot_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">place</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_spot</span><span class="p">(</span><span class="n">spot_name</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">discard_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orign</span><span class="p">,</span> <span class="n">destn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">orign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span> <span class="ow">and</span> <span class="n">destn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orign</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rm_arrow</span><span class="p">(</span><span class="n">orign</span><span class="p">,</span> <span class="n">destn</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_trigger_discard_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
		<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discard_arrow</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">remove_absent_arrows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="s2">&quot;Board: removing arrows absent from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">arrow_origin</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="k">for</span> <span class="n">arrow_destination</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">arrow_origin</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="n">arrow_origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span>
					<span class="ow">or</span> <span class="n">arrow_destination</span>
					<span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">arrow_origin</span><span class="p">]</span>
				<span class="p">):</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">rm_arrow</span><span class="p">(</span><span class="n">arrow_origin</span><span class="p">,</span> <span class="n">arrow_destination</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">add_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placen</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">placen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">place</span> <span class="ow">and</span> <span class="n">placen</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
			<span class="n">spotten</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_spot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">place</span><span class="p">[</span><span class="n">placen</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">add_datum</span><span class="p">(</span><span class="n">spotten</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">placen</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span>
				<span class="n">spotten</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
				<span class="n">spotten</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
			<span class="p">)</span>

	<span class="k">def</span> <span class="nf">_trigger_add_spot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placen</span><span class="p">):</span>
		<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_spot</span><span class="p">,</span> <span class="n">placen</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">add_new_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="s2">&quot;Board: adding new spots to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="n">start_ts</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>
		<span class="n">places2add</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">spots_unposd</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">nodes_patch</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">placemap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">place</span>
		<span class="n">spotmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span>
		<span class="n">default_image_paths</span> <span class="o">=</span> <span class="n">GraphSpot</span><span class="o">.</span><span class="n">default_image_paths</span>
		<span class="k">for</span> <span class="n">place_name</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">placemap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">place_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spotmap</span><span class="p">:</span>
				<span class="n">place</span> <span class="o">=</span> <span class="n">placemap</span><span class="p">[</span><span class="n">place_name</span><span class="p">]</span>
				<span class="n">places2add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
		<span class="n">make_spot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_spot</span>
		<span class="n">spots_posd</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">stack_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_stack_index</span>
		<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places2add</span><span class="p">:</span>
			<span class="n">spot</span> <span class="o">=</span> <span class="n">make_spot</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;_x&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">place</span> <span class="ow">or</span> <span class="s2">&quot;_y&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">place</span><span class="p">:</span>
				<span class="n">spots_unposd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">spot</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stack_idx</span><span class="p">:</span>
				<span class="n">spots_posd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">spots_unposd</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">nodes_patch_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_layout</span><span class="p">(</span><span class="n">spots_unposd</span><span class="p">)</span>
			<span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
				<span class="n">nodes_patch_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx_layout</span><span class="p">(</span><span class="n">spots_unposd</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodes_patch_2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nodes_patch</span><span class="p">:</span>
					<span class="n">nodes_patch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">nodes_patch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
		<span class="k">if</span> <span class="n">nodes_patch</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span>
				<span class="n">command</span><span class="o">=</span><span class="s2">&quot;update_nodes&quot;</span><span class="p">,</span>
				<span class="n">char</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">patch</span><span class="o">=</span><span class="n">nodes_patch</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="n">spots_posd</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">unbind_uid</span><span class="p">(</span>
				<span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_redraw_bind_uid</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spots_posd</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_redraw_bind_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">fbind</span><span class="p">(</span>
				<span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_trigger_redraw</span>
			<span class="p">)</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="sa">f</span><span class="s2">&quot;Board: added new </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> spots in &quot;</span>
			<span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_ts</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
		<span class="p">)</span>

	<span class="k">def</span> <span class="nf">add_arrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orign</span><span class="p">,</span> <span class="n">destn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
			<span class="n">orign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span>
			<span class="ow">and</span> <span class="n">destn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">orign</span><span class="p">]</span>
		<span class="p">):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No portal for arrow </span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orign</span><span class="p">,</span> <span class="n">destn</span><span class="p">))</span>
		<span class="n">portal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span><span class="p">[</span><span class="n">orign</span><span class="p">][</span><span class="n">destn</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">orign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span> <span class="ow">and</span> <span class="n">destn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orign</span><span class="p">]):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">add_new_portal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_arrow</span><span class="p">(</span><span class="n">portal</span><span class="p">))</span>
			<span class="n">the_arrow</span> <span class="o">=</span> <span class="n">GraphArrow</span><span class="p">(</span>
				<span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
				<span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">orign</span><span class="p">],</span>
				<span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">destn</span><span class="p">],</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">orign</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orign</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orign</span><span class="p">][</span><span class="n">destn</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_arrow</span>
			<span class="k">if</span> <span class="n">destn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span><span class="n">destn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span><span class="p">[</span><span class="n">destn</span><span class="p">][</span><span class="n">orign</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_arrow</span>

	<span class="k">def</span> <span class="nf">add_new_arrows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="s2">&quot;Board: adding new arrows to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="n">portmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span>
		<span class="n">arrowmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span>
		<span class="n">pred_arrowmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_arrow</span>
		<span class="n">spotmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span>
		<span class="n">append_to_arrow_plane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span>
		<span class="n">core_make_arrow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_core_make_arrow</span>
		<span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">arrow_orig</span><span class="p">,</span> <span class="n">arrow_dests</span> <span class="ow">in</span> <span class="n">portmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">arrow_dest</span><span class="p">,</span> <span class="n">portal</span> <span class="ow">in</span> <span class="n">arrow_dests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="n">arrow_orig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrowmap</span>
					<span class="ow">or</span> <span class="n">arrow_dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrowmap</span><span class="p">[</span><span class="n">arrow_orig</span><span class="p">]</span>
				<span class="p">):</span>
					<span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
						<span class="p">(</span><span class="n">portal</span><span class="p">,</span> <span class="n">spotmap</span><span class="p">[</span><span class="n">arrow_orig</span><span class="p">],</span> <span class="n">spotmap</span><span class="p">[</span><span class="n">arrow_dest</span><span class="p">])</span>
					<span class="p">)</span>
					<span class="n">the_arr</span> <span class="o">=</span> <span class="n">GraphArrow</span><span class="p">(</span>
						<span class="n">board</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
						<span class="n">origin</span><span class="o">=</span><span class="n">spotmap</span><span class="p">[</span><span class="n">arrow_orig</span><span class="p">],</span>
						<span class="n">destination</span><span class="o">=</span><span class="n">spotmap</span><span class="p">[</span><span class="n">arrow_dest</span><span class="p">],</span>
					<span class="p">)</span>
					<span class="k">if</span> <span class="n">arrow_orig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrowmap</span><span class="p">:</span>
						<span class="n">arrowmap</span><span class="p">[</span><span class="n">arrow_orig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">if</span> <span class="n">arrow_dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arrowmap</span><span class="p">[</span><span class="n">arrow_orig</span><span class="p">]:</span>
						<span class="n">arrowmap</span><span class="p">[</span><span class="n">arrow_orig</span><span class="p">][</span><span class="n">arrow_dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_arr</span>
					<span class="k">if</span> <span class="n">arrow_dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred_arrowmap</span><span class="p">:</span>
						<span class="n">pred_arrowmap</span><span class="p">[</span><span class="n">arrow_dest</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">if</span> <span class="n">arrow_orig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred_arrowmap</span><span class="p">[</span><span class="n">arrow_dest</span><span class="p">]:</span>
						<span class="n">pred_arrowmap</span><span class="p">[</span><span class="n">arrow_dest</span><span class="p">][</span><span class="n">arrow_orig</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_arr</span>
		<span class="n">points</span> <span class="o">=</span> <span class="n">get_points_multi</span><span class="p">(</span>
			<span class="p">(</span><span class="n">origspot</span><span class="p">,</span> <span class="n">destspot</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">portal</span><span class="p">,</span> <span class="n">origspot</span><span class="p">,</span> <span class="n">destspot</span><span class="p">)</span> <span class="ow">in</span> <span class="n">todo</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">portal</span><span class="p">,</span> <span class="n">origspot</span><span class="p">,</span> <span class="n">destspot</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
			<span class="n">append_to_arrow_plane</span><span class="p">(</span>
				<span class="n">core_make_arrow</span><span class="p">(</span>
					<span class="n">portal</span><span class="p">,</span>
					<span class="n">origspot</span><span class="p">,</span>
					<span class="n">destspot</span><span class="p">,</span>
					<span class="n">points</span><span class="p">[</span><span class="n">origspot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">destspot</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
				<span class="p">)</span>
			<span class="p">)</span>

	<span class="k">def</span> <span class="nf">update_arrow_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">portmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">portal</span>
		<span class="n">arrow_plane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span>
		<span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">arrow_plane</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
			<span class="n">portal</span> <span class="o">=</span> <span class="n">portmap</span><span class="p">[</span><span class="n">datum</span><span class="p">[</span><span class="s2">&quot;origspot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">datum</span><span class="p">[</span><span class="s2">&quot;destspot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
			<span class="n">new_kwargs</span> <span class="o">=</span> <span class="n">get_label_kwargs_from_portal</span><span class="p">(</span><span class="n">portal</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">new_kwargs</span> <span class="o">!=</span> <span class="n">datum</span><span class="p">[</span><span class="s2">&quot;label_kwargs&quot;</span><span class="p">]:</span>
				<span class="n">arrow_plane</span><span class="o">.</span><span class="n">update_portal</span><span class="p">(</span>
					<span class="n">datum</span><span class="p">[</span><span class="s2">&quot;origspot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">datum</span><span class="p">[</span><span class="s2">&quot;destspot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_kwargs</span>
				<span class="p">)</span>

	<span class="k">def</span> <span class="nf">add_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thingn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">thingn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">thing</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Thing for pawn: </span><span class="si">{</span><span class="n">thingn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">thingn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already have pawn for Thing: </span><span class="si">{</span><span class="n">thingn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="n">pwn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_pawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">thing</span><span class="p">[</span><span class="n">thingn</span><span class="p">])</span>
		<span class="n">stacp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span>
		<span class="n">stacp</span><span class="o">.</span><span class="n">add_datum</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">thingn</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">pwn</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>

		<span class="k">if</span> <span class="n">thingn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_add_pawn</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_add_pawn</span><span class="p">[</span><span class="n">thingn</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">_trigger_add_pawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thingn</span><span class="p">):</span>
		<span class="n">part</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_pawn</span><span class="p">,</span> <span class="n">thingn</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">thingn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_add_pawn</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">unschedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_add_pawn</span><span class="p">[</span><span class="n">thingn</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_scheduled_add_pawn</span><span class="p">[</span><span class="n">thingn</span><span class="p">]</span> <span class="o">=</span> <span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="nd">@mainthread</span>
	<span class="k">def</span> <span class="nf">add_new_pawns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="s2">&quot;Board: adding new pawns to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="n">nodes_patch</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">things2add</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">pawns_added</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">pawnmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span>
		<span class="k">for</span> <span class="n">thing_name</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">thing_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pawnmap</span><span class="p">:</span>
				<span class="n">things2add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
		<span class="n">make_pawn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_pawn</span>
		<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things2add</span><span class="p">:</span>
			<span class="n">pwn</span> <span class="o">=</span> <span class="n">make_pawn</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
			<span class="k">if</span> <span class="s2">&quot;_image_paths&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
				<span class="n">nodes_patch</span><span class="p">[</span><span class="n">thing</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
					<span class="s2">&quot;_image_paths&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
						<span class="n">pwn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;textures&quot;</span><span class="p">,</span> <span class="n">Pawn</span><span class="o">.</span><span class="n">default_image_paths</span><span class="p">)</span>
					<span class="p">)</span>
				<span class="p">}</span>
			<span class="n">pawns_added</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pwn</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">nodes_patch</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">nodes_patch</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">unbind_uid</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_redraw_bind_uid</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pawns_added</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_redraw_bind_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">fbind</span><span class="p">(</span>
			<span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_trigger_redraw</span>
		<span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.update">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.update">[docs]</a>
	<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Force an update to match the current state of my character.</span>

<span class="sd">		This polls every element of the character, and therefore</span>
<span class="sd">		causes me to sync with the LiSE core for a long time. Avoid</span>
<span class="sd">		when possible.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;closed&quot;</span><span class="p">,</span> <span class="kc">False</span>
		<span class="p">):</span>
			<span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
				<span class="s2">&quot;Board: tried to update without a connection to a LiSE core&quot;</span>
			<span class="p">)</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">trigger_update</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="c1"># remove widgets that don&#39;t represent anything anymore</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;GraphBoard: updating&quot;</span><span class="p">)</span>
		<span class="n">start_ts</span> <span class="o">=</span> <span class="n">monotonic</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">disconnect_proxy_objects</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">remove_absent_pawns</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">remove_absent_spots</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">remove_absent_arrows</span><span class="p">()</span>
		<span class="c1"># add widgets to represent new stuff</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">add_new_spots</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update_spot_display</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_cls</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_new_arrows</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">update_arrow_display</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">add_new_pawns</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">update_pawn_display</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">connect_proxy_objects</span><span class="p">()</span>
		<span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
			<span class="sa">f</span><span class="s2">&quot;GraphBoard: updated, took </span><span class="si">{</span><span class="n">monotonic</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_ts</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
		<span class="p">)</span></div>


	<span class="n">trigger_update</span> <span class="o">=</span> <span class="n">trigger</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">disconnect_proxy_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span>
		<span class="n">char</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_from_character_stat</span><span class="p">)</span>
		<span class="n">char</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_from_character_node</span><span class="p">)</span>
		<span class="n">char</span><span class="o">.</span><span class="n">portal</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_from_character_edge</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">connect_proxy_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span>
		<span class="n">char</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_from_character_stat</span><span class="p">)</span>
		<span class="n">char</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_from_character_node</span><span class="p">)</span>
		<span class="n">char</span><span class="o">.</span><span class="n">portal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_from_character_edge</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">update_from_character_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">character</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">pass</span>

	<span class="nd">@mainthread</span>
	<span class="k">def</span> <span class="nf">update_from_character_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span><span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_pawn</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_pawn</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;location&quot;</span><span class="p">:</span>
				<span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
				<span class="n">thing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
				<span class="n">thing</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">loc</span><span class="o">.</span><span class="n">top</span>
			<span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;_image_paths&quot;</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">elif</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">node</span> <span class="ow">or</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">place</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_spot</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="k">elif</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_spot</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">thing</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_pawn</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="k">elif</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_pawn</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rm_spot</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_spot</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;_image_paths&quot;</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="GraphBoard.update_spot_display">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.update_spot_display">[docs]</a>
	<span class="k">def</span> <span class="nf">update_spot_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Change spot graphics to match the state of their place&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="GraphBoard.update_pawn_display">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.update_pawn_display">[docs]</a>
	<span class="k">def</span> <span class="nf">update_pawn_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Change pawn graphics to match the state of their thing&quot;&quot;&quot;</span></div>


	<span class="k">def</span> <span class="nf">update_from_character_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">edge</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">have_arrow</span><span class="p">(</span>
				<span class="n">edge</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">_destination</span>
			<span class="p">):</span>
				<span class="n">label_kwargs</span> <span class="o">=</span> <span class="n">DEFAULT_ARROW_LABEL_KWARGS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
				<span class="k">if</span> <span class="s2">&quot;_label_stat&quot;</span> <span class="ow">in</span> <span class="n">edge</span><span class="p">:</span>
					<span class="n">label_kwargs</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
						<span class="n">edge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="s2">&quot;label_stat&quot;</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
					<span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">add_new_portal</span><span class="p">(</span>
					<span class="p">{</span>
						<span class="s2">&quot;origspot&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
						<span class="s2">&quot;destspot&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">edge</span><span class="o">.</span><span class="n">destination</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
						<span class="s2">&quot;label_kwargs&quot;</span><span class="p">:</span> <span class="n">label_kwargs</span><span class="p">,</span>
					<span class="p">}</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">edge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_label_stat&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">update_portal_label</span><span class="p">(</span>
					<span class="n">edge</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">_destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
				<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">edge</span><span class="o">.</span><span class="n">_destination</span><span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.update_arrow_display">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.update_arrow_display">[docs]</a>
	<span class="k">def</span> <span class="nf">update_arrow_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Change arrow graphics to match the state of their portal&quot;&quot;&quot;</span></div>


	<span class="k">def</span> <span class="nf">_apply_node_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spot</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span>
				<span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_node_layout</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">spot</span><span class="p">),</span> <span class="mf">0.01</span>
			<span class="p">)</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="n">spot</span> <span class="o">=</span> <span class="p">{</span><span class="n">spt</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">spt</span> <span class="k">for</span> <span class="n">spt</span> <span class="ow">in</span> <span class="n">spot</span><span class="p">}</span>
		<span class="n">node_upd</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">newspots</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has invalid x: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
			<span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has invalid y: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
			<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
			<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">height</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
			<span class="n">node_upd</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;_y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">}</span>
			<span class="n">spot</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
			<span class="n">spot</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
			<span class="n">newspots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spot</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">newspots</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">unbind_uid</span><span class="p">(</span>
				<span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_redraw_bind_uid</span>
			<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">newspots</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_redraw_bind_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">fbind</span><span class="p">(</span>
				<span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">_trigger_redraw</span>
			<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">spots_unposd</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">return</span> <span class="n">node_upd</span>

	<span class="k">def</span> <span class="nf">grid_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spots</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_node_layout</span><span class="p">(</span>
			<span class="n">normalize_layout</span><span class="p">({</span><span class="n">spot</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">spot</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">spots</span><span class="p">}),</span>
			<span class="n">spots</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="k">def</span> <span class="nf">nx_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spots</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="n">spots_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">facade</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spots_only</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="k">del</span> <span class="n">spots_only</span><span class="o">.</span><span class="n">thing</span><span class="p">[</span><span class="n">thing</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">spots_only</span><span class="o">.</span><span class="n">place</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
			<span class="n">spot</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">spots</span>
		<span class="p">):</span>
			<span class="k">del</span> <span class="n">spots_only</span><span class="o">.</span><span class="n">place</span><span class="p">[</span><span class="n">place</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_node_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_layout</span><span class="p">(</span><span class="n">spots_only</span><span class="p">),</span> <span class="n">spots</span><span class="p">)</span>

<div class="viewcode-block" id="GraphBoard.arrows">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.arrows">[docs]</a>
	<span class="k">def</span> <span class="nf">arrows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over all my arrows.&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">for</span> <span class="n">arro</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="k">yield</span> <span class="n">arro</span></div>


<div class="viewcode-block" id="GraphBoard.pawns_at">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.pawns_at">[docs]</a>
	<span class="k">def</span> <span class="nf">pawns_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over pawns that collide the given point.&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">iter_collided_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">pawn</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="GraphBoard.spots_at">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.spots_at">[docs]</a>
	<span class="k">def</span> <span class="nf">spots_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over spots that collide the given point.&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">iter_collided_keys</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="GraphBoard.arrows_at">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoard.arrows_at">[docs]</a>
	<span class="k">def</span> <span class="nf">arrows_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over arrows that collide the given point.&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow_plane</span><span class="o">.</span><span class="n">iter_collided_edges</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrow</span><span class="p">[</span><span class="n">orig</span><span class="p">][</span><span class="n">dest</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="GraphBoardScatterPlane">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoardScatterPlane">[docs]</a>
<span class="k">class</span> <span class="nc">GraphBoardScatterPlane</span><span class="p">(</span><span class="n">BoardScatterPlane</span><span class="p">):</span>
	<span class="n">selection_candidates</span> <span class="o">=</span> <span class="n">ListProperty</span><span class="p">([])</span>
	<span class="n">selection</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">(</span><span class="n">allownone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">keep_selection</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">board</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">adding_portal</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">reciprocal_portal</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">()</span>

<div class="viewcode-block" id="GraphBoardScatterPlane.spot_from_dummy">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoardScatterPlane.spot_from_dummy">[docs]</a>
	<span class="k">def</span> <span class="nf">spot_from_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Make a real place and its spot from a dummy spot.</span>

<span class="sd">		Create a new :class:`graph.Spot` instance, along with the</span>
<span class="sd">		underlying :class:`LiSE.Place` instance, and give it the name,</span>
<span class="sd">		position, and imagery of the provided dummy.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_local</span><span class="p">(</span><span class="o">*</span><span class="n">dummy</span><span class="o">.</span><span class="n">pos_up</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">width</span>
		<span class="n">y</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">height</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">new_place</span><span class="p">(</span>
			<span class="n">dummy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">_y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">_image_paths</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dummy</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="n">dummy</span><span class="o">.</span><span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="GraphBoardScatterPlane.pawn_from_dummy">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoardScatterPlane.pawn_from_dummy">[docs]</a>
	<span class="k">def</span> <span class="nf">pawn_from_dummy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Make a real thing and its pawn from a dummy pawn.</span>

<span class="sd">		Create a new :class:`graph.Pawn` instance, along with the</span>
<span class="sd">		underlying :class:`LiSE.Thing` instance, and give it the name,</span>
<span class="sd">		location, and imagery of the provided dummy.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">dummy_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_local</span><span class="p">(</span><span class="o">*</span><span class="n">dummy</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
		<span class="n">dummy</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_local</span><span class="p">(</span><span class="o">*</span><span class="n">dummy</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">stack_plane</span><span class="o">.</span><span class="n">iter_collided_keys</span><span class="p">(</span><span class="o">*</span><span class="n">dummy_center</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">spot</span><span class="p">:</span>
				<span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">spot</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">whereat</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">candidates</span><span class="p">:</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="o">*</span><span class="n">whereat</span><span class="o">.</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">dummy_center</span><span class="p">)</span>
			<span class="k">while</span> <span class="n">candidates</span><span class="p">:</span>
				<span class="n">thereat</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
				<span class="n">thereto</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="o">*</span><span class="n">thereat</span><span class="o">.</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">dummy_center</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">thereto</span> <span class="o">&lt;</span> <span class="n">dist</span><span class="p">:</span>
					<span class="n">whereat</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">thereat</span><span class="p">,</span> <span class="n">thereto</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">character</span><span class="o">.</span><span class="n">new_thing</span><span class="p">(</span>
			<span class="n">dummy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">whereat</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_image_paths</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dummy</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span>
		<span class="p">)</span>
		<span class="n">dummy</span><span class="o">.</span><span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span></div>


	<span class="k">def</span> <span class="nf">on_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_oldboard&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span>
				<span class="n">adding_portal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldboard</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;adding_portal&quot;</span><span class="p">),</span>
				<span class="n">reciprocal_portal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldboard</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;reciprocal_portal&quot;</span><span class="p">),</span>
			<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">clear_widgets</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">adding_portal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adding_portal</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">reciprocal_portal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_portal</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
			<span class="n">adding_portal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;adding_portal&quot;</span><span class="p">),</span>
			<span class="n">reciprocal_portal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="s2">&quot;reciprocal_portal&quot;</span><span class="p">),</span>
		<span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_oldboard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span></div>



<div class="viewcode-block" id="GraphBoardView">
<a class="viewcode-back" href="../../../ELiDE/index.html#ELiDE.graph.board.GraphBoardView">[docs]</a>
<span class="k">class</span> <span class="nc">GraphBoardView</span><span class="p">(</span><span class="n">BoardView</span><span class="p">):</span>
	<span class="n">adding_portal</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">reciprocal_portal</span> <span class="o">=</span> <span class="n">BooleanProperty</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">engine</span> <span class="o">=</span> <span class="n">ObjectProperty</span><span class="p">()</span>
	<span class="n">character_name</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">on_character_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
			<span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">character_name</span>
			<span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">character_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span>
		<span class="p">):</span>
			<span class="n">Clock</span><span class="o">.</span><span class="n">schedule_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_character_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="n">character</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">character_name</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">GraphBoard</span><span class="p">(</span><span class="n">character</span><span class="o">=</span><span class="n">character</span><span class="p">)</span></div>



<span class="n">Builder</span><span class="o">.</span><span class="n">load_string</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;GraphBoard&gt;:</span>
<span class="s2">	app: app</span>
<span class="s2">	size_hint: None, None</span>
<span class="s2">&lt;GraphBoardView&gt;:</span>
<span class="s2">	plane: boardplane</span>
<span class="s2">	GraphBoardScatterPlane:</span>
<span class="s2">		id: boardplane</span>
<span class="s2">		board: root.board</span>
<span class="s2">		adding_portal: root.adding_portal</span>
<span class="s2">		reciprocal_portal: root.reciprocal_portal</span>
<span class="s2">		scale_min: root.scale_min</span>
<span class="s2">		scale_max: root.scale_max</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">LiSE</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html">engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html#module-LiSE.character">character</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html#module-LiSE.node">node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html#module-LiSE.portal">portal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html#module-LiSE.rule">rule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html#module-LiSE.query">query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LiSE/index.html#module-LiSE.xcollections">xcollections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ELiDE/index.html">ELiDE</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;Zachary Spector.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>