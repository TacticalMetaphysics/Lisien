<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lisien.collections &#8212; Lisien 0.22.4 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=aaf7ef78"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lisien.collections</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of Lisien, a framework for life simulation games.</span>
<span class="c1"># Copyright (c) Zachary Spector, public@zacharyspector.com</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;Common classes for collections in lisien</span>

<span class="sd">Notably includes wrappers for mutable objects, allowing them to be stored in</span>
<span class="sd">the database. These simply store the new value.</span>

<span class="sd">Most of these are subclasses of :class:`blinker.Signal`, so you can listen</span>
<span class="sd">for changes using the ``connect(..)`` method.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">Expr</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">UserDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">blake2b</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getsource</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">astor</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">blinker</span> <span class="kn">import</span> <span class="n">Signal</span>

<span class="kn">from</span> <span class="nn">.types</span> <span class="kn">import</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">Key</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">AbstractEngine</span><span class="p">,</span> <span class="n">dedent_source</span><span class="p">,</span> <span class="n">getatt</span><span class="p">,</span> <span class="n">sort_set</span>
<span class="kn">from</span> <span class="nn">.wrap</span> <span class="kn">import</span> <span class="n">wrapval</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">.character</span> <span class="kn">import</span> <span class="n">Character</span>


<span class="c1"># 0x241d is the group separator</span>
<span class="c1"># 0x241e is the record separator</span>
<span class="c1"># per Unicode 1.1</span>
<span class="n">GROUP_SEP</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x241D</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="n">REC_SEP</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x241E</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">AbstractLanguageDescriptor</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
	<span class="nd">@abstractmethod</span>
	<span class="k">def</span> <span class="nf">_get_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">:</span> <span class="n">StringStore</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="nd">@abstractmethod</span>
	<span class="k">def</span> <span class="nf">_set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">:</span> <span class="n">StringStore</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">StringStore</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_language</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">:</span> <span class="n">StringStore</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_language</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LanguageDescriptor</span><span class="p">(</span><span class="n">AbstractLanguageDescriptor</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">_get_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">:</span> <span class="n">StringStore</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">_current_language</span>

	<span class="k">def</span> <span class="nf">_set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="n">inst</span><span class="o">.</span><span class="n">_current_language</span><span class="p">:</span>
			<span class="n">inst</span><span class="o">.</span><span class="n">_switch_language</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span>
				<span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;_worker&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
				<span class="ow">and</span> <span class="n">inst</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lang</span>
			<span class="p">):</span>
				<span class="n">inst</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">eternal</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span>
			<span class="n">inst</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">=</span> <span class="n">lang</span>


<span class="k">class</span> <span class="nc">TamperEvidentDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
	<span class="n">tampered</span><span class="p">:</span> <span class="nb">bool</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">()):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChangeTrackingDict</span><span class="p">(</span><span class="n">UserDict</span><span class="p">):</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">()):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">apply_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
		<span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

	<span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

	<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

	<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

	<span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<div class="viewcode-block" id="StringStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.StringStore">[docs]</a>
<span class="k">class</span> <span class="nc">StringStore</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
	<span class="n">language</span> <span class="o">=</span> <span class="n">LanguageDescriptor</span><span class="p">()</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">engine_or_string_dict</span><span class="p">:</span> <span class="n">AbstractEngine</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">,</span>
		<span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
		<span class="n">lang</span><span class="o">=</span><span class="s2">&quot;eng&quot;</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">engine_or_string_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">=</span> <span class="n">lang</span>
			<span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">engine_or_string_dict</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
				<span class="n">engine_or_string_dict</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span> <span class="nb">dict</span>
			<span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span> <span class="o">=</span> <span class="n">engine_or_string_dict</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">engine_or_string_dict</span><span class="p">}</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine_or_string_dict</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">TamperEvidentDict</span><span class="p">()}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">=</span> <span class="n">lang</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_switch_language</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_switch_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Write the current language to disk, and load the new one if available&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">return</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">,</span> <span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inf</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">()</span>
		<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span>
		<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">],</span> <span class="s2">&quot;tampered&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
				<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span>
				<span class="s2">&quot;w&quot;</span><span class="p">,</span>
			<span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
				<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">],</span>
					<span class="n">outf</span><span class="p">,</span>
					<span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
					<span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">]</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">])</span>

	<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">])</span>

	<span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

	<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Set the value of a string for the current language.&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Delete the string from the current language, and remove it from the</span>
<span class="sd">		cache.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">lang_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Yield pairs of (id, string) for the given language.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
			<span class="ow">and</span> <span class="n">lang</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
			<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">!=</span> <span class="n">lang</span>
		<span class="p">):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">,</span> <span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inf</span><span class="p">))</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reimport</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">tampered</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
				<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">,</span> <span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span>
				<span class="s2">&quot;w&quot;</span><span class="p">,</span>
			<span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
				<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="n">lang</span><span class="p">],</span>
					<span class="n">outf</span><span class="p">,</span>
					<span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
					<span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="p">)</span>
			<span class="n">d</span><span class="o">.</span><span class="n">tampered</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">reimport</span><span class="p">:</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
				<span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span>
				<span class="s2">&quot;r&quot;</span><span class="p">,</span>
			<span class="p">)</span> <span class="k">as</span> <span class="n">inf</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_languages</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_language</span><span class="p">]</span> <span class="o">=</span> <span class="n">TamperEvidentDict</span><span class="p">(</span>
					<span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inf</span><span class="p">)</span>
				<span class="p">)</span>

	<span class="k">def</span> <span class="nf">blake2b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
		<span class="n">the_hash</span> <span class="o">=</span> <span class="n">blake2b</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">GROUP_SEP</span><span class="p">)</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="n">the_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">REC_SEP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">the_hash</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span></div>



<div class="viewcode-block" id="FunctionStore">
<a class="viewcode-back" href="../../lisien/index.html#lisien.collections.FunctionStore">[docs]</a>
<span class="k">class</span> <span class="nc">FunctionStore</span><span class="p">(</span><span class="n">Signal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A module-like object that lets you alter its code and save your changes.</span>

<span class="sd">	Instantiate it with a path to a file that you want to keep the code in.</span>
<span class="sd">	Assign functions to its attributes, then call its ``save()`` method,</span>
<span class="sd">	and they&#39;ll be unparsed and written to the file.</span>

<span class="sd">	This is a ``Signal``, so you can pass a function to its ``connect`` method,</span>
<span class="sd">	and it will be called when a function is added, changed, or deleted.</span>
<span class="sd">	The keyword arguments will be ``attr``, the name of the function, and ``val``,</span>
<span class="sd">	the function itself.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">initial</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="p">):</span>
		<span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">initial</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_ignores</span><span class="o">=</span><span class="p">[])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span> <span class="o">=</span> <span class="n">initial</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
					<span class="s2">&quot;FunctionStore can only work with pure Python source code&quot;</span>
				<span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">reimport</span><span class="p">()</span>
			<span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">[],</span> <span class="n">type_ignores</span><span class="o">=</span><span class="p">[])</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">initial</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

	<span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span>
		<span class="k">yield from</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span>

	<span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
			<span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No attribute &quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
			<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_set_source</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">getsource</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_set_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">holder</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="n">exec</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">holder</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">holder</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
					<span class="s2">&quot;Function in source has a different name&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">source</span>
				<span class="p">)</span>
			<span class="n">func</span> <span class="o">=</span> <span class="n">holder</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="n">outdented</span> <span class="o">=</span> <span class="n">dedent_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
		<span class="n">expr</span> <span class="o">=</span> <span class="n">Expr</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">outdented</span><span class="p">))</span>
		<span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">k</span>
		<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">expr</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">func</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">v</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
			<span class="n">v</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="vm">__name__</span>
		<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span>

	<span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">name</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reimport</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
			<span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">astor</span><span class="o">.</span><span class="n">code_gen</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="p">,</span> <span class="n">indent_with</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">reimport</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">reimport</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">reimport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="n">path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
		<span class="n">modname</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
			<span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
		<span class="n">modname</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
		<span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
		<span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="o">.</span><span class="n">__loader__</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">):</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
			<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">iterplain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">astor</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">indent_with</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">store_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_need_save</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="n">outdented</span> <span class="o">=</span> <span class="n">dedent_source</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
		<span class="n">mod</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">outdented</span><span class="p">)</span>
		<span class="n">expr</span> <span class="o">=</span> <span class="n">Expr</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tried to store more than one function&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">expr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">expr</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
		<span class="n">locl</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">),</span> <span class="p">{},</span> <span class="n">locl</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_locl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">locl</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">locl</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;truth&quot;</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;def truth(*args):</span><span class="se">\n\t</span><span class="s2">return True&quot;</span>
		<span class="k">return</span> <span class="n">astor</span><span class="o">.</span><span class="n">dump_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span>

	<span class="k">def</span> <span class="nf">blake2b</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the blake2b hash digest of the code stored here&quot;&quot;&quot;</span>
		<span class="n">hashed</span> <span class="o">=</span> <span class="n">blake2b</span><span class="p">()</span>
		<span class="n">todo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast_idx</span><span class="p">)</span>
		<span class="n">stripped_ast</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ast</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
		<span class="n">astor</span><span class="o">.</span><span class="n">strip_tree</span><span class="p">(</span><span class="n">stripped_ast</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sort_set</span><span class="p">(</span><span class="n">todo</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
			<span class="n">hashed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
			<span class="n">hashed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">GROUP_SEP</span><span class="p">)</span>
			<span class="n">hashed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
				<span class="n">astor</span><span class="o">.</span><span class="n">code_gen</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span>
					<span class="n">stripped_ast</span><span class="p">[</span><span class="n">todo</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">indent_with</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
				<span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
			<span class="p">)</span>
			<span class="n">hashed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">REC_SEP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hashed</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">truth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="k">return</span> <span class="kc">True</span></div>



<span class="k">class</span> <span class="nc">UniversalMapping</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Mapping for variables that are global but which I keep history for&quot;&quot;&quot;</span>

	<span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">]</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Store the engine and initialize my private dictionary of</span>
<span class="sd">		listeners.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">())</span>

	<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">count_keys</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">())</span>

	<span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Get the current value of this key&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="n">wrapval</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span>
			<span class="n">k</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_cache_now</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
		<span class="p">)</span>

	<span class="k">def</span> <span class="nf">_get_cache_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">())</span>

	<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Set k=v at the current branch and tick&quot;&quot;&quot;</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_nbtt</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">universal_set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_set_cache_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Unset this key for the present (branch, tick)&quot;&quot;&quot;</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_nbtt</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_universal_cache</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">universal_del</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=...</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CharacterMapping</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;A mapping by which to access :class:`Character` objects.</span>

<span class="sd">	If a character already exists, you can always get its name here to</span>
<span class="sd">	get the :class:`Character` object. Deleting an item here will</span>
<span class="sd">	delete the character from the world, even if there are still</span>
<span class="sd">	:class:`Character` objects referring to it; those won&#39;t do</span>
<span class="sd">	anything useful anymore.</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">engine</span> <span class="o">=</span> <span class="n">getatt</span><span class="p">(</span><span class="s2">&quot;orm&quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orm</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">orm</span> <span class="o">=</span> <span class="n">orm</span>
		<span class="n">Signal</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">count_keys</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_btt</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_cache</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">turn</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
				<span class="o">==</span> <span class="s2">&quot;DiGraph&quot;</span>
			<span class="p">)</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>

	<span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Key</span> <span class="o">|</span> <span class="n">CharName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Character&quot;</span><span class="p">:</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Return the named character, if it&#39;s been created.</span>

<span class="sd">		Try to use the cache if possible.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span> <span class="nn">.character</span> <span class="kn">import</span> <span class="n">Character</span>

		<span class="n">name</span> <span class="o">=</span> <span class="n">CharName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No such character&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
		<span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_graph_objs</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
			<span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Character</span><span class="p">(</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">init_rulebooks</span><span class="o">=</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span>
			<span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Character</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;You put something weird in the Character cache&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span>

	<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">CharName</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Make a new character by the given name, and initialize its data to</span>
<span class="sd">		the given value.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_init_graph</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;DiGraph&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">character</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

	<span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">CharName</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">del_character</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompositeDict</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Combine two dictionaries into one&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Store dictionaries&quot;&quot;&quot;</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">d1</span> <span class="o">=</span> <span class="n">d1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">d2</span> <span class="o">=</span> <span class="n">d2</span>

	<span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Iterate over both dictionaries&#39; keys&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">:</span>
			<span class="k">yield</span> <span class="n">k</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">:</span>
			<span class="k">yield</span> <span class="n">k</span>

	<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Sum the lengths of both dictionaries&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span>

	<span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Get an item from ``d1`` if possible, then ``d2``&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

	<span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="n">deleted</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">:</span>
			<span class="n">deleted</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">:</span>
			<span class="n">deleted</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">deleted</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is in neither of my wrapped dicts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;Recursive update&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
				<span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Lisien</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html">engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#module-lisien.character">character</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#module-lisien.node">node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#module-lisien.portal">portal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#module-lisien.rule">rule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#module-lisien.query">query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lisien/index.html#module-lisien.collections">collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elide/index.html">Elide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;Zachary Spector.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>